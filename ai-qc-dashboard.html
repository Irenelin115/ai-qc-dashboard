<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysTalk.Audit儀表板</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* 增強的統計卡片樣式 */
        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(229, 231, 235, 0.8);
        }
        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 4px 16px rgba(0, 0, 0, 0.05);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8, #6366f1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .stat-card:hover::before {
            opacity: 1;
        }
        .tab-button {
            transition: all 0.2s ease;
        }
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        /* 增強的圖表容器 */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(229, 231, 235, 0.6);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }
        .chart-container:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            border-color: rgba(59, 130, 246, 0.2);
        }
        .alert-item {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .loading {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .audio-row {
            transition: all 0.2s ease;
        }
        .audio-row:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .play-button {
            transition: all 0.2s ease;
        }
        .play-button:hover {
            transform: scale(1.1);
        }
        .severity-high {
            border-left: 4px solid #ef4444;
            background-color: #fef2f2;
        }
        .severity-medium {
            border-left: 4px solid #f59e0b;
            background-color: #fffbeb;
        }
        .severity-low {
            border-left: 4px solid #10b981;
            background-color: #f0fdf4;
        }
        
        /* 友善時間選擇器樣式 */
        .time-selector {
            transition: all 0.3s ease;
        }
        
        .time-selector:focus {
            ring: 2px;
            ring-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .quick-time-btn {
            transition: all 0.2s ease;
            animation: fadeIn 0.3s ease-out;
        }
        
        .quick-time-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .quick-time-btn:active {
            transform: translateY(0);
        }
        
        .date-range-display {
            animation: slideIn 0.3s ease-out;
        }
        
        .comparison-toggle {
            transition: all 0.2s ease;
        }
        
        .comparison-toggle:hover {
            background-color: #f3f4f6;
        }
        
        /* 自定義日期模態框樣式 */
        .custom-date-modal {
            backdrop-filter: blur(4px);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .custom-date-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .date-input {
            transition: all 0.2s ease;
        }
        
        .date-input:focus {
            ring: 2px;
            ring-color: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .quick-date-btn {
            transition: all 0.2s ease;
        }
        
        .quick-date-btn:hover {
            background-color: #f9fafb;
            border-color: #6b7280;
            transform: translateY(-1px);
        }
        
        /* 動畫定義 */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* 時間範圍標籤樣式 */
        .time-range-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: badgeGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes badgeGlow {
            from {
                box-shadow: 0 0 5px rgba(102, 126, 234, 0.4);
            }
            to {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
            }
        }
        
        /* Tooltip 樣式 */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937;
            color: #ffffff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 13px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            background-color: #6b7280;
            color: #ffffff;
            border-radius: 50%;
            text-align: center;
            font-size: 10px;
            line-height: 14px;
            margin-left: 4px;
            cursor: help;
        }
        
        .tooltip-icon:hover {
            background-color: #374151;
        }
        
        /* 新增：數據亮點效果 */
        .metric-highlight {
            position: relative;
            display: inline-block;
        }
        .metric-highlight::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 1px;
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { opacity: 0.3; transform: scaleX(0.8); }
            50% { opacity: 1; transform: scaleX(1); }
        }

        /* 新增：改善的按鈕樣式 */
        .enhanced-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            position: relative;
            overflow: hidden;
        }
        .enhanced-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }
        .enhanced-btn:active {
            transform: translateY(0);
        }
        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .enhanced-btn:hover::before {
            left: 100%;
        }

        /* 新增：卡片網格增強 */
        .card-grid {
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        /* 新增：脈動動畫用於即時數據 */
        .pulse-indicator {
            position: relative;
        }
        .pulse-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -12px;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            transform: translateY(-50%);
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 0.4; transform: translateY(-50%) scale(1); }
            50% { opacity: 1; transform: translateY(-50%) scale(1.2); }
        }

        /* 新增：旋轉動畫 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 新增：通知樣式 */
        .notification-enter {
            animation: notificationSlideIn 0.3s ease-out;
        }
        .notification-exit {
            animation: notificationSlideOut 0.3s ease-in;
        }
        @keyframes notificationSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes notificationSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* 新增：載入動畫 */
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* 時間篩選器特殊樣式 */
        .quick-time-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }

        .date-filter-section {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 1px solid rgba(229, 231, 235, 0.8);
            transition: all 0.3s ease;
        }

        .date-filter-section:hover {
            border-color: rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* 日期輸入框增強 */
        .time-selector:focus {
            ring: 2px;
            ring-color: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        /* 篩選結果動畫 */
        .filter-result-enter {
            animation: filterResultSlideIn 0.5s ease-out;
        }

        @keyframes filterResultSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tooltip 樣式 */
        .mode-option {
            position: relative;
        }

        .mode-option:hover .tooltip-integrated,
        .mode-option:hover .tooltip-separate {
            opacity: 1 !important;
            visibility: visible !important;
        }

        .tooltip-integrated,
        .tooltip-separate,
        .tooltip-custom,
        .tooltip-weekly,
        .tooltip-monthly,
        .tooltip-quarterly,
        .tooltip-yearly {
            pointer-events: none;
            transition: all 0.2s ease-in-out;
        }

        .time-range-option:hover .tooltip-custom,
        .time-range-option:hover .tooltip-weekly,
        .time-range-option:hover .tooltip-monthly,
        .time-range-option:hover .tooltip-quarterly,
        .time-range-option:hover .tooltip-yearly {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* 季度下拉選單樣式 */
        .quarter-dropdown-menu {
            min-width: 140px;
            max-height: 200px;
            overflow-y: auto;
            animation: dropdownSlideIn 0.2s ease-out;
        }

        .quarter-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            margin: 2px;
            font-size: 13px;
        }

        .quarter-dropdown-item:hover {
            background-color: #f3f4f6;
            color: #3b82f6;
        }

        .quarter-dropdown-item.current {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            font-weight: 500;
        }

        .quarter-dropdown-item.disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }

        .quarter-dropdown-item.disabled:hover {
            background-color: transparent;
            color: #9ca3af;
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-8px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 季度按鈕特殊狀態 */
        .quarter-btn-active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .time-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .quick-time-buttons {
                justify-content: center;
                gap: 0.25rem;
            }
            
            .quick-time-btn {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
            
            .tooltip .tooltip-text {
                width: 240px;
                margin-left: -120px;
                font-size: 12px;
            }

            .stat-card {
                margin-bottom: 16px;
            }

            .chart-container {
                height: 300px;
                padding: 12px;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-900">SysTalk.Audit儀表板</h1>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600 pulse-indicator" id="lastUpdate">最後更新: 2025/10/17 14:30</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="refreshData()" class="enhanced-btn" title="重新載入數據">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                            更新
                        </button>
                        <button onclick="exportReport()" class="enhanced-btn">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            匯出報表
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-6">
            <nav class="flex space-x-8">
                <button onclick="setActiveTab('overview')" 
                        class="tab-button py-4 px-2 border-b-2 font-medium text-sm transition border-blue-600 text-blue-600" 
                        id="tab-overview">
                    總覽
                </button>
                <button onclick="setActiveTab('analysis')" 
                        class="tab-button py-4 px-2 border-b-2 font-medium text-sm transition border-transparent text-gray-600 hover:text-gray-900" 
                        id="tab-analysis">
                    綜合分析
                </button>
                <button onclick="setActiveTab('agents')" 
                        class="tab-button py-4 px-2 border-b-2 font-medium text-sm transition border-transparent text-gray-600 hover:text-gray-900" 
                        id="tab-agents">
                    客服績效
                </button>
                <button onclick="setActiveTab('tags')" 
                        class="tab-button py-4 px-2 border-b-2 font-medium text-sm transition border-transparent text-gray-600 hover:text-gray-900" 
                        id="tab-tags">
                    語音標籤
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-6">
        <!-- Overview Tab -->
        <div id="overview-content" class="space-y-6">
            <!-- Filter Section -->
            <div class="date-filter-section rounded-lg shadow p-6">
                <!-- Section Header -->
                <div class="filter-section-header mb-8 pb-6 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                            <i data-lucide="filter" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">查詢篩選條件</h2>
                            <p class="text-sm text-gray-600 mt-1">設定時間範圍、業務資料夾與顯示模式</p>
                        </div>
                    </div>
                </div>
                
                <!-- Folder Filter Section -->
                <div class="folder-filter-section mt-0 pt-0">
                    <div class="filter-header flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">業務資料夾篩選</h3>
                    </div>

                    <div class="filter-controls flex gap-4 mb-4 flex-wrap items-center">
                        <div class="quick-actions flex gap-2">
                            <button onclick="selectAllFolders()" class="quick-btn px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 transition">全選</button>
                            <button onclick="invertFolderSelection()" class="quick-btn px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 transition">反選</button>
                            <button onclick="clearFolderSelection()" class="quick-btn px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 transition">清除</button>
                        </div>
                        <div class="scoring-filter">
                            <select id="scoringMethodFilter" onchange="filterFoldersByScoring()" class="scoring-select border border-gray-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="all">所有算分方式</option>
                                <option value="weight">僅權重算分</option>
                                <option value="average">僅平均算分</option>
                                <option value="sum">僅加總算分</option>
                            </select>
                        </div>
                    </div>

                    <div class="folder-list grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4" id="folderList">
                        <div class="folder-item border border-gray-300 rounded p-3 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition selected" data-scoring="weight" onclick="toggleFolderSelection(this)">
                            <div class="folder-checkbox flex items-start gap-3">
                                <input type="checkbox" class="folder-checkbox-input mt-1 accent-blue-600" checked>
                                <div class="folder-info flex-1">
                                    <div class="folder-name font-medium text-gray-900">意外險</div>
                                    <div class="folder-meta flex justify-between items-center text-xs text-gray-600 mt-1">
                                        <span>1,247 筆音檔</span>
                                        <span class="scoring-method bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs">權重</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="folder-item border border-gray-300 rounded p-3 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition selected" data-scoring="weight" onclick="toggleFolderSelection(this)">
                            <div class="folder-checkbox flex items-start gap-3">
                                <input type="checkbox" class="folder-checkbox-input mt-1 accent-blue-600" checked>
                                <div class="folder-info flex-1">
                                    <div class="folder-name font-medium text-gray-900">汽機車強制險</div>
                                    <div class="folder-meta flex justify-between items-center text-xs text-gray-600 mt-1">
                                        <span>892 筆音檔</span>
                                        <span class="scoring-method bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs">權重</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="folder-item border border-gray-300 rounded p-3 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition" data-scoring="average" onclick="toggleFolderSelection(this)">
                            <div class="folder-checkbox flex items-start gap-3">
                                <input type="checkbox" class="folder-checkbox-input mt-1 accent-blue-600">
                                <div class="folder-info flex-1">
                                    <div class="folder-name font-medium text-gray-900">身故險</div>
                                    <div class="folder-meta flex justify-between items-center text-xs text-gray-600 mt-1">
                                        <span>634 筆音檔</span>
                                        <span class="scoring-method bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">平均</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="folder-item border border-gray-300 rounded p-3 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition selected" data-scoring="weight" onclick="toggleFolderSelection(this)">
                            <div class="folder-checkbox flex items-start gap-3">
                                <input type="checkbox" class="folder-checkbox-input mt-1 accent-blue-600" checked>
                                <div class="folder-info flex-1">
                                    <div class="folder-name font-medium text-gray-900">醫療險</div>
                                    <div class="folder-meta flex justify-between items-center text-xs text-gray-600 mt-1">
                                        <span>1,589 筆音檔</span>
                                        <span class="scoring-method bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs">權重</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="folder-item border border-gray-300 rounded p-3 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition" data-scoring="sum" onclick="toggleFolderSelection(this)">
                            <div class="folder-checkbox flex items-start gap-3">
                                <input type="checkbox" class="folder-checkbox-input mt-1 accent-blue-600">
                                <div class="folder-info flex-1">
                                    <div class="folder-name font-medium text-gray-900">旅遊險</div>
                                    <div class="folder-meta flex justify-between items-center text-xs text-gray-600 mt-1">
                                        <span>423 筆音檔</span>
                                        <span class="scoring-method bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs">加總</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="folder-item border border-gray-300 rounded p-3 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition" data-scoring="average" onclick="toggleFolderSelection(this)">
                            <div class="folder-checkbox flex items-start gap-3">
                                <input type="checkbox" class="folder-checkbox-input mt-1 accent-blue-600">
                                <div class="folder-info flex-1">
                                    <div class="folder-name font-medium text-gray-900">壽險</div>
                                    <div class="folder-meta flex justify-between items-center text-xs text-gray-600 mt-1">
                                        <span>756 筆音檔</span>
                                        <span class="scoring-method bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">平均</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Display Mode Section -->
                    <div class="display-mode-section mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-base font-medium text-gray-900 mb-3">顯示模式</h4>
                        <div class="mode-options flex gap-4">
                            <label class="mode-option flex items-center gap-2 px-4 py-2 border border-gray-300 rounded cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition active" onclick="setDisplayMode('integrated')">
                                <input type="radio" name="display-mode" value="integrated" class="accent-blue-600" checked>
                                <span class="text-sm">整合顯示</span>
                                <div class="relative ml-1">
                                    <i data-lucide="help-circle" class="w-3.5 h-3.5 text-gray-400 hover:text-blue-500 transition-colors cursor-help"></i>
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50 tooltip-integrated">
                                        將所有選中資料夾的數據合併顯示，適合查看整體趨勢
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                </div>
                            </label>
                            <label class="mode-option flex items-center gap-2 px-4 py-2 border border-gray-300 rounded cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition" onclick="setDisplayMode('separate')">
                                <input type="radio" name="display-mode" value="separate" class="accent-blue-600">
                                <span class="text-sm">分別顯示</span>
                                <div class="relative ml-1">
                                    <i data-lucide="help-circle" class="w-3.5 h-3.5 text-gray-400 hover:text-blue-500 transition-colors cursor-help"></i>
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-50 tooltip-separate">
                                        為每個資料夾獨立顯示報表，適合比較各資料夾差異
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Info Alert -->
                    <div id="folderInfoAlert" class="info-alert mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 flex items-center gap-2">
                        <span>ℹ️</span>
                        <span id="folderInfoText">整合顯示包含 3 個資料夾的數據</span>
                    </div>

                    <!-- Selected Summary -->
                    <div class="selected-summary-section mt-6">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="database" class="w-4 h-4 text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-blue-900">篩選摘要</p>
                                        <p class="text-xs text-blue-700" id="selectedFolderInfo">已選擇 3 個資料夾，共 3,728 筆音檔</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-xs text-blue-700 font-medium">準備就緒</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Time Filter Section -->
                <div class="time-filter-subsection mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">時間範圍篩選</h3>
                    
                    <!-- Time Range Options -->
                    <div class="mb-6">
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                            <!-- 自選 -->
                            <div class="time-range-option relative">
                                <button onclick="setFilterTab('custom')" 
                                        id="tab-custom"
                                        class="filter-tab w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg border border-blue-500 bg-blue-600 text-white shadow-sm transition-all hover:shadow-md">
                                    <span>自選日期</span>
                                    <div class="relative ml-2">
                                        <i data-lucide="help-circle" class="w-3.5 h-3.5 text-blue-200 hover:text-white transition-colors cursor-help"></i>
                                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible hover:opacity-100 hover:visible transition-all duration-200 whitespace-nowrap z-50 tooltip-custom">
                                            自由選擇開始和結束日期，最多支援五年範圍
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- 週期 -->
                            <div class="time-range-option relative">
                                <button onclick="setFilterTab('weekly')" 
                                        id="tab-weekly"
                                        class="filter-tab w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 bg-white text-gray-700 shadow-sm transition-all hover:border-blue-400 hover:bg-blue-50">
                                    <span>週期選擇</span>
                                    <div class="relative ml-2">
                                        <i data-lucide="help-circle" class="w-3.5 h-3.5 text-gray-400 hover:text-blue-500 transition-colors cursor-help"></i>
                                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible hover:opacity-100 hover:visible transition-all duration-200 whitespace-nowrap z-50 tooltip-weekly">
                                            快速選擇本週、上週或指定週期範圍
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- 月份 -->
                            <div class="time-range-option relative">
                                <button onclick="setFilterTab('monthly')" 
                                        id="tab-monthly"
                                        class="filter-tab w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 bg-white text-gray-700 shadow-sm transition-all hover:border-blue-400 hover:bg-blue-50">
                                    <span>月份選擇</span>
                                    <div class="relative ml-2">
                                        <i data-lucide="help-circle" class="w-3.5 h-3.5 text-gray-400 hover:text-blue-500 transition-colors cursor-help"></i>
                                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible hover:opacity-100 hover:visible transition-all duration-200 whitespace-nowrap z-50 tooltip-monthly">
                                            按年份和月份快速篩選資料範圍
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- 季度 -->
                            <div class="time-range-option relative">
                                <button onclick="setFilterTab('quarterly')" 
                                        id="tab-quarterly"
                                        class="filter-tab w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 bg-white text-gray-700 shadow-sm transition-all hover:border-blue-400 hover:bg-blue-50">
                                    <span>季度選擇</span>
                                    <div class="relative ml-2">
                                        <i data-lucide="help-circle" class="w-3.5 h-3.5 text-gray-400 hover:text-blue-500 transition-colors cursor-help"></i>
                                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible hover:opacity-100 hover:visible transition-all duration-200 whitespace-nowrap z-50 tooltip-quarterly">
                                            按季度快速篩選，適合季度性分析報告
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- 年度 -->
                            <div class="time-range-option relative">
                                <button onclick="setFilterTab('yearly')" 
                                        id="tab-yearly"
                                        class="filter-tab w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 bg-white text-gray-700 shadow-sm transition-all hover:border-blue-400 hover:bg-blue-50">
                                    <span>年度選擇</span>
                                    <div class="relative ml-2">
                                        <i data-lucide="help-circle" class="w-3.5 h-3.5 text-gray-400 hover:text-blue-500 transition-colors cursor-help"></i>
                                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 invisible hover:opacity-100 hover:visible transition-all duration-200 whitespace-nowrap z-50 tooltip-yearly">
                                            選擇整年度資料，適合年度總結和比較
                                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                <!-- Filter Content -->
                <div id="filter-content">
                    <!-- Custom Date Range (自選) -->
                    <div id="custom-filter" class="filter-content">
                        <div class="mb-4">
                            <!-- 警示訊息 -->
                            <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-400 rounded-r-lg shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i data-lucide="clock" class="w-4 h-4 text-blue-600"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-blue-900 mb-1">時間範圍提醒</p>
                                        <p class="text-xs text-blue-700 leading-relaxed">
                                            為確保查詢效能，自選日期範圍限制為 <span class="font-semibold text-blue-800">最近五年內</span> 的資料
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 flex-wrap">
                                <div class="flex items-center gap-2">
                                    <input type="date" 
                                           id="customStartDate" 
                                           class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           onchange="validateDateRange()">
                                    <span class="text-gray-500 font-medium">~</span>
                                    <input type="date" 
                                           id="customEndDate" 
                                           class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                           onchange="validateDateRange()">
                                </div>
                            </div>
                            <div id="dateValidationMessage" class="mt-2 text-sm hidden"></div>
                        </div>
                    </div>

                    <!-- Other Filter Types (Placeholder) -->
                    <div id="weekly-filter" class="filter-content hidden">
                        <div class="mb-4">
                            <div class="flex items-center gap-3 flex-wrap">
                                <!-- 週期選擇按鈕 -->
                                <button onclick="setWeeklyPeriod('thisWeek')" 
                                        id="weekly-this"
                                        class="weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition-all">
                                    本週
                                </button>
                                <button onclick="setWeeklyPeriod('lastWeek')" 
                                        id="weekly-last"
                                        class="weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    上週
                                </button>
                                <button onclick="setWeeklyPeriod('lastLastWeek')" 
                                        id="weekly-lastlast"
                                        class="weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    上上週
                                </button>
                                <button onclick="applyWeeklyFilter()" 
                                        id="weeklyQueryBtn"
                                        class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    查詢
                                </button>
                            </div>
                            
                            <!-- 日期顯示區域 -->
                            <div id="weeklyDateDisplay" class="mt-4 text-sm text-gray-600">
                                目前顯示：<span id="weeklyDateRange">請選擇週期</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="monthly-filter" class="filter-content hidden">
                        <div class="mb-4">
                            <!-- 年份選擇區域 -->
                            <div class="mb-4 flex items-center justify-center gap-4">
                                <button onclick="changeYear(-1)" 
                                        class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <input type="text" 
                                       id="monthlyYearInput" 
                                       value="2025" 
                                       onchange="validateAndSetYear()" 
                                       onblur="validateAndSetYear()"
                                       class="text-center text-2xl font-semibold text-blue-600 bg-transparent border-none focus:outline-none focus:ring-0 w-20">
                                <button onclick="changeYear(1)" 
                                        class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- 月份選擇區域 -->
                            <div class="grid grid-cols-6 gap-3 mb-4">
                                <!-- 第一行：1-6月 -->
                                <button onclick="setMonthlyPeriod(1)" id="monthly-1" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">1月</button>
                                <button onclick="setMonthlyPeriod(2)" id="monthly-2" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">2月</button>
                                <button onclick="setMonthlyPeriod(3)" id="monthly-3" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">3月</button>
                                <button onclick="setMonthlyPeriod(4)" id="monthly-4" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">4月</button>
                                <button onclick="setMonthlyPeriod(5)" id="monthly-5" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">5月</button>
                                <button onclick="setMonthlyPeriod(6)" id="monthly-6" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">6月</button>
                                <!-- 第二行：7-12月 -->
                                <button onclick="setMonthlyPeriod(7)" id="monthly-7" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">7月</button>
                                <button onclick="setMonthlyPeriod(8)" id="monthly-8" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">8月</button>
                                <button onclick="setMonthlyPeriod(9)" id="monthly-9" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">9月</button>
                                <button onclick="setMonthlyPeriod(10)" id="monthly-10" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">10月</button>
                                <button onclick="setMonthlyPeriod(11)" id="monthly-11" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">11月</button>
                                <button onclick="setMonthlyPeriod(12)" id="monthly-12" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">12月</button>
                            </div>
                            
                            <!-- 查詢按鈕 -->
                            <div class="flex justify-end">
                                <button onclick="applyMonthlyFilter()" 
                                        id="monthlyQueryBtn"
                                        class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    查詢
                                </button>
                            </div>
                            
                            <!-- 日期顯示區域 -->
                            <div id="monthlyDateDisplay" class="mt-4 text-sm text-gray-600">
                                目前顯示：<span id="monthlyDateRange">請選擇月份</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quarterly-filter" class="filter-content hidden">
                        <div class="mb-4">
                            <!-- 年份選擇區域 -->
                            <div class="mb-4 flex items-center gap-3">
                                <label class="text-sm font-medium text-gray-700">選擇年度：</label>
                                <select id="quarterlyYearSelector" onchange="changeQuarterlyYear()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <!-- 年份選項會動態生成 -->
                                </select>
                            </div>
                            
                            <!-- 季度選擇區域 -->
                            <div class="flex items-center gap-3 flex-wrap mb-4">
                                <button onclick="setQuarterlyPeriod(1)" 
                                        id="quarterly-q1"
                                        class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    Q1
                                </button>
                                <button onclick="setQuarterlyPeriod(2)" 
                                        id="quarterly-q2"
                                        class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    Q2
                                </button>
                                <button onclick="setQuarterlyPeriod(3)" 
                                        id="quarterly-q3"
                                        class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    Q3
                                </button>
                                <button onclick="setQuarterlyPeriod(4)" 
                                        id="quarterly-q4"
                                        class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                    Q4
                                </button>
                                <button onclick="applyQuarterlyFilter()" 
                                        id="quarterlyQueryBtn"
                                        class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    查詢
                                </button>
                            </div>
                            
                            <!-- 日期顯示區域 -->
                            <div id="quarterlyDateDisplay" class="mt-4 text-sm text-gray-600">
                                目前顯示：<span id="quarterlyDateRange">請選擇季度</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="yearly-filter" class="filter-content hidden">
                        <div class="mb-4">
                            <!-- 年份選擇區域 -->
                            <div class="mb-4 flex items-center gap-3">
                                <select id="yearlyYearSelector" onchange="setYearlySelection()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <!-- 年份選項會動態生成 -->
                                </select>
                                <button onclick="applyYearlyFilter()" 
                                        id="yearlyQueryBtn"
                                        class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    查詢
                                </button>
                            </div>
                            
                            <!-- 日期顯示區域 -->
                            <div id="yearlyDateDisplay" class="mt-4 text-sm text-gray-600">
                                目前顯示：<span id="yearlyDateRange">請選擇年度</span>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Main Filter Actions -->
                <div class="main-filter-actions mt-6 pt-6 border-t border-gray-200 bg-gray-50 rounded-b-lg -mx-6 -mb-6 px-6 pb-6">
                    <div class="flex flex-col sm:flex-row sm:justify-center gap-4">
                        <button onclick="resetFolderFilters()" class="px-6 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-white hover:border-gray-400 transition-all duration-200 font-medium">
                            <i data-lucide="refresh-ccw" class="w-4 h-4 mr-2 inline"></i>
                            重置篩選
                        </button>
                        <button onclick="applyFolderFilters()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 font-medium shadow-sm">
                            <i data-lucide="bar-chart-3" class="w-4 h-4 mr-2 inline"></i>
                            查看報表
                        </button>
                    </div>
                </div>

            </div>

            <!-- Key Metrics -->
            <div class="card-grid">
                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">質檢通話數</p>
                            <p class="text-3xl font-bold text-gray-900 metric-highlight">700</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-full">
                            <i data-lucide="phone" class="w-8 h-8 text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">質檢覆蓋率</p>
                            <p class="text-3xl font-bold text-gray-900 metric-highlight">98%</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-full">
                            <i data-lucide="award" class="w-8 h-8 text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">平均品質分數</p>
                            <p class="text-3xl font-bold text-gray-900 metric-highlight">88</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-full">
                            <i data-lucide="trending-up" class="w-8 h-8 text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">合格率</p>
                            <p class="text-3xl font-bold text-gray-900 metric-highlight" id="complianceRate">90.6%</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-full">
                            <i data-lucide="check-circle" class="w-8 h-8 text-green-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Quality Score Distribution -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">品質分數分布</h3>
                    <div class="chart-container">
                        <div id="qualityChart" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>

                <!-- Trend Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">品質趨勢 (近7天)</h3>
                    <div class="chart-container">
                        <div id="trendChart" style="width: 100%; height: 100%;"></div>
                    </div>
                    <div class="mt-4 grid grid-cols-4 gap-4 pt-4 border-t">
                        <div>
                            <p class="text-sm text-gray-600">7日平均</p>
                            <p class="text-lg font-bold text-gray-900">85分</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">最高分</p>
                            <p class="text-lg font-bold text-green-600">88分</p>
                            <p class="text-xs text-gray-500">10/17</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">最低分</p>
                            <p class="text-lg font-bold text-orange-600">82分</p>
                            <p class="text-xs text-gray-500">10/11</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">趨勢</p>
                            <p class="text-lg font-bold text-green-600 flex items-center">
                                <i data-lucide="trending-up" class="w-5 h-5 mr-1"></i>
                                改善中
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Urgent Processing Cases Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">急需處理案件趨勢</h3>
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-500">急需處理的音檔數量</span>
                        </div>
                    </div>
                    <div id="urgentCasesChart" style="width: 100%; height: 350px;"></div>
                </div>
                
                <!-- Problem Cases Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">問題案件趨勢</h3>
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="text-gray-500">問題案件的音檔數量</span>
                        </div>
                    </div>
                    <div id="problemCasesChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>

            <!-- Top Issues -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900" id="topIssuesTitle">高頻扣分指標 TOP 5</h3>
                        <p class="text-sm text-gray-500 mt-1">不在本次範圍</p>
                    </div>
                    <div class="flex items-center space-x-2 text-sm time-controls">
                        <!-- 時間選擇器 -->
                        <div class="relative">
                            <select id="overviewTimeRange" onchange="updateOverviewData()" class="time-selector border border-gray-300 rounded px-3 py-1 text-sm pr-8 focus:ring-2 focus:ring-blue-500">
                                <option value="today">今日</option>
                                <option value="yesterday">昨日</option>
                                <option value="last7days">近7天</option>
                                <option value="thisweek" selected>本週</option>
                                <option value="lastweek">上週</option>
                                <option value="last30days">近30天</option>
                                <option value="thismonth">本月</option>
                                <option value="lastmonth">上月</option>
                                <option value="last3months">近3個月</option>
                                <option value="custom">自定義範圍</option>
                            </select>
                        </div>
                        
                        <!-- 快速時間按鈕 -->
                        <div class="flex items-center space-x-1 border-l pl-2 ml-2 quick-time-buttons">
                            <button onclick="setQuickTimeRange('today')" class="quick-time-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition">今日</button>
                            <button onclick="setQuickTimeRange('last7days')" class="quick-time-btn px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition">近7天</button>
                            <button onclick="setQuickTimeRange('thismonth')" class="quick-time-btn px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition">本月</button>
                        </div>
                        
                        <!-- 比較功能 -->
                        <div class="flex items-center space-x-2 border-l pl-2 ml-2">
                            <label class="comparison-toggle flex items-center text-xs px-2 py-1 rounded hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="enableComparison" onchange="toggleComparison()" class="mr-1 rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-600">與上期比較</span>
                            </label>
                        </div>
                        
                        <!-- TOP 數量選擇器 -->
                        <div class="flex items-center space-x-2 border-l pl-2 ml-2">
                            <label class="text-sm font-medium text-gray-700">顯示:</label>
                            <select id="topCount" onchange="updateTopIssuesDisplay()" class="border border-gray-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="5" selected>TOP 5</option>
                                <option value="10">TOP 10</option>
                                <option value="15">TOP 15</option>
                                <option value="20">TOP 20</option>
                                <option value="all">全部顯示</option>
                            </select>
                        </div>
                        
                        <select class="border border-gray-300 rounded px-3 py-1 text-sm">
                            <option>依扣分次數</option>
                            <option>依總扣分數</option>
                            <option>依影響人數</option>
                        </select>
                    </div>
                </div>
                
                <!-- 自定義日期範圍模態框 -->
                <div id="customDateModal" class="custom-date-modal hidden fixed inset-0 bg-black bg-opacity-50 z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="custom-date-content bg-white rounded-lg shadow-xl max-w-md w-full">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900">選擇日期範圍</h3>
                            </div>
                            <div class="px-6 py-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                                        <input type="date" id="startDate" class="date-input w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                                        <input type="date" id="endDate" class="date-input w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">快速選擇</h4>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="setDateRange('last7days')" class="quick-date-btn px-3 py-2 text-xs border border-gray-300 rounded hover:bg-gray-50">近7天</button>
                                        <button onclick="setDateRange('last30days')" class="quick-date-btn px-3 py-2 text-xs border border-gray-300 rounded hover:bg-gray-50">近30天</button>
                                        <button onclick="setDateRange('last90days')" class="quick-date-btn px-3 py-2 text-xs border border-gray-300 rounded hover:bg-gray-50">近90天</button>
                                        <button onclick="setDateRange('thismonth')" class="quick-date-btn px-3 py-2 text-xs border border-gray-300 rounded hover:bg-gray-50">本月</button>
                                        <button onclick="setDateRange('lastmonth')" class="quick-date-btn px-3 py-2 text-xs border border-gray-300 rounded hover:bg-gray-50">上月</button>
                                        <button onclick="setDateRange('thisyear')" class="quick-date-btn px-3 py-2 text-xs border border-gray-300 rounded hover:bg-gray-50">今年</button>
                                    </div>
                                </div>
                            </div>
                            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
                                <button onclick="closeCustomDateModal()" class="px-4 py-2 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition">取消</button>
                                <button onclick="applyCustomDateRange()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">確定</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4" id="topIssuesList">
                    <!-- Issues will be populated by JavaScript -->
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-600 mb-1">今日總扣分次數</p>
                            <p class="text-2xl font-bold text-gray-900">164次</p>
                            <p class="text-xs text-gray-500 mt-1">平均每通: 0.23次</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-600 mb-1">零扣分通話</p>
                            <p class="text-2xl font-bold text-green-600">536通</p>
                            <p class="text-xs text-gray-500 mt-1">占比: 76.6%</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-gray-600 mb-1">主要改善方向</p>
                            <p class="text-sm font-semibold text-gray-900">服務態度培訓</p>
                            <p class="text-xs text-gray-500 mt-1">#1, #5 相關項目</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrated Analysis Tab -->
        <div id="analysis-content" class="space-y-6" style="display: none;">
            <!-- 時間篩選區域 -->
            <div id="analysis-time-filter-container">
                <!-- Time filter will be inserted here -->
            </div>
            
            <!-- 品質分析區域 -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200">
                <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                    <i data-lucide="bar-chart-3" class="w-6 h-6 mr-3 text-blue-600"></i>
                    品質分析
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- 評分項目明細 -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">評分項目明細</h3>
                            <button onclick="generateImprovementPlan()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-purple-700 hover:to-blue-700 transition flex items-center space-x-2">
                                <i data-lucide="brain" class="w-4 h-4"></i>
                                <span>AI生成改善方案</span>
                            </button>
                        </div>
                        <div class="chart-container" style="height: 400px;">
                            <div id="complianceChart" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                    
                    <!-- 不合格排名 -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">不合格排名</h3>
                            <span class="text-xs text-gray-500">按不合格率排序</span>
                        </div>
                        
                        <div class="space-y-3" id="failureRankingList">
                            <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">1</span>
                                    <span class="font-medium text-gray-900">服務態度不佳</span>
                                </div>
                                <span class="text-red-600 font-semibold">23.5%</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="w-6 h-6 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center font-bold">2</span>
                                    <span class="font-medium text-gray-900">語速過快</span>
                                </div>
                                <span class="text-orange-600 font-semibold">18.2%</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="w-6 h-6 bg-yellow-500 text-white text-xs rounded-full flex items-center justify-center font-bold">3</span>
                                    <span class="font-medium text-gray-900">未確認客戶需求</span>
                                </div>
                                <span class="text-yellow-600 font-semibold">15.8%</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="w-6 h-6 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center font-bold">4</span>
                                    <span class="font-medium text-gray-900">專業術語過多</span>
                                </div>
                                <span class="text-blue-600 font-semibold">12.4%</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="w-6 h-6 bg-gray-500 text-white text-xs rounded-full flex items-center justify-center font-bold">5</span>
                                    <span class="font-medium text-gray-900">未進行總結</span>
                                </div>
                                <span class="text-gray-600 font-semibold">9.1%</span>
                            </div>
                        </div>
                        
                        <!-- 改善建議 -->
                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-start space-x-3">
                                <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-yellow-900 mb-2">改善重點</h4>
                                    <div class="space-y-1 text-sm" id="improvementSuggestions">
                                        <div class="text-yellow-800">• 重點關注服務態度訓練</div>
                                        <div class="text-yellow-800">• 建立語速標準化流程</div>
                                        <div class="text-yellow-800">• 強化需求確認技巧</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 情緒分析區域 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i data-lucide="smile" class="w-5 h-5 mr-2 text-green-500"></i>
                            情緒分析
                        </h3>
                        <span class="text-xs text-gray-500">客戶情緒分佈與趨勢統計</span>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 情緒分佈圓餅圖 -->
                        <div>
                            <h4 class="text-md font-medium text-gray-700 mb-3">情緒分佈</h4>
                            <div class="chart-container" style="height: 350px;">
                                <div id="emotionAnalysisChart" style="width: 100%; height: 100%;"></div>
                            </div>
                        </div>
                        
                        <!-- 情緒趨勢圖 -->
                        <div>
                            <h4 class="text-md font-medium text-gray-700 mb-3">情緒趨勢</h4>
                            <div class="chart-container" style="height: 350px;">
                                <div id="emotionTrendChart" style="width: 100%; height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                
                <!-- 改善方案區域 -->
                <div id="improvementPlanSection" class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg shadow p-6 border border-blue-200" style="display: none;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i data-lucide="lightbulb" class="w-5 h-5 mr-2 text-yellow-500"></i>
                            AI智能改善方案
                        </h3>
                        <div class="flex space-x-2">
                            <button onclick="exportImprovementPlan()" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">
                                <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>匯出方案
                            </button>
                            <button onclick="closeImprovementPlan()" class="text-sm bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 transition">
                                <i data-lucide="x" class="w-4 h-4 inline mr-1"></i>關閉
                            </button>
                        </div>
                    </div>
                    
                    <!-- 載入狀態 -->
                    <div id="improvementLoading" class="text-center py-8">
                        <div class="inline-flex items-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600 mr-3"></div>
                            <span class="text-gray-600">AI正在分析品質數據並生成改善方案...</span>
                        </div>
                    </div>
                    
                    <!-- 改善方案內容 -->
                    <div id="improvementContent" style="display: none;">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- 問題分析 -->
                            <div class="bg-white rounded-lg p-5 border border-red-200">
                                <h4 class="font-semibold text-red-700 mb-3 flex items-center">
                                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>問題識別
                                </h4>
                                <div id="problemAnalysis" class="space-y-3 text-sm">
                                    <!-- 問題分析內容將由JavaScript填入 -->
                                </div>
                            </div>
                            
                            <!-- 改善建議 -->
                            <div class="bg-white rounded-lg p-5 border border-green-200">
                                <h4 class="font-semibold text-green-700 mb-3 flex items-center">
                                    <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>改善建議
                                </h4>
                                <div id="improvementSuggestions" class="space-y-3 text-sm">
                                    <!-- 改善建議內容將由JavaScript填入 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 實施計畫 -->
                        <div class="mt-6 bg-white rounded-lg p-5 border border-blue-200">
                            <h4 class="font-semibold text-blue-700 mb-3 flex items-center">
                                <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>30天實施計畫
                            </h4>
                            <div id="implementationPlan" class="space-y-4">
                                <!-- 實施計畫內容將由JavaScript填入 -->
                            </div>
                        </div>
                        
                        <!-- 預期效果 -->
                        <div class="mt-6 bg-white rounded-lg p-5 border border-purple-200">
                            <h4 class="font-semibold text-purple-700 mb-3 flex items-center">
                                <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>預期改善效果
                            </h4>
                            <div id="expectedResults" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- 預期效果內容將由JavaScript填入 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Audio Detail Tab -->
        <div id="audio-detail-content" class="space-y-6" style="display: none;">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <button onclick="backToOverview()" class="flex items-center text-gray-600 hover:text-gray-900 transition">
                            <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                            返回總覽
                        </button>
                        <div class="h-6 w-px bg-gray-300"></div>
                        <h2 class="text-xl font-bold text-gray-900" id="detailPageTitle">音檔明細列表</h2>
                        <span class="px-3 py-1 text-sm rounded-full bg-blue-100 text-blue-800" id="detailIssueCategory"></span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" id="detailTotalCount">總計 0 筆</span>
                        <button onclick="showSeveritySettings()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition mr-2">
                            <i data-lucide="settings" class="w-4 h-4 mr-2 inline"></i>
                            嚴重度設定
                        </button>
                        <button onclick="exportAudioList()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                            <i data-lucide="download" class="w-4 h-4 mr-2 inline"></i>
                            匯出清單
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap items-center gap-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">時間範圍:</label>
                        <select id="timeRange" onchange="onAudioTimeRangeChange()" class="time-selector border border-gray-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="today">今日</option>
                            <option value="yesterday">昨日</option>
                            <option value="last7days">近7天</option>
                            <option value="thisweek">本週</option>
                            <option value="lastweek">上週</option>
                            <option value="last30days">近30天</option>
                            <option value="thismonth">本月</option>
                            <option value="lastmonth">上月</option>
                            <option value="last3months">近3個月</option>
                            <option value="custom">自定義範圍</option>
                        </select>
                        
                        <!-- 顯示選中的日期範圍 -->
                        <span id="selectedDateRange" class="date-range-display text-xs text-white time-range-badge px-2 py-1 rounded"></span>
                        
                        <!-- 快速時間按鈕 -->
                        <div class="flex items-center space-x-1 border-l pl-2 ml-2 quick-time-buttons">
                            <button onclick="setAudioTimeRange('today')" class="quick-time-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition">今天</button>
                            <button onclick="setAudioTimeRange('last7days')" class="quick-time-btn px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition">7天</button>
                            <button onclick="setAudioTimeRange('thismonth')" class="quick-time-btn px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition">本月</button>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">客服人員:</label>
                        <select id="agentFilter" class="border border-gray-300 rounded px-3 py-1 text-sm">
                            <option value="">全部</option>
                            <option value="A001">張小明 (A001)</option>
                            <option value="A002">李美玲 (A002)</option>
                            <option value="A003">王大偉 (A003)</option>
                            <option value="A004">陳小華 (A004)</option>
                            <option value="A005">林志強 (A005)</option>
                        </select>
                    </div>

                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">嚴重程度:</label>
                        <select id="severityFilter" class="border border-gray-300 rounded px-3 py-1 text-sm">
                            <option value="">全部</option>
                            <option value="high">高</option>
                            <option value="medium">中</option>
                            <option value="low">低</option>
                        </select>
                    </div>

                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">搜尋:</label>
                        <input type="text" id="searchInput" placeholder="客戶代號、檔案名稱..." 
                               class="border border-gray-300 rounded px-3 py-1 text-sm w-48">
                    </div>

                    <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i data-lucide="filter" class="w-4 h-4 mr-2 inline"></i>
                        套用篩選
                    </button>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-600 tooltip">高嚴重度
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">
                            <strong>高嚴重度扣分</strong><br>
                            扣分分數 ≥ 8分的音檔數量<br>
                            <em>通常涉及嚴重違規或重要流程缺失</em>
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-red-600" id="highSeverityCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-600 tooltip">中嚴重度
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">
                            <strong>中嚴重度扣分</strong><br>
                            扣分分數 4-7分的音檔數量<br>
                            <em>一般性違規或品質問題</em>
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-orange-600" id="mediumSeverityCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-600 tooltip">低嚴重度
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">
                            <strong>低嚴重度扣分</strong><br>
                            扣分分數 1-3分的音檔數量<br>
                            <em>輕微違規或改善建議</em>
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-green-600" id="lowSeverityCount">0</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-600 tooltip">平均時長
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">
                            <strong>平均通話時長</strong><br>
                            當前篩選範圍內所有音檔的平均通話時間<br>
                            <em>計算：總時長 ÷ 音檔數量</em>
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-blue-600" id="avgDuration">0</div>
                </div>
            </div>

            <!-- Audio List -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">播放</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">檔案資訊</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">通話詳情</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">人員資訊</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">扣分詳情</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="audioTableBody">
                            <!-- Audio rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    顯示 <span id="showingFrom">1</span> 到 <span id="showingTo">20</span> 筆，共 <span id="totalItems">0</span> 筆
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="previousPage()" id="prevBtn" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                        上一頁
                    </button>
                    <div class="flex items-center space-x-1" id="pageNumbers">
                        <!-- Page numbers will be populated by JavaScript -->
                    </div>
                    <button onclick="nextPage()" id="nextBtn" class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                        下一頁
                    </button>
                </div>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="agents-content" class="space-y-6" style="display: none;">
            <!-- 時間篩選區域 -->
            <div id="agents-time-filter-container">
                <!-- Time filter will be inserted here -->
            </div>
            
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <h3 class="text-lg font-semibold text-gray-900 p-6 border-b">客服人員績效排名</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">排名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">平均分數</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">通話數</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">狀態</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="agentsTable">
                            <!-- Agent data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="font-semibold text-gray-900 mb-2">本月之星</h4>
                    <div class="text-2xl font-bold text-blue-600">張小明</div>
                    <p class="text-sm text-gray-600 mt-1">平均分數 92 | 156通電話</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="font-semibold text-gray-900 mb-2">進步最多</h4>
                    <div class="text-2xl font-bold text-green-600">李美玲</div>
                    <p class="text-sm text-gray-600 mt-1">較上月 +5.2分</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="font-semibold text-gray-900 mb-2">需要輔導</h4>
                    <div class="text-2xl font-bold text-orange-600">3人</div>
                    <p class="text-sm text-gray-600 mt-1">分數低於80分</p>
                </div>
            </div>
        </div>

        <!-- Agent Detail Modal -->
        <div id="agentDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="background: white; margin: 30px auto; width: 95%; max-width: 1200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                
                <!-- Modal Header -->
                <div style="background: #F3F4F6; border-bottom: 1px solid #E5E7EB; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 id="modalAgentName" style="margin: 0; font-size: 18px; font-weight: 600; color: #1F2937;">客服詳細分析</h3>
                    </div>
                    <button onclick="closeAgentDetailModal()" style="background: none; border: none; color: #6B7280; font-size: 20px; cursor: pointer; padding: 4px; border-radius: 4px; hover: background-color: #F3F4F6;">×</button>
                </div>

                <!-- Modal Content -->
                <div style="flex: 1; overflow-y: auto; padding: 20px;">
                    
                    <!-- Overall Score Card -->
                    <div style="background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center;">
                        <div style="background: #3B82F6; color: white; border-radius: 8px; padding: 16px; display: inline-block; margin-bottom: 12px;">
                            <div style="font-size: 24px; font-weight: bold;">AI 質檢結果</div>
                            <div id="modalOverallScore" style="font-size: 32px; font-weight: bold; margin-top: 8px;">92</div>
                            <div style="font-size: 14px; opacity: 0.9;">分</div>
                        </div>
                    </div>

                    <!-- Quality Analysis Table -->
                    <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <div style="background: #F9FAFB; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; font-weight: 600; color: #374151;">
                            📋 指標型
                        </div>
                        <div style="padding: 16px;">
                            <div id="modalMetricScores" style="space-y: 12px;">
                                <!-- 動態生成指標型內容 -->
                            </div>
                        </div>
                    </div>

                    <!-- Summary Analysis Table -->
                    <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                        <div style="background: #F9FAFB; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; font-weight: 600; color: #374151;">
                            📊 摘要型
                        </div>
                        <div style="padding: 16px;">
                            <div id="modalSummaryScores">
                                <!-- 動態生成摘要型內容 -->
                            </div>
                        </div>
                    </div>

                    <!-- Call Records Table -->
                    <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden;">
                        <div style="background: #F9FAFB; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; font-weight: 600; color: #374151; display: flex; justify-content: space-between; align-items: center;">
                            <span>📞 質檢記錄明細</span>
                            <button style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">匯出報表</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #F9FAFB;">
                                    <tr>
                                        <th style="padding: 8px 12px; text-align: left; font-size: 12px; color: #6B7280; border-bottom: 1px solid #E5E7EB;">日期</th>
                                        <th style="padding: 8px 12px; text-align: left; font-size: 12px; color: #6B7280; border-bottom: 1px solid #E5E7EB;">時間</th>
                                        <th style="padding: 8px 12px; text-align: left; font-size: 12px; color: #6B7280; border-bottom: 1px solid #E5E7EB;">總分</th>
                                        <th style="padding: 8px 12px; text-align: left; font-size: 12px; color: #6B7280; border-bottom: 1px solid #E5E7EB;">主要問題</th>
                                        <th style="padding: 8px 12px; text-align: left; font-size: 12px; color: #6B7280; border-bottom: 1px solid #E5E7EB;">功能</th>
                                    </tr>
                                </thead>
                                <tbody id="modalCallRecords">
                                    <!-- 動態生成通話記錄 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                
                <!-- Modal Footer -->
                <div style="background: #F9FAFB; border-top: 1px solid #E5E7EB; padding: 12px 24px; text-align: right;">
                    <button onclick="closeAgentDetailModal()" style="background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">關閉</button>
                </div>
            </div>
        </div>

        <!-- Tags Tab -->
        <div id="tags-content" class="space-y-8" style="display: none;">
            
            <!-- 時間篩選區域 -->
            <div id="tags-time-filter-container">
                <!-- Time filter will be inserted here -->
            </div>

            <!-- 區塊二：四個統計指標 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- 命中標籤總數量 -->
                <div class="stat-card rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">命中標籤總數</p>
                            <p class="text-3xl font-bold text-gray-900" id="voiceTotalLabelsHit">110 / 200</p>
                            <p class="text-xs text-gray-500 mt-1">命中數 / 總數</p>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="tag" class="w-6 h-6 text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <!-- 命中意圖總數量 -->
                <div class="stat-card rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">命中意圖總數</p>
                            <p class="text-3xl font-bold text-gray-900" id="voiceTotalIntentsHit">25 / 50</p>
                            <p class="text-xs text-gray-500 mt-1">命中數 / 總數</p>
                        </div>
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="target" class="w-6 h-6 text-green-600"></i>
                        </div>
                    </div>
                </div>

                <!-- 可選分類區塊1 -->
                <div class="stat-card rounded-lg p-6 cursor-pointer" onclick="showVoiceCategorySelector(1)">
                    <div class="flex items-center justify-between">
                        <div class="w-full">
                            <p class="text-sm font-medium text-gray-600">分類標籤統計</p>
                            <div id="voiceCategory1Content">
                                <div class="flex items-center justify-center h-16 text-gray-400">
                                    <i data-lucide="plus" class="w-8 h-8"></i>
                                </div>
                                <p class="text-xs text-gray-500 text-center">點擊選擇分類</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 可選分類區塊2 -->
                <div class="stat-card rounded-lg p-6 cursor-pointer" onclick="showVoiceCategorySelector(2)">
                    <div class="flex items-center justify-between">
                        <div class="w-full">
                            <p class="text-sm font-medium text-gray-600">分類標籤統計</p>
                            <div id="voiceCategory2Content">
                                <div class="flex items-center justify-center h-16 text-gray-400">
                                    <i data-lucide="plus" class="w-8 h-8"></i>
                                </div>
                                <p class="text-xs text-gray-500 text-center">點擊選擇分類</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 區塊三：標籤統計圓餅圖 -->
            <div class="space-y-6">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i data-lucide="pie-chart" class="w-5 h-5 inline mr-2"></i>
                    標籤統計
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="voiceLabelChartsContainer">
                    <!-- 動態生成的圓餅圖將放在這裡 -->
                </div>
            </div>

            <!-- 區塊四：意圖統計長條圖 -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                    <i data-lucide="bar-chart" class="w-5 h-5 inline mr-2"></i>
                    意圖統計
                </h2>
                <div id="voiceIntentChart" style="height: 400px;"></div>
            </div>

            <!-- 區塊五：標籤/意圖交集 Heatmap -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i data-lucide="grid" class="w-5 h-5 inline mr-2"></i>
                        標籤/意圖交集分析
                    </h2>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">顯示模式：</label>
                            <select id="voiceHeatmapMode" onchange="updateVoiceHeatmapMode()" class="custom-select px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="count">絕對數量</option>
                                <option value="percentage">百分比</option>
                            </select>
                        </div>
                        <button onclick="exportVoiceHeatmapData()" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 transition-all">
                            <i data-lucide="download" class="w-4 h-4 mr-2 inline"></i>
                            導出數據
                        </button>
                    </div>
                </div>
                <div id="voiceHeatmapChart" style="height: 500px;"></div>
            </div>

        </div>
    </main>

    <!-- 語音標籤分類選擇Modal -->
    <div id="voiceCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">選擇標籤分類</h3>
                    <div class="space-y-2" id="voiceCategoryOptions">
                        <!-- 分類選項將動態生成 -->
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button onclick="closeVoiceCategoryModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all">
                            取消
                        </button>
                        <button onclick="confirmVoiceCategorySelection()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">
                            確認
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STT Modal -->
    <div id="sttModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">STT 轉錄文本</h3>
                        <button onclick="closeSttModal()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4">
                    <div class="mb-4">
                        <div class="flex items-center space-x-4 text-sm text-gray-600 mb-4">
                            <span>檔案: <span class="font-medium" id="modalFileName"></span></span>
                            <span>時長: <span class="font-medium" id="modalDuration"></span></span>
                            <span>客服: <span class="font-medium" id="modalAgent"></span></span>
                        </div>
                    </div>
                    <div class="prose max-w-none">
                        <div id="modalSttContent" class="whitespace-pre-wrap text-gray-700 leading-relaxed">
                            <!-- STT content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
                    <div class="flex justify-end space-x-3">
                        <button onclick="exportSttText()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                            匯出文本
                        </button>
                        <button onclick="closeSttModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                            關閉
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Severity Settings Modal -->
    <div id="severitySettingsModal" class="custom-date-modal hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="custom-date-content bg-white rounded-lg shadow-xl max-w-lg w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">嚴重度扣分設定</h3>
                        <button onclick="closeSeveritySettings()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4">
                    <div class="space-y-6">
                        <div class="text-sm text-gray-600 mb-4">
                            設定不同嚴重度等級的扣分分數範圍，用於自動分類音檔的嚴重程度。
                        </div>
                        
                        <!-- 高嚴重度設定 -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 mb-3">
                                <div class="w-4 h-4 bg-red-600 rounded-full"></div>
                                <h4 class="font-semibold text-red-900">高嚴重度</h4>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">最低分數</label>
                                    <input type="number" id="highSeverityMin" min="1" max="20" 
                                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-red-500" 
                                           placeholder="8">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">最高分數</label>
                                    <input type="number" id="highSeverityMax" min="1" max="20" 
                                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-red-500" 
                                           placeholder="20">
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-red-700">
                                範例：保密規定違反、未執行身份驗證等嚴重違規
                            </div>
                        </div>

                        <!-- 中嚴重度設定 -->
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 mb-3">
                                <div class="w-4 h-4 bg-orange-600 rounded-full"></div>
                                <h4 class="font-semibold text-orange-900">中嚴重度</h4>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">最低分數</label>
                                    <input type="number" id="mediumSeverityMin" min="1" max="20" 
                                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500" 
                                           placeholder="4">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">最高分數</label>
                                    <input type="number" id="mediumSeverityMax" min="1" max="20" 
                                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500" 
                                           placeholder="7">
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-orange-700">
                                範例：問題未完全解決、專業知識不足等一般違規
                            </div>
                        </div>

                        <!-- 低嚴重度設定 -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 mb-3">
                                <div class="w-4 h-4 bg-green-600 rounded-full"></div>
                                <h4 class="font-semibold text-green-900">低嚴重度</h4>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">最低分數</label>
                                    <input type="number" id="lowSeverityMin" min="1" max="20" 
                                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-green-500" 
                                           placeholder="1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">最高分數</label>
                                    <input type="number" id="lowSeverityMax" min="1" max="20" 
                                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-green-500" 
                                           placeholder="3">
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-green-700">
                                範例：缺少結束語、未使用客戶姓名等輕微問題
                            </div>
                        </div>

                        <!-- 預設選項 -->
                        <div class="border-t pt-4">
                            <h4 class="font-medium text-gray-900 mb-3">快速設定</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="applyPresetSeverity('default')" 
                                        class="px-4 py-2 text-sm border border-gray-300 rounded hover:bg-gray-50 transition">
                                    預設範圍 (1-3, 4-7, 8-20)
                                </button>
                                <button onclick="applyPresetSeverity('strict')" 
                                        class="px-4 py-2 text-sm border border-gray-300 rounded hover:bg-gray-50 transition">
                                    嚴格模式 (1-2, 3-5, 6-20)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-between">
                    <button onclick="resetSeveritySettings()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition">
                        重置為預設
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="closeSeveritySettings()" 
                                class="px-4 py-2 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition">
                            取消
                        </button>
                        <button onclick="applySeveritySettings()" 
                                class="px-4 py-2 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                            套用設定
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 安全初始化 Lucide 圖標的函數
        function safeCreateIcons() {
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    // 檢查是否有 data-lucide 屬性的元素存在
                    const lucideElements = document.querySelectorAll('[data-lucide]');
                    if (lucideElements.length > 0) {
                        console.log('Found', lucideElements.length, 'lucide elements, initializing icons...');
                        safeCreateIcons();
                    } else {
                        console.log('No lucide elements found');
                    }
                } else {
                    console.warn('Lucide library not available');
                }
            } catch (error) {
                console.warn('Lucide icons initialization failed:', error);
            }
        }

        // Initialize Lucide icons
        safeCreateIcons();

        // Global variables
        let activeTab = 'overview';
        let charts = {};
        
        // === 每個Tab的獨立篩選狀態 ===
        let tabFilterStates = {
            'overview': {
                type: 'custom',
                startDate: '',
                endDate: '',
                selectedWeek: '',
                selectedMonth: '',
                selectedQuarter: '',
                selectedYear: ''
            },
            'analysis': {
                type: 'custom',
                startDate: '',
                endDate: '',
                selectedWeek: '',
                selectedMonth: '',
                selectedQuarter: '',
                selectedYear: ''
            },
            'tags': {
                type: 'custom',
                startDate: '',
                endDate: '',
                selectedWeek: '',
                selectedMonth: '',
                selectedQuarter: '',
                selectedYear: ''
            },
            'agents': {
                type: 'custom',
                startDate: '',
                endDate: '',
                selectedWeek: '',
                selectedMonth: '',
                selectedQuarter: '',
                selectedYear: ''
            }
        };
        
        // 保持向後兼容的全域狀態（指向當前Tab的狀態）
        let currentFilterState = tabFilterStates.overview;

        // Data
        const qualityScoreData = [
            { name: '90-100分', value: 245, percent: 35 },
            { name: '80-89分', value: 315, percent: 45 },
            { name: '70-79分', value: 105, percent: 15 },
            { name: '60-69分', value: 35, percent: 5 }
        ];

        const trendData = {
            labels: ['10/11', '10/12', '10/13', '10/14', '10/15', '10/16', '10/17'],
            datasets: [{
                label: '平均分數',
                data: [82, 84, 83, 85, 87, 86, 88],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: '#3b82f6'
            }, {
                label: '中位數',
                data: [83, 85, 84, 86, 88, 87, 89],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                pointRadius: 3,
                pointBackgroundColor: '#10b981',
                borderDash: [5, 5]
            }]
        };

        const trendRawData = [
            { date: '10/11', score: 82, calls: 622, median: 83, q1: 78, q3: 87 },
            { date: '10/12', score: 84, calls: 655, median: 85, q1: 80, q3: 89 },
            { date: '10/13', score: 83, calls: 648, median: 84, q1: 79, q3: 88 },
            { date: '10/14', score: 85, calls: 670, median: 86, q1: 81, q3: 90 },
            { date: '10/15', score: 87, calls: 688, median: 88, q1: 83, q3: 92 },
            { date: '10/16', score: 86, calls: 675, median: 87, q1: 82, q3: 91 },
            { date: '10/17', score: 88, calls: 700, median: 89, q1: 84, q3: 93 }
        ];

        const allTopIssues = [
            { 
                issue: '未使用禮貌用語', 
                count: 45, 
                rate: 6.4,
                totalDeduction: 248,
                avgDeduction: 5.5,
                affectedCalls: 45,
                affectedAgents: 28,
                trend: 'up',
                changePercent: 12.5,
                category: '服務態度',
                fullScore: 8
            },
            { 
                issue: '問題未完全解決', 
                count: 38, 
                rate: 5.4,
                totalDeduction: 380,
                avgDeduction: 10.0,
                affectedCalls: 38,
                affectedAgents: 15,
                trend: 'down',
                changePercent: -5.0,
                category: '問題解決',
                fullScore: 12
            },
            { 
                issue: '回應時間過長', 
                count: 32, 
                rate: 4.6,
                totalDeduction: 128,
                avgDeduction: 4.0,
                affectedCalls: 32,
                affectedAgents: 18,
                trend: 'up',
                changePercent: 8.3,
                category: '溝通效率',
                fullScore: 5
            },
            { 
                issue: '專業知識不足', 
                count: 28, 
                rate: 4.0,
                totalDeduction: 280,
                avgDeduction: 10.0,
                affectedCalls: 28,
                affectedAgents: 5,
                trend: 'stable',
                changePercent: 0,
                category: '專業能力',
                fullScore: 12
            },
            { 
                issue: '缺少結束語', 
                count: 21, 
                rate: 3.0,
                totalDeduction: 84,
                avgDeduction: 4.0,
                affectedCalls: 21,
                affectedAgents: 12,
                trend: 'down',
                changePercent: -15.0,
                category: '結束語',
                fullScore: 4
            },
            { 
                issue: '音量控制不當', 
                count: 19, 
                rate: 2.7,
                totalDeduction: 76,
                avgDeduction: 4.0,
                affectedCalls: 19,
                affectedAgents: 11,
                trend: 'up',
                changePercent: 5.6,
                category: '通話品質',
                fullScore: 4
            },
            { 
                issue: '未確認客戶需求', 
                count: 18, 
                rate: 2.6,
                totalDeduction: 108,
                avgDeduction: 6.0,
                affectedCalls: 18,
                affectedAgents: 9,
                trend: 'stable',
                changePercent: 0,
                category: '需求確認',
                fullScore: 6
            },
            { 
                issue: '轉接流程錯誤', 
                count: 16, 
                rate: 2.3,
                totalDeduction: 96,
                avgDeduction: 6.0,
                affectedCalls: 16,
                affectedAgents: 8,
                trend: 'down',
                changePercent: -11.1,
                category: '流程規範',
                fullScore: 6
            },
            { 
                issue: '未做通話記錄', 
                count: 15, 
                rate: 2.1,
                totalDeduction: 90,
                avgDeduction: 6.0,
                affectedCalls: 15,
                affectedAgents: 10,
                trend: 'up',
                changePercent: 7.1,
                category: '記錄規範',
                fullScore: 6
            },
            { 
                issue: '話術不標準', 
                count: 14, 
                rate: 2.0,
                totalDeduction: 56,
                avgDeduction: 4.0,
                affectedCalls: 14,
                affectedAgents: 7,
                trend: 'stable',
                changePercent: 0,
                category: '標準話術',
                fullScore: 4
            },
            { 
                issue: '客戶情緒安撫不當', 
                count: 13, 
                rate: 1.9,
                totalDeduction: 78,
                avgDeduction: 6.0,
                affectedCalls: 13,
                affectedAgents: 6,
                trend: 'down',
                changePercent: -7.1,
                category: '情緒處理',
                fullScore: 6
            },
            { 
                issue: '保密規定違反', 
                count: 12, 
                rate: 1.7,
                totalDeduction: 144,
                avgDeduction: 12.0,
                affectedCalls: 12,
                affectedAgents: 5,
                trend: 'up',
                changePercent: 20.0,
                category: '合規要求',
                fullScore: 12
            },
            { 
                issue: '系統操作錯誤', 
                count: 11, 
                rate: 1.6,
                totalDeduction: 44,
                avgDeduction: 4.0,
                affectedCalls: 11,
                affectedAgents: 8,
                trend: 'stable',
                changePercent: 0,
                category: '系統操作',
                fullScore: 4
            },
            { 
                issue: '未提供替代方案', 
                count: 10, 
                rate: 1.4,
                totalDeduction: 60,
                avgDeduction: 6.0,
                affectedCalls: 10,
                affectedAgents: 6,
                trend: 'down',
                changePercent: -9.1,
                category: '解決方案',
                fullScore: 6
            },
            { 
                issue: '通話環境噪音', 
                count: 9, 
                rate: 1.3,
                totalDeduction: 36,
                avgDeduction: 4.0,
                affectedCalls: 9,
                affectedAgents: 7,
                trend: 'up',
                changePercent: 12.5,
                category: '通話品質',
                fullScore: 4
            },
            { 
                issue: '未使用客戶姓名', 
                count: 8, 
                rate: 1.1,
                totalDeduction: 24,
                avgDeduction: 3.0,
                affectedCalls: 8,
                affectedAgents: 5,
                trend: 'stable',
                changePercent: 0,
                category: '個人化服務',
                fullScore: 3
            },
            { 
                issue: '產品介紹不完整', 
                count: 7, 
                rate: 1.0,
                totalDeduction: 42,
                avgDeduction: 6.0,
                affectedCalls: 7,
                affectedAgents: 4,
                trend: 'down',
                changePercent: -12.5,
                category: '產品知識',
                fullScore: 6
            },
            { 
                issue: '語速過快或過慢', 
                count: 6, 
                rate: 0.9,
                totalDeduction: 18,
                avgDeduction: 3.0,
                affectedCalls: 6,
                affectedAgents: 4,
                trend: 'up',
                changePercent: 20.0,
                category: '溝通技巧',
                fullScore: 3
            },
            { 
                issue: '重複詢問相同問題', 
                count: 5, 
                rate: 0.7,
                totalDeduction: 20,
                avgDeduction: 4.0,
                affectedCalls: 5,
                affectedAgents: 3,
                trend: 'stable',
                changePercent: 0,
                category: '溝通效率',
                fullScore: 4
            },
            { 
                issue: '未執行身份驗證', 
                count: 4, 
                rate: 0.6,
                totalDeduction: 48,
                avgDeduction: 12.0,
                affectedCalls: 4,
                affectedAgents: 2,
                trend: 'down',
                changePercent: -20.0,
                category: '安全規範',
                fullScore: 12
            }
        ];

        // 當前顯示的議題數據（會根據選擇的TOP數量變化）
        let topIssues = allTopIssues.slice(0, 5); // 預設顯示TOP 5

        // 語音標籤分析數據
        const productTags = [
            { name: '醫療險', count: 245, coverage: 156, successRate: 73.2, trend: 'up', changePercent: 15.3 },
            { name: '意外險', count: 198, coverage: 134, successRate: 68.5, trend: 'up', changePercent: 8.7 },
            { name: '壽險', count: 167, coverage: 112, successRate: 81.2, trend: 'stable', changePercent: 0 },
            { name: '汽車險', count: 143, coverage: 98, successRate: 65.8, trend: 'down', changePercent: -5.2 },
            { name: '機車險', count: 127, coverage: 89, successRate: 72.1, trend: 'up', changePercent: 12.1 },
            { name: '旅遊險', count: 98, coverage: 67, successRate: 78.9, trend: 'up', changePercent: 22.5 },
            { name: '儲蓄險', count: 89, coverage: 62, successRate: 69.7, trend: 'stable', changePercent: 1.2 },
            { name: '投資型保單', count: 76, coverage: 54, successRate: 58.3, trend: 'down', changePercent: -8.9 },
            { name: '癌症險', count: 65, coverage: 47, successRate: 74.6, trend: 'up', changePercent: 18.7 },
            { name: '失能險', count: 52, coverage: 38, successRate: 71.3, trend: 'up', changePercent: 9.8 }
        ];

        const intentData = {
            labels: ['購買保單', '詢問商品', '申請理賠', '保單變更', '續保', '退保', '保費查詢', '理賠進度', '其他'],
            datasets: [{
                data: [285, 198, 167, 134, 98, 76, 65, 43, 34],
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
                    '#06b6d4', '#84cc16', '#f97316', '#6b7280'
                ]
            }]
        };

        const activityTags = [
            { name: '新春專案', count: 89, period: '2024/01-03', status: 'active', performance: 'excellent' },
            { name: '母親節優惠', count: 76, period: '2024/05', status: 'ended', performance: 'good' },
            { name: '暑期旅遊險', count: 65, period: '2024/06-08', status: 'active', performance: 'good' },
            { name: '中秋團圓方案', count: 54, period: '2024/09', status: 'ended', performance: 'average' },
            { name: '雙11特惠', count: 43, period: '2024/11', status: 'planned', performance: 'pending' },
            { name: '年終回饋', count: 38, period: '2024/12', status: 'planned', performance: 'pending' },
            { name: '開學季專案', count: 32, period: '2024/08-09', status: 'ended', performance: 'good' },
            { name: '情人節限定', count: 27, period: '2024/02', status: 'ended', performance: 'average' }
        ];

        const tagTrendData = {
            labels: ['10/11', '10/12', '10/13', '10/14', '10/15', '10/16', '10/17'],
            datasets: [
                {
                    label: '商品標籤',
                    data: [156, 168, 172, 184, 189, 195, 198],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                },
                {
                    label: '意圖標籤',
                    data: [89, 92, 87, 95, 98, 101, 105],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: '活動標籤',
                    data: [23, 21, 25, 28, 32, 35, 38],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                }
            ]
        };

        const allTagsData = [
            { name: '醫療險', type: 'product', count: 245, coverage: 156, successRate: 73.2, trend: 'up' },
            { name: '購買保單', type: 'intent', count: 285, coverage: 198, successRate: 82.1, trend: 'up' },
            { name: '新春專案', type: 'activity', count: 89, coverage: 67, successRate: 75.3, trend: 'stable' },
            { name: '意外險', type: 'product', count: 198, coverage: 134, successRate: 68.5, trend: 'up' },
            { name: '詢問商品', type: 'intent', count: 198, coverage: 142, successRate: 79.8, trend: 'stable' },
            { name: '壽險', type: 'product', count: 167, coverage: 112, successRate: 81.2, trend: 'stable' },
            { name: '申請理賠', type: 'intent', count: 167, coverage: 123, successRate: 85.6, trend: 'up' },
            { name: '母親節優惠', type: 'activity', count: 76, coverage: 58, successRate: 71.2, trend: 'down' },
            { name: '汽車險', type: 'product', count: 143, coverage: 98, successRate: 65.8, trend: 'down' },
            { name: '保單變更', type: 'intent', count: 134, coverage: 95, successRate: 77.3, trend: 'stable' }
        ];

        const agentPerformance = [
            { name: '張小明', score: 92, calls: 156, fcr: 89 },
            { name: '李美玲', score: 88, calls: 142, fcr: 85 },
            { name: '王大偉', score: 85, calls: 138, fcr: 82 },
            { name: '陳小華', score: 82, calls: 145, fcr: 78 },
            { name: '林志強', score: 78, calls: 132, fcr: 75 }
        ];

        // Audio detail data
        const audioDataByIssue = {
            '未使用禮貌用語': [
                {
                    fileName: 'call_20241017_142530_A002_C8859.wav',
                    duration: '05:23',
                    callTime: '2024/10/17 14:25:30',
                    agentId: 'A002',
                    agentName: '李美玲',
                    createdBy: 'QC001',
                    createdByName: '質檢員王小芬',
                    customerId: 'C8859',
                    customerName: '陳先生',
                    severity: 'medium',
                    deduction: 5,
                    sttText: '客服：您好，請問有什麼需要幫助的嗎？\n客戶：我想要查詢我的保單狀況。\n客服：好的，請提供您的身分證字號。\n客戶：A123456789\n客服：查到了，您的保單目前正常繳費中。\n客戶：那我想要變更受益人可以嗎？\n客服：可以，但需要填寫變更申請書。\n客戶：好的謝謝。\n客服：不客氣。'
                },
                {
                    fileName: 'call_20241017_135420_A003_C7742.wav',
                    duration: '03:45',
                    callTime: '2024/10/17 13:54:20',
                    agentId: 'A003',
                    agentName: '王大偉',
                    createdBy: 'QC002',
                    createdByName: '質檢員林小美',
                    customerId: 'C7742',
                    customerName: '張女士',
                    severity: 'high',
                    deduction: 8,
                    sttText: '客服：喂？\n客戶：你好，我想要理賠申請。\n客服：什麼理賠？\n客戶：我上個月車禍，想要申請理賠。\n客服：那你要填表格，然後準備資料。\n客戶：什麼資料？\n客服：就診斷書、收據這些。\n客戶：好吧。\n客服：還有其他問題嗎？\n客戶：沒有了。\n客服：那就這樣。'
                },
                {
                    fileName: 'call_20241017_161155_A005_C9123.wav',
                    duration: '07:12',
                    callTime: '2024/10/17 16:11:55',
                    agentId: 'A005',
                    agentName: '林志強',
                    createdBy: 'QC001',
                    createdByName: '質檢員王小芬',
                    customerId: 'C9123',
                    customerName: '劉太太',
                    severity: 'low',
                    deduction: 3,
                    sttText: '客服：您好，這裡是保險公司，請問有什麼可以為您服務的？\n客戶：我想要了解一下意外險的理賠範圍。\n客服：好的，意外險主要理賠因為意外事故造成的醫療費用和殘廢給付。\n客戶：那包括哪些意外呢？\n客服：包括交通事故、跌倒、燒燙傷等非疾病原因造成的傷害。\n客戶：了解，那理賠金額是怎麼計算的？\n客服：會依照您投保的保額和醫療費用收據來計算。\n客戶：好的，謝謝你的說明。\n客服：嗯，沒事。'
                }
            ],
            '問題未完全解決': [
                {
                    fileName: 'call_20241017_093025_A001_C5566.wav',
                    duration: '08:45',
                    callTime: '2024/10/17 09:30:25',
                    agentId: 'A001',
                    agentName: '張小明',
                    createdBy: 'QC003',
                    createdByName: '質檢員陳小華',
                    customerId: 'C5566',
                    customerName: '黃先生',
                    severity: 'high',
                    deduction: 12,
                    sttText: '客服：您好，感謝您來電，我是張小明，請問有什麼可以為您服務的？\n客戶：我的保險理賠案件已經送件兩個月了，為什麼還沒有下來？\n客服：請您稍等，我幫您查詢一下案件狀況。請提供您的保單號碼。\n客戶：PL202401234567\n客服：好的，我查到您的案件目前在核保部門審核中。\n客戶：為什麼要這麼久？我急需這筆錢。\n客服：因為您的案件金額比較大，需要詳細審核。\n客戶：那什麼時候會有結果？\n客服：這個我也不太清楚，要問核保部門。\n客戶：那你可以幫我問嗎？\n客服：我等一下會幫您反映。\n客戶：什麼時候會回覆我？\n客服：大概一週內會有人聯絡您。'
                },
                {
                    fileName: 'call_20241017_112215_A004_C3344.wav',
                    duration: '06:33',
                    callTime: '2024/10/17 11:22:15',
                    agentId: 'A004',
                    agentName: '陳小華',
                    createdBy: 'QC002',
                    createdByName: '質檢員林小美',
                    customerId: 'C3344',
                    customerName: '吳小姐',
                    severity: 'medium',
                    deduction: 8,
                    sttText: '客服：您好，這裡是客服中心，我是陳小華，請問有什麼可以協助您的？\n客戶：我想要更改我的通訊地址。\n客服：好的，請提供您的身分證字號和保單號碼。\n客戶：身分證字號是B987654321，保單號碼是PL202401567890\n客服：好的，請問您要更改成什麼地址？\n客戶：台北市信義區松高路123號4樓\n客服：我已經幫您登記了，大概3-5個工作天會完成更改。\n客戶：那我怎麼知道已經更改成功了？\n客服：系統會自動更新。\n客戶：但是我怎麼確認呢？會有通知嗎？\n客服：這個...我不太確定，您可以過幾天再打電話來確認。'
                }
            ],
            '回應時間過長': [
                {
                    fileName: 'call_20241017_145030_A002_C6677.wav',
                    duration: '04:58',
                    callTime: '2024/10/17 14:50:30',
                    agentId: 'A002',
                    agentName: '李美玲',
                    createdBy: 'QC001',
                    createdByName: '質檢員王小芬',
                    customerId: 'C6677',
                    customerName: '徐先生',
                    severity: 'medium',
                    deduction: 4,
                    sttText: '客服：您好，感謝您來電，我是李美玲，請問有什麼可以為您服務的？\n客戶：我想要查詢我的保單現金價值。\n客服：好的，請稍等一下...(沉默15秒)...抱歉讓您久等了，請提供您的保單號碼。\n客戶：PL202401345678\n客服：好的，我幫您查詢...(沉默20秒)...請問您是要查詢哪一張保單呢？\n客戶：就剛才那個號碼啊。\n客服：抱歉，我再查一次...(沉默18秒)...您的保單現金價值是18萬5千元。\n客戶：好的，謝謝。'
                }
            ],
            '專業知識不足': [
                {
                    fileName: 'call_20241017_105540_A005_C1122.wav',
                    duration: '09:22',
                    callTime: '2024/10/17 10:55:40',
                    agentId: 'A005',
                    agentName: '林志強',
                    createdBy: 'QC003',
                    createdByName: '質檢員陳小華',
                    customerId: 'C1122',
                    customerName: '方小姐',
                    severity: 'high',
                    deduction: 10,
                    sttText: '客服：您好，我是林志強，請問有什麼可以為您服務的？\n客戶：我想要了解一下投資型保單的費用結構。\n客服：好的，投資型保單就是...嗯...就是可以投資的保單。\n客戶：我知道，但是費用怎麼算呢？有哪些費用？\n客服：費用的話...有管理費...還有其他費用。\n客戶：具體是多少呢？\n客服：這個我要查一下...您稍等。\n客戶：好。\n客服：管理費大概是...我不太確定，要不您留個電話，我請專員回電給您？\n客戶：可是我現在就想知道啊。\n客服：真的不好意思，這個比較複雜，我可能說不清楚。'
                }
            ],
            '缺少結束語': [
                {
                    fileName: 'call_20241017_164420_A003_C4455.wav',
                    duration: '02:31',
                    callTime: '2024/10/17 16:44:20',
                    agentId: 'A003',
                    agentName: '王大偉',
                    createdBy: 'QC002',
                    createdByName: '質檢員林小美',
                    customerId: 'C4455',
                    customerName: '李太太',
                    severity: 'low',
                    deduction: 4,
                    sttText: '客服：您好，請問有什麼需要幫助的？\n客戶：我想要查詢我上個月的繳費記錄。\n客服：請提供您的保單號碼。\n客戶：PL202401789012\n客服：您上個月已經正常繳費了，金額是3500元。\n客戶：好的，謝謝。\n客服：嗯。'
                }
            ]
        };

        // Audio detail page variables
        let currentAudioPage = 1;
        let audioPageSize = 20;
        let totalAudioPages = 0;
        let currentAudioData = [];
        let allCurrentAudioData = [];
        let currentIssueType = '';

        const complianceData = {
            labels: ['開場白', '身份驗證', '問題確認', '解決方案', '結束語'],
            datasets: [{
                label: '合格',
                data: [650, 620, 640, 600, 660],
                backgroundColor: '#10b981'
            }, {
                label: '不合格',
                data: [50, 80, 60, 100, 40],
                backgroundColor: '#ef4444'
            }]
        };

        const emotionData = {
            labels: ['正面', '中性', '負面'],
            datasets: [{
                data: [520, 280, 120],
                backgroundColor: ['#10b981', '#6b7280', '#ef4444']
            }]
        };

        // Tab switching function
        function setActiveTab(tab) {
            // Hide all content
            document.querySelectorAll('[id$="-content"]').forEach(content => {
                content.style.display = 'none';
            });

            // Show selected content
            const selectedContent = document.getElementById(tab + '-content');
            if (selectedContent) {
                selectedContent.style.display = 'block';
            } else {
                console.warn(`Content element not found: ${tab}-content`);
            }

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button) {
                    button.className = 'tab-button py-4 px-2 border-b-2 font-medium text-sm transition border-transparent text-gray-600 hover:text-gray-900';
                }
            });

            const activeTabButton = document.getElementById('tab-' + tab);
            if (activeTabButton) {
                activeTabButton.className = 'tab-button py-4 px-2 border-b-2 font-medium text-sm transition border-blue-600 text-blue-600';
            } else {
                console.warn(`Tab button not found: tab-${tab}`);
            }

            // Update tab state management
            switchTab(tab);
            
            // Inject time filters for tabs that need them (not overview since it has the original filter)
            if (tab !== 'overview') {
                injectTimeFilterForTab(tab);
            }

            activeTab = tab;

            // Initialize charts for the active tab
            initChartsForTab(tab);
        }
        
        // Function to inject time filter for specific tab
        function injectTimeFilterForTab(tabId) {
            const container = document.getElementById(`${tabId}-time-filter-container`);
            if (container && !container.hasChildNodes()) {
                container.innerHTML = generateTimeFilterTemplate(tabId);
                
                // Initialize the filter after injection
                setTimeout(() => {
                    setTabFilterTab(tabId, 'custom');
                    
                    // Copy state from overview tab if this tab has no state yet
                    const tabState = tabFilterStates[tabId];
                    const overviewState = tabFilterStates.overview;
                    
                    if (!tabState.startDate && overviewState.startDate) {
                        tabState.startDate = overviewState.startDate;
                        tabState.endDate = overviewState.endDate;
                        tabState.type = overviewState.type;
                        
                        // Set the form values if they exist
                        const startInput = document.getElementById(`${tabId}-customStartDate`);
                        const endInput = document.getElementById(`${tabId}-customEndDate`);
                        if (startInput) startInput.value = overviewState.startDate;
                        if (endInput) endInput.value = overviewState.endDate;
                    }
                    
                    // Recreate icons after injecting new HTML
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        lucide.createIcons();
                    }
                }, 100);
            }
        }

        // Initialize charts based on active tab
        function initChartsForTab(tab) {
            // 確保 ECharts 已載入
            if (typeof echarts === 'undefined') {
                console.error('ECharts not available for tab:', tab);
                setTimeout(() => initChartsForTab(tab), 500);
                return;
            }
            
            switch(tab) {
                case 'overview':
                    setTimeout(() => {
                        initQualityChart();
                        initTrendChart();
                        initUrgentCasesChart();
                        initProblemCasesChart();
                    }, 100);
                    break;
                case 'analysis':
                    // Add delay to ensure containers are visible
                    setTimeout(() => {
                        console.log('Initializing analysis tab charts...');
                        initComplianceChart();      // Quality analysis chart
                        initEmotionAnalysisChart(); // Emotion analysis chart
                        initEmotionTrendChart();    // Emotion trend chart
                    }, 300);
                    break;
                case 'tags':
                    setTimeout(() => {
                        initTagsPage();
                    }, 100);
                    break;
            }
        }

        // Chart initialization functions
        function initQualityChart() {
            if (charts.quality) {
                charts.quality.dispose();
            }
            const chartDom = document.getElementById('qualityChart');
            charts.quality = echarts.init(chartDom);
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 'bottom',
                    data: qualityScoreData.map(item => item.name)
                },
                series: [
                    {
                        name: '品質分數分布',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 20,
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: qualityScoreData.map((item, index) => ({
                            value: item.value,
                            name: item.name,
                            itemStyle: {
                                color: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'][index]
                            }
                        }))
                    }
                ]
            };
            
            charts.quality.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.quality.resize();
            }, 100);
        }

        function initTrendChart() {
            if (charts.trend) {
                charts.trend.dispose();
            }
            const chartDom = document.getElementById('trendChart');
            charts.trend = echarts.init(chartDom);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const dataIndex = params[0].dataIndex;
                        const rawData = trendRawData[dataIndex];
                        let result = `${params[0].axisValue}<br/>`;
                        params.forEach(function(item) {
                            result += `${item.marker}${item.seriesName}: ${item.value}分<br/>`;
                        });
                        result += `中位數: ${rawData.median}分<br/>`;
                        result += `質檢通話: ${rawData.calls}通<br/>`;
                        result += `Q1-Q3: ${rawData.q1}-${rawData.q3}分`;
                        return result;
                    }
                },
                legend: {
                    data: ['平均分數', '中位數'],
                    top: 'top'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: trendData.labels,
                    name: '日期',
                    nameLocation: 'middle',
                    nameGap: 25
                },
                yAxis: {
                    type: 'value',
                    min: 70,
                    max: 95,
                    name: '分數',
                    nameLocation: 'middle',
                    nameGap: 40
                },
                series: [
                    {
                        name: '平均分數',
                        type: 'line',
                        smooth: true,
                        data: trendData.datasets[0].data,
                        lineStyle: {
                            color: '#3b82f6',
                            width: 3
                        },
                        itemStyle: {
                            color: '#3b82f6'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(59, 130, 246, 0.3)'
                                }, {
                                    offset: 1, color: 'rgba(59, 130, 246, 0.1)'
                                }]
                            }
                        }
                    },
                    {
                        name: '中位數',
                        type: 'line',
                        smooth: true,
                        data: trendData.datasets[1].data,
                        lineStyle: {
                            color: '#10b981',
                            width: 2,
                            type: 'dashed'
                        },
                        itemStyle: {
                            color: '#10b981'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(16, 185, 129, 0.3)'
                                }, {
                                    offset: 1, color: 'rgba(16, 185, 129, 0.1)'
                                }]
                            }
                        }
                    }
                ]
            };
            
            charts.trend.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.trend.resize();
            }, 100);
        }

        function initUrgentCasesChart() {
            if (charts.urgentCases) {
                charts.urgentCases.dispose();
            }
            const chartDom = document.getElementById('urgentCasesChart');
            if (!chartDom) {
                console.error('urgentCasesChart container not found');
                return;
            }
            
            charts.urgentCases = echarts.init(chartDom);
            
            // 生成最近7天的模擬數據
            const dates = [];
            const urgentCounts = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dates.push(date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }));
                urgentCounts.push(Math.floor(Math.random() * 15) + 5); // 5-20之間的隨機數
            }
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>急需處理: ${params[0].value} 件`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisTick: {
                        alignWithLabel: true
                    },
                    axisLabel: {
                        color: '#6B7280'
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '案件數量',
                    nameTextStyle: {
                        color: '#6B7280'
                    },
                    axisLabel: {
                        color: '#6B7280'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#E5E7EB'
                        }
                    }
                },
                series: [
                    {
                        name: '急需處理案件',
                        type: 'line',
                        data: urgentCounts,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: {
                            color: '#EF4444',
                            width: 3
                        },
                        itemStyle: {
                            color: '#EF4444'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(239, 68, 68, 0.3)' },
                                { offset: 1, color: 'rgba(239, 68, 68, 0.1)' }
                            ])
                        },
                        emphasis: {
                            scale: true
                        }
                    }
                ]
            };
            
            charts.urgentCases.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.urgentCases.resize();
            }, 100);
        }

        function initProblemCasesChart() {
            if (charts.problemCases) {
                charts.problemCases.dispose();
            }
            const chartDom = document.getElementById('problemCasesChart');
            if (!chartDom) {
                console.error('problemCasesChart container not found');
                return;
            }
            
            charts.problemCases = echarts.init(chartDom);
            
            // 生成最近7天的模擬數據
            const dates = [];
            const problemCounts = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dates.push(date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }));
                problemCounts.push(Math.floor(Math.random() * 12) + 3); // 3-15之間的隨機數
            }
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        return `${params[0].axisValue}<br/>問題案件: ${params[0].value} 件`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisTick: {
                        alignWithLabel: true
                    },
                    axisLabel: {
                        color: '#6B7280'
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '案件數量',
                    nameTextStyle: {
                        color: '#6B7280'
                    },
                    axisLabel: {
                        color: '#6B7280'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#E5E7EB'
                        }
                    }
                },
                series: [
                    {
                        name: '問題案件',
                        type: 'line',
                        data: problemCounts,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: {
                            color: '#F59E0B',
                            width: 3
                        },
                        itemStyle: {
                            color: '#F59E0B'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(245, 158, 11, 0.3)' },
                                { offset: 1, color: 'rgba(245, 158, 11, 0.1)' }
                            ])
                        },
                        emphasis: {
                            scale: true
                        }
                    }
                ]
            };
            
            charts.problemCases.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.problemCases.resize();
            }, 100);
        }


function initComplianceChart() {
    if (charts.compliance) {
        charts.compliance.dispose();
    }
    const chartDom = document.getElementById('complianceChart');
    charts.compliance = echarts.init(chartDom);
    
    const option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: function(params) {
                let result = `${params[0].name}<br/>`;
                let total = 0;
                params.forEach(param => {
                    total += param.value;
                });
                params.forEach(param => {
                    const pct = total ? ((param.value / total) * 100).toFixed(1) : '0.0';
                    result += `${param.marker}${param.seriesName}: ${param.value} (${pct}%)<br/>`;
                });
                return result;
            }
        },
        legend: {
            data: ['合格', '不合格'],
            bottom: 'bottom'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            name: '通數',
            nameLocation: 'middle',
            nameGap: 25
        },
        yAxis: {
            type: 'category',
            data: complianceData.labels
        },
        series: [
            {
                name: '合格',
                type: 'bar',
                stack: 'total',
                itemStyle: {
                    color: '#10b981'
                },
                data: complianceData.datasets[0].data
            },
            {
                name: '不合格',
                type: 'bar',
                stack: 'total',
                itemStyle: {
                    color: '#ef4444'
                },
                data: complianceData.datasets[1].data
            }
        ]
    };
    
    // 添加點擊事件
    charts.compliance.on('click', function(params) {
        if (params.componentType === 'series') {
            const label = params.name;
            showComplianceDetail(label);
        }
    });
    
    charts.compliance.setOption(option);
    
    // 確保圖表正確響應容器大小變化
    setTimeout(() => {
        charts.compliance.resize();
    }, 100);
}

        function initComplianceDetailChart() {
            if (charts.complianceDetail) {
                charts.complianceDetail.dispose();
            }
            const chartDom = document.getElementById('complianceDetailChart');
            charts.complianceDetail = echarts.init(chartDom);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['合格', '不合格'],
                    bottom: 'bottom'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: complianceData.labels
                },
                series: [
                    {
                        name: '合格',
                        type: 'bar',
                        stack: 'total',
                        itemStyle: {
                            color: '#10b981'
                        },
                        data: complianceData.datasets[0].data
                    },
                    {
                        name: '不合格',
                        type: 'bar',
                        stack: 'total',
                        itemStyle: {
                            color: '#ef4444'
                        },
                        data: complianceData.datasets[1].data
                    }
                ]
            };
            
            charts.complianceDetail.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.complianceDetail.resize();
            }, 100);
        }

        function initEmotionAnalysisChart() {
            if (charts.emotionAnalysis) {
                charts.emotionAnalysis.dispose();
            }
            const chartDom = document.getElementById('emotionAnalysisChart');
            if (!chartDom) {
                console.error('emotionAnalysisChart container not found');
                return;
            }
            
            charts.emotionAnalysis = echarts.init(chartDom);
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    data: ['正面', '中立偏正面', '中立', '中立偏負面', '負面']
                },
                series: [
                    {
                        name: '情緒分佈',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['60%', '50%'],
                        avoidLabelOverlap: false,
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold'
                            },
                            scale: true,
                            scaleSize: 5
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            {
                                value: 35,
                                name: '正面',
                                itemStyle: { color: '#10B981' }
                            },
                            {
                                value: 25,
                                name: '中立偏正面',
                                itemStyle: { color: '#84CC16' }
                            },
                            {
                                value: 20,
                                name: '中立',
                                itemStyle: { color: '#6B7280' }
                            },
                            {
                                value: 12,
                                name: '中立偏負面',
                                itemStyle: { color: '#F59E0B' }
                            },
                            {
                                value: 8,
                                name: '負面',
                                itemStyle: { color: '#EF4444' }
                            }
                        ]
                    }
                ]
            };
            
            charts.emotionAnalysis.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.emotionAnalysis.resize();
            }, 100);
        }

        function initEmotionTrendChart() {
            if (charts.emotionTrend) {
                charts.emotionTrend.dispose();
            }
            const chartDom = document.getElementById('emotionTrendChart');
            if (!chartDom) {
                console.error('emotionTrendChart container not found');
                return;
            }
            
            charts.emotionTrend = echarts.init(chartDom);
            
            // 生成最近7天的模擬數據
            const dates = [];
            const positiveData = [];
            const neutralPositiveData = [];
            const neutralData = [];
            const neutralNegativeData = [];
            const negativeData = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dates.push(date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }));
                
                // 模擬數據，正面情緒逐漸上升，負面情緒逐漸下降
                positiveData.push(Math.floor(Math.random() * 200) + 1400 + i * 20);
                neutralPositiveData.push(Math.floor(Math.random() * 150) + 800 + i * 10);
                neutralData.push(Math.floor(Math.random() * 100) + 500);
                neutralNegativeData.push(Math.floor(Math.random() * 80) + 300 - i * 5);
                negativeData.push(Math.floor(Math.random() * 50) + 100 - i * 3);
            }
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'line'
                    }
                },
                legend: {
                    data: ['正面', '中立偏正面', '中立', '中立偏負面', '負面'],
                    bottom: 'bottom'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        color: '#6B7280'
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        color: '#6B7280'
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#E5E7EB'
                        }
                    }
                },
                series: [
                    {
                        name: '正面',
                        type: 'line',
                        data: positiveData,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: {
                            color: '#10B981',
                            width: 2
                        },
                        itemStyle: {
                            color: '#10B981'
                        }
                    },
                    {
                        name: '中立偏正面',
                        type: 'line',
                        data: neutralPositiveData,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: {
                            color: '#84CC16',
                            width: 2
                        },
                        itemStyle: {
                            color: '#84CC16'
                        }
                    },
                    {
                        name: '中立',
                        type: 'line',
                        data: neutralData,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: {
                            color: '#6B7280',
                            width: 2
                        },
                        itemStyle: {
                            color: '#6B7280'
                        }
                    },
                    {
                        name: '中立偏負面',
                        type: 'line',
                        data: neutralNegativeData,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: {
                            color: '#F59E0B',
                            width: 2
                        },
                        itemStyle: {
                            color: '#F59E0B'
                        }
                    },
                    {
                        name: '負面',
                        type: 'line',
                        data: negativeData,
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 4,
                        lineStyle: {
                            color: '#EF4444',
                            width: 2
                        },
                        itemStyle: {
                            color: '#EF4444'
                        }
                    }
                ]
            };
            
            charts.emotionTrend.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.emotionTrend.resize();
            }, 100);
        }

        function initEmotionChart() {
            // 檢查 ECharts 是否已載入
            if (typeof echarts === 'undefined') {
                console.error('ECharts not loaded!');
                setTimeout(initEmotionChart, 500); // 延遲重試
                return;
            }
            
            const chartDom = document.getElementById('emotionChart');
            
            // 確保容器存在且可見
            if (!chartDom) {
                console.error('emotionChart container not found');
                return;
            }

            // 檢查容器是否可見
            const isVisible = chartDom.offsetWidth > 0 && chartDom.offsetHeight > 0;
            if (!isVisible) {
                console.warn('emotionChart container not visible, retrying...');
                setTimeout(initEmotionChart, 300);
                return;
            }
            
            // 銷毀現有實例
            if (charts.emotion) {
                charts.emotion.dispose();
                charts.emotion = null;
            }
            
            console.log('Initializing emotion chart...', chartDom);
            console.log('Container dimensions:', chartDom.offsetWidth, 'x', chartDom.offsetHeight);
            console.log('ECharts version:', echarts.version);
            
            try {
                charts.emotion = echarts.init(chartDom, null, {
                    width: chartDom.offsetWidth,
                    height: chartDom.offsetHeight,
                    renderer: 'canvas'
                });
                console.log('ECharts instance created successfully:', !!charts.emotion);
            } catch (error) {
                console.error('Failed to create ECharts instance:', error);
                return;
            }
            
            // 使用硬編碼數據確保圖表能顯示
            const emotionChartData = [
                { value: 520, name: '正面', itemStyle: { color: '#10b981' } },
                { value: 280, name: '中性', itemStyle: { color: '#6b7280' } },
                { value: 120, name: '負面', itemStyle: { color: '#ef4444' } }
            ];
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 'bottom',
                    data: ['正面', '中性', '負面']
                },
                series: [
                    {
                        name: '情緒分布',
                        type: 'pie',
                        radius: ['0%', '70%'],
                        center: ['50%', '50%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            position: 'outside',
                            formatter: '{b}: {d}%'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 16,
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: true
                        },
                        data: emotionChartData
                    }
                ]
            };
            
            console.log('Setting emotion chart option:', option);
            charts.emotion.setOption(option);
            
            // 確保圖表正確響應容器大小變化，增加延遲時間
            setTimeout(() => {
                if (charts.emotion) {
                    console.log('Resizing emotion chart...');
                    charts.emotion.resize();
                }
            }, 300);
        }

        // 更新 TOP 議題顯示數量
        function updateTopIssuesDisplay() {
            const topCountElement = document.getElementById('topCount');
            if (!topCountElement) {
                console.warn('topCount element not found');
                return;
            }
            
            const selectedCount = topCountElement.value;
            
            if (selectedCount === 'all') {
                topIssues = [...allTopIssues];
                const titleElement = document.getElementById('topIssuesTitle');
                if (titleElement) {
                    titleElement.textContent = `高頻扣分指標 TOP ${allTopIssues.length}`;
                }
            } else {
                const count = parseInt(selectedCount);
                topIssues = allTopIssues.slice(0, count);
                const titleElement = document.getElementById('topIssuesTitle');
                if (titleElement) {
                    titleElement.textContent = `高頻扣分指標 TOP ${count}`;
                }
            }
            
            populateTopIssues();
        }

        // Populate top issues list
        function populateTopIssues() {
            const container = document.getElementById('topIssuesList');
            container.innerHTML = '';
            
            topIssues.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-lg transition-all duration-200 cursor-pointer hover:bg-blue-50';
                div.onclick = () => showAudioDetail(item.issue);
                
                const trendIcon = item.trend === 'up' ? 'trending-up' : 
                                 item.trend === 'down' ? 'trending-down' : 'minus';
                const trendColor = item.trend === 'up' ? 'text-red-600' : 
                                  item.trend === 'down' ? 'text-green-600' : 'text-gray-600';
                
                
                div.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-start space-x-3 flex-1">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-bold text-sm flex-shrink-0">
                                #${index + 1}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="text-base font-semibold text-gray-900">${item.issue}</h4>
                                    <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">
                                        ${item.category}
                                    </span>
                                </div>
                                <div class="flex items-center space-x-4 text-sm text-gray-600 mb-2">
                                    <span class="tooltip">扣分次數: <span class="font-semibold text-gray-900">${item.count}次</span>
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">
                                            <strong>扣分次數</strong><br>
                                            該指標在所有質檢通話中被標記扣分的總次數<br>
                                            <em>範例：「${item.issue}」共被扣分 ${item.count} 次</em>
                                        </span>
                                    </span>
                                    <span>•</span>
                                    <span class="tooltip">扣分率: <span class="font-semibold text-gray-900">${item.rate}%</span>
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">
                                            <strong>扣分率</strong><br>
                                            (該指標扣分次數 ÷ 總質檢通話數) × 100%<br>
                                            <em>計算：${item.count} ÷ 700 × 100% = ${item.rate}%</em>
                                        </span>
                                    </span>
                                    <span>•</span>
                                    <span class="tooltip">影響通話: <span class="font-semibold text-gray-900">${item.affectedCalls}通</span>
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">
                                            <strong>影響通話</strong><br>
                                            該指標被扣分的音檔數量<br>
                                            <em>範例：有 ${item.affectedCalls} 通電話因此指標被扣分</em>
                                        </span>
                                    </span>
                                </div>
                                <div class="flex items-center space-x-4 text-sm text-gray-600">
                                    <span class="tooltip">總扣分: <span class="font-semibold text-orange-600">${item.totalDeduction}分</span>
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">
                                            <strong>總扣分</strong><br>
                                            該指標在所有被扣分通話中的扣分分數總和<br>
                                            <em>範例：${item.count} 次扣分的分數加總為 ${item.totalDeduction} 分</em>
                                        </span>
                                    </span>
                                    <span>•</span>
                                    <span class="tooltip">平均: <span class="font-semibold text-gray-900">${item.avgDeduction}分/次</span>
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">
                                            <strong>平均扣分</strong><br>
                                            總扣分 ÷ 扣分次數<br>
                                            <em>計算：${item.totalDeduction} ÷ ${item.count} = ${item.avgDeduction} 分/次</em>
                                        </span>
                                    </span>
                                    <span>•</span>
                                    <span class="tooltip">影響客服: <span class="font-semibold text-gray-900">${item.affectedAgents}人</span>
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">
                                            <strong>影響客服</strong><br>
                                            該指標涉及的不重複客服人員數量<br>
                                            <em>範例：${item.count} 次扣分涉及 ${item.affectedAgents} 位不同客服</em>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-1 ml-4">
                            <div class="flex items-center text-sm font-semibold ${trendColor}">
                                <i data-lucide="${trendIcon}" class="w-4 h-4 mr-1"></i>
                                ${item.changePercent > 0 ? '+' : ''}${item.changePercent}%
                            </div>
                            <span class="text-xs text-gray-500">較昨日</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 flex items-center justify-between text-xs text-gray-500">
                        <span>滿分配分: ${item.fullScore}分</span>
                        <div class="flex items-center text-blue-600">
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            <span class="ml-1 font-medium">點擊查看明細</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            safeCreateIcons();
        }

        // Populate agents table
        function populateAgentsTable() {
            const tbody = document.getElementById('agentsTable');
            tbody.innerHTML = '';
            
            agentPerformance.forEach((agent, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 cursor-pointer';
                tr.onclick = () => {
                    openAgentDetailModal(agent);
                };
                
                const rankClass = index === 0 ? 'bg-yellow-100 text-yellow-800' :
                                 index === 1 ? 'bg-gray-100 text-gray-800' :
                                 index === 2 ? 'bg-orange-100 text-orange-800' :
                                 'bg-gray-50 text-gray-600';
                
                const statusClass = agent.score >= 90 ? 'bg-green-100 text-green-800' :
                                   agent.score >= 80 ? 'bg-blue-100 text-blue-800' :
                                   'bg-yellow-100 text-yellow-800';
                
                const statusText = agent.score >= 90 ? '優秀' : 
                                  agent.score >= 80 ? '良好' : '待改善';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full font-bold ${rankClass}">
                            ${index + 1}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${agent.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-900">${agent.score}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${agent.calls}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Agent Detail Modal Functions
        function openAgentDetailModal(agent) {
            // Update modal content
            document.getElementById('modalAgentName').textContent = `${agent.name} - 質檢結果詳細分析`;
            document.getElementById('modalOverallScore').textContent = agent.score;
            
            // Generate detailed analysis data
            generateModalContent(agent);
            
            // Show modal
            document.getElementById('agentDetailModal').style.display = 'block';
        }
        
        function generateModalContent(agent) {
            // Generate metric scores (指標型)
            const metricScores = [
                { name: '話術檢測', score: Math.floor(agent.score * 0.85), items: ['禮貌性', '話術檢測', '商品說明', '產品賣點', '售後'] },
                { name: '敏感詞檢測', score: Math.floor(agent.score * 0.95), items: ['價格', '法規合規性檢查', '產品賣點'] }
            ];
            
            let metricHtml = '';
            metricScores.forEach(metric => {
                const status = metric.score >= 80 ? 'good' : metric.score >= 60 ? 'warning' : 'danger';
                const statusColor = status === 'good' ? '#10B981' : status === 'warning' ? '#F59E0B' : '#EF4444';
                const statusText = status === 'good' ? '通過' : status === 'warning' ? '不合格' : '不合格';
                
                metricHtml += `
                    <div style="border-bottom: 1px solid #E5E7EB; padding: 12px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">${metric.name}</div>
                            <div style="display: flex; flex-wrap: gap: 4px;">
                                ${metric.items.map(item => `
                                    <span style="background: #F3F4F6; color: #6B7280; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                        ${item}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        <div style="text-align: right; margin-left: 16px;">
                            <div style="color: ${statusColor}; font-weight: 600; font-size: 14px;">${statusText}</div>
                            <div style="color: ${statusColor}; font-weight: bold; font-size: 18px;">${metric.score}/100 分</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('modalMetricScores').innerHTML = metricHtml;
            
            // Generate summary scores (摘要型)
            const summaryScores = [
                { name: '準確面/問題處理', score: Math.floor(agent.score * 0.75) },
                { name: '權威面/基本應對', score: Math.floor(agent.score * 0.65) },
                { name: '整體感受', score: Math.floor(agent.score * 0.8) }
            ];
            
            let summaryHtml = '';
            summaryScores.forEach(summary => {
                const status = summary.score >= 80 ? 'good' : summary.score >= 60 ? 'warning' : 'danger';
                const statusColor = status === 'good' ? '#10B981' : status === 'warning' ? '#F59E0B' : '#EF4444';
                const statusText = status === 'good' ? '通過' : status === 'warning' ? '不合格' : '不合格';
                
                summaryHtml += `
                    <div style="border-bottom: 1px solid #E5E7EB; padding: 12px 0; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 600; color: #374151;">${summary.name}</div>
                        <div style="text-align: right;">
                            <div style="color: ${statusColor}; font-weight: 600; font-size: 14px;">${statusText}</div>
                            <div style="color: ${statusColor}; font-weight: bold; font-size: 18px;">${summary.score}/100 分</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('modalSummaryScores').innerHTML = summaryHtml;
            
            // Generate call records
            const callRecords = generateCallRecords(agent);
            let recordsHtml = '';
            callRecords.forEach(record => {
                const scoreColor = record.score >= 80 ? '#10B981' : record.score >= 60 ? '#F59E0B' : '#EF4444';
                recordsHtml += `
                    <tr style="border-bottom: 1px solid #E5E7EB;">
                        <td style="padding: 8px 12px; font-size: 14px;">${record.date}</td>
                        <td style="padding: 8px 12px; font-size: 14px;">${record.time}</td>
                        <td style="padding: 8px 12px; font-weight: 600; color: ${scoreColor};">${record.score} 分</td>
                        <td style="padding: 8px 12px; color: #6B7280;">${record.mainIssue}</td>
                        <td style="padding: 8px 12px;">
                            <button style="background: #3B82F6; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">詳細</button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('modalCallRecords').innerHTML = recordsHtml;
        }
        
        function generateCallRecords(agent) {
            const records = [];
            const today = new Date();
            
            for (let i = 0; i < 8; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                const score = Math.floor(Math.random() * 40) + 60;
                const issues = ['無', '話術檢測不佳', '敏感詞使用', '服務態度', '專業術語過多'];
                const mainIssue = score >= 85 ? '無' : issues[Math.floor(Math.random() * (issues.length - 1)) + 1];
                
                records.push({
                    date: date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }),
                    time: `${String(Math.floor(Math.random() * 10) + 8).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
                    score: score,
                    mainIssue: mainIssue
                });
            }
            
            return records;
        }
        
        function closeAgentDetailModal() {
            document.getElementById('agentDetailModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('agentDetailModal');
            if (event.target === modal) {
                closeAgentDetailModal();
            }
        });

        // Refresh data function
        function refreshData() {
            const button = event.target.closest('button');
            const icon = button.querySelector('i[data-lucide="refresh-cw"]');
            
            // Add spinning animation
            icon.style.animation = 'spin 1s linear infinite';
            button.disabled = true;
            
            // Simulate data refresh
            setTimeout(() => {
                // Update metrics with animation
                updateMetricsWithAnimation();
                
                // Refresh all charts
                Object.values(charts).forEach(chart => {
                    if (chart && chart.setOption) {
                        chart.setOption(chart.getOption(), true);
                    }
                });
                
                // Update timestamp
                updateLastUpdateTime();
                
                // Remove spinning animation
                icon.style.animation = '';
                button.disabled = false;
                
                // Show success feedback
                showNotification('數據已更新', 'success');
            }, 1500);
        }

        // Animated metrics update
        function updateMetricsWithAnimation() {
            const metrics = [
                { id: 'complianceRate', newValue: (Math.random() * 10 + 85).toFixed(1) + '%' }
            ];
            
            metrics.forEach(metric => {
                const element = document.getElementById(metric.id);
                if (element) {
                    element.style.animation = 'shimmer 0.5s ease-in-out';
                    setTimeout(() => {
                        element.textContent = metric.newValue;
                        element.style.animation = '';
                    }, 250);
                }
            });
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform translate-x-full transition-transform duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.style.transform = 'translate-x-0';
            }, 100);
            
            // Slide out and remove
            setTimeout(() => {
                notification.style.transform = 'translate-x-full';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Enhanced export report function
        function exportReport() {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>準備中...';
            button.disabled = true;
            
            setTimeout(() => {
                // Simulate export process
                const reportData = generateReportData();
                downloadReport(reportData);
                
                button.innerHTML = originalText;
                button.disabled = false;
                showNotification('報表已成功匯出', 'success');
            }, 2000);
        }

        // Generate comprehensive report data
        function generateReportData() {
            const currentDate = new Date().toLocaleDateString('zh-TW');
            return {
                title: 'SysTalk.Audit 質檢報表',
                date: currentDate,
                summary: {
                    totalCalls: '700',
                    coverage: '98%',
                    avgScore: '88',
                    complianceRate: document.getElementById('complianceRate')?.textContent || '90.6%'
                }
            };
        }

        // Download report
        function downloadReport(data) {
            const content = `
SysTalk.Audit 質檢報表
===================

生成日期: ${data.date}

總體概況:
- 質檢通話數: ${data.summary.totalCalls}
- 質檢覆蓋率: ${data.summary.coverage}
- 平均品質分數: ${data.summary.avgScore}
- 合格率: ${data.summary.complianceRate}

本報表由 SysTalk.Audit 系統自動生成
            `.trim();
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SysTalk_Audit_報表_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // === Tab狀態管理與時間篩選功能 ===
        
        // 生成時間篩選器HTML模板
        function generateTimeFilterTemplate(tabId) {
            return `
                <div class="bg-white rounded-lg shadow p-6" id="${tabId}-time-filter">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i data-lucide="clock" class="w-5 h-5 inline mr-2"></i>
                        時間查詢條件
                    </h2>
                    
                    <div class="date-filter-section">
                        <!-- Filter Tabs -->
                        <div class="mb-6">
                            <div class="flex items-center space-x-1 p-1 bg-gray-100 rounded-lg w-fit">
                                <button onclick="setTabFilterTab('${tabId}', 'custom')" 
                                        id="${tabId}-tab-custom"
                                        class="filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all bg-blue-600 text-white">
                                    自選
                                </button>
                                <button onclick="setTabFilterTab('${tabId}', 'weekly')" 
                                        id="${tabId}-tab-weekly"
                                        class="filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900">
                                    週期
                                </button>
                                <button onclick="setTabFilterTab('${tabId}', 'monthly')" 
                                        id="${tabId}-tab-monthly"
                                        class="filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900">
                                    月份
                                </button>
                                <button onclick="setTabFilterTab('${tabId}', 'quarterly')" 
                                        id="${tabId}-tab-quarterly"
                                        class="filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900">
                                    季度
                                </button>
                                <button onclick="setTabFilterTab('${tabId}', 'yearly')" 
                                        id="${tabId}-tab-yearly"
                                        class="filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900">
                                    年度
                                </button>
                            </div>
                        </div>

                        <!-- Filter Content -->
                        <div id="${tabId}-filter-content">
                            <!-- Custom Date Range (自選) -->
                            <div id="${tabId}-custom-filter" class="filter-content">
                                <div class="mb-4">
                                    <div class="flex items-center gap-4 flex-wrap">
                                        <div class="flex items-center gap-2">
                                            <input type="date" 
                                                   id="${tabId}-customStartDate" 
                                                   class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   onchange="validateTabDateRange('${tabId}')">
                                            <span class="text-gray-500 font-medium">~</span>
                                            <input type="date" 
                                                   id="${tabId}-customEndDate" 
                                                   class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   onchange="validateTabDateRange('${tabId}')">
                                        </div>
                                        <button onclick="applyTabCustomDateFilter('${tabId}')" 
                                                id="${tabId}-customQueryBtn"
                                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-all flex items-center">
                                            <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                                            查詢
                                        </button>
                                    </div>
                                    <div id="${tabId}-dateValidationMessage" class="mt-2 text-sm hidden"></div>
                                </div>
                            </div>

                            <!-- Weekly Filter -->
                            <div id="${tabId}-weekly-filter" class="filter-content hidden">
                                <div class="mb-4">
                                    <div class="flex items-center gap-3 flex-wrap">
                                        <button onclick="setTabWeeklyPeriod('${tabId}', 'thisWeek')" 
                                                id="${tabId}-weekly-this"
                                                class="weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition-all">
                                            本週
                                        </button>
                                        <button onclick="setTabWeeklyPeriod('${tabId}', 'lastWeek')" 
                                                id="${tabId}-weekly-last"
                                                class="weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            上週
                                        </button>
                                        <button onclick="setTabWeeklyPeriod('${tabId}', 'lastLastWeek')" 
                                                id="${tabId}-weekly-lastlast"
                                                class="weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            上上週
                                        </button>
                                        <button onclick="applyTabWeeklyFilter('${tabId}')" 
                                                id="${tabId}-weeklyQueryBtn"
                                                class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                            查詢
                                        </button>
                                    </div>
                                    <div id="${tabId}-weeklyDateDisplay" class="mt-4 text-sm text-gray-600">
                                        目前顯示：<span id="${tabId}-weeklyDateRange">請選擇週期</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Monthly Filter -->
                            <div id="${tabId}-monthly-filter" class="filter-content hidden">
                                <div class="mb-4">
                                    <div class="mb-4 flex items-center justify-center gap-4">
                                        <button onclick="changeTabYear('${tabId}', -1)" 
                                                class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                            </svg>
                                        </button>
                                        <input type="text" 
                                               id="${tabId}-monthlyYearInput" 
                                               value="2025" 
                                               onchange="validateAndSetTabYear('${tabId}')" 
                                               onblur="validateAndSetTabYear('${tabId}')"
                                               class="text-center text-2xl font-semibold text-blue-600 bg-transparent border-none focus:outline-none focus:ring-0 w-20">
                                        <button onclick="changeTabYear('${tabId}', 1)" 
                                                class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <div class="grid grid-cols-6 gap-3 mb-4">
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 1)" id="${tabId}-monthly-1" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">1月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 2)" id="${tabId}-monthly-2" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">2月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 3)" id="${tabId}-monthly-3" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">3月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 4)" id="${tabId}-monthly-4" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">4月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 5)" id="${tabId}-monthly-5" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">5月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 6)" id="${tabId}-monthly-6" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">6月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 7)" id="${tabId}-monthly-7" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">7月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 8)" id="${tabId}-monthly-8" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">8月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 9)" id="${tabId}-monthly-9" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">9月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 10)" id="${tabId}-monthly-10" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">10月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 11)" id="${tabId}-monthly-11" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">11月</button>
                                        <button onclick="setTabMonthlyPeriod('${tabId}', 12)" id="${tabId}-monthly-12" class="monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">12月</button>
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button onclick="applyTabMonthlyFilter('${tabId}')" 
                                                id="${tabId}-monthlyQueryBtn"
                                                class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                            查詢
                                        </button>
                                    </div>
                                    
                                    <div id="${tabId}-monthlyDateDisplay" class="mt-4 text-sm text-gray-600">
                                        目前顯示：<span id="${tabId}-monthlyDateRange">請選擇月份</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quarterly Filter -->
                            <div id="${tabId}-quarterly-filter" class="filter-content hidden">
                                <div class="mb-4">
                                    <div class="mb-4 flex items-center gap-3">
                                        <label class="text-sm font-medium text-gray-700">選擇年度：</label>
                                        <select id="${tabId}-quarterlyYearSelector" onchange="changeTabQuarterlyYear('${tabId}')" 
                                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        </select>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 flex-wrap mb-4">
                                        <button onclick="setTabQuarterlyPeriod('${tabId}', 1)" 
                                                id="${tabId}-quarterly-q1"
                                                class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            Q1
                                        </button>
                                        <button onclick="setTabQuarterlyPeriod('${tabId}', 2)" 
                                                id="${tabId}-quarterly-q2"
                                                class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            Q2
                                        </button>
                                        <button onclick="setTabQuarterlyPeriod('${tabId}', 3)" 
                                                id="${tabId}-quarterly-q3"
                                                class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            Q3
                                        </button>
                                        <button onclick="setTabQuarterlyPeriod('${tabId}', 4)" 
                                                id="${tabId}-quarterly-q4"
                                                class="quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all">
                                            Q4
                                        </button>
                                        <button onclick="applyTabQuarterlyFilter('${tabId}')" 
                                                id="${tabId}-quarterlyQueryBtn"
                                                class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                            查詢
                                        </button>
                                    </div>
                                    
                                    <div id="${tabId}-quarterlyDateDisplay" class="mt-4 text-sm text-gray-600">
                                        目前顯示：<span id="${tabId}-quarterlyDateRange">請選擇季度</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Yearly Filter -->
                            <div id="${tabId}-yearly-filter" class="filter-content hidden">
                                <div class="mb-4">
                                    <div class="mb-4 flex items-center gap-3">
                                        <select id="${tabId}-yearlyYearSelector" onchange="setTabYearlySelection('${tabId}')" 
                                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                        </select>
                                        <button onclick="applyTabYearlyFilter('${tabId}')" 
                                                id="${tabId}-yearlyQueryBtn"
                                                class="px-6 py-3 text-sm font-medium rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                            查詢
                                        </button>
                                    </div>
                                    
                                    <div id="${tabId}-yearlyDateDisplay" class="mt-4 text-sm text-gray-600">
                                        目前顯示：<span id="${tabId}-yearlyDateRange">請選擇年度</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 切換Tab時同步篩選狀態
        function switchTab(newTab) {
            if (activeTab !== newTab) {
                currentFilterState = tabFilterStates[newTab];
                activeTab = newTab;
            }
        }
        
        // === Tab特定的時間篩選功能 ===
        
        // Tab特定的篩選標籤設定
        function setTabFilterTab(tabId, tabType) {
            const tabs = ['custom', 'weekly', 'monthly', 'quarterly', 'yearly'];
            const tabState = tabFilterStates[tabId];
            
            tabs.forEach(tab => {
                const tabElement = document.getElementById(`${tabId}-tab-${tab}`);
                const contentElement = document.getElementById(`${tabId}-${tab}-filter`);
                
                if (tab === tabType) {
                    tabElement.className = 'filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all bg-blue-600 text-white';
                    contentElement.classList.remove('hidden');
                } else {
                    tabElement.className = 'filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900';
                    contentElement.classList.add('hidden');
                }
            });

            tabState.type = tabType;

            if (tabType === 'custom') {
                initializeTabDateLimits(tabId);
            }
            if (tabType === 'monthly') {
                initTabMonthlyFilter(tabId);
            }
            if (tabType === 'quarterly') {
                initTabQuarterlyFilter(tabId);
            }
            if (tabType === 'yearly') {
                initTabYearlyFilter(tabId);
            }
        }

        // Tab特定的日期限制初始化
        function initializeTabDateLimits(tabId) {
            const today = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(today.getFullYear() - 5);
            
            const startInput = document.getElementById(`${tabId}-customStartDate`);
            const endInput = document.getElementById(`${tabId}-customEndDate`);
            
            if (startInput && endInput) {
                startInput.max = today.toISOString().split('T')[0];
                startInput.min = fiveYearsAgo.toISOString().split('T')[0];
                endInput.max = today.toISOString().split('T')[0];
                endInput.min = fiveYearsAgo.toISOString().split('T')[0];
            }
        }

        // Tab特定的日期範圍驗證
        function validateTabDateRange(tabId) {
            const startInput = document.getElementById(`${tabId}-customStartDate`);
            const endInput = document.getElementById(`${tabId}-customEndDate`);
            const messageElement = document.getElementById(`${tabId}-dateValidationMessage`);
            const queryBtn = document.getElementById(`${tabId}-customQueryBtn`);
            
            if (!startInput || !endInput || !messageElement || !queryBtn) return true;
            
            const startDate = startInput.value;
            const endDate = endInput.value;
            
            if (!startDate || !endDate) {
                hideTabMessage(tabId);
                queryBtn.disabled = false;
                return true;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(today.getFullYear() - 5);
            
            if (start > end) {
                showTabMessage(tabId, '開始日期不能晚於結束日期', 'error');
                queryBtn.disabled = true;
                return false;
            }
            
            if (start < fiveYearsAgo || end > today) {
                showTabMessage(tabId, '查詢範圍僅限近五年內的資料', 'error');
                queryBtn.disabled = true;
                return false;
            }
            
            hideTabMessage(tabId);
            queryBtn.disabled = false;
            return true;
        }

        // Tab特定的訊息顯示
        function showTabMessage(tabId, message, type) {
            const messageElement = document.getElementById(`${tabId}-dateValidationMessage`);
            if (!messageElement) return;
            
            const colorClasses = {
                'error': 'text-red-600 bg-red-50 border border-red-200',
                'warning': 'text-yellow-600 bg-yellow-50 border border-yellow-200',
                'info': 'text-blue-600 bg-blue-50 border border-blue-200'
            };
            
            messageElement.textContent = message;
            messageElement.className = `mt-2 text-sm px-3 py-2 rounded ${colorClasses[type] || colorClasses.info}`;
            messageElement.classList.remove('hidden');
        }

        // Tab特定的訊息隱藏
        function hideTabMessage(tabId) {
            const messageElement = document.getElementById(`${tabId}-dateValidationMessage`);
            if (messageElement) {
                messageElement.classList.add('hidden');
            }
        }

        // Tab特定的自選日期篩選
        function applyTabCustomDateFilter(tabId) {
            if (!validateTabDateRange(tabId)) return;
            
            const startInput = document.getElementById(`${tabId}-customStartDate`);
            const endInput = document.getElementById(`${tabId}-customEndDate`);
            
            if (!startInput || !endInput) return;
            
            const startDate = startInput.value;
            const endDate = endInput.value;
            
            if (!startDate || !endDate) {
                showTabMessage(tabId, '請選擇完整的日期範圍', 'warning');
                return;
            }
            
            const tabState = tabFilterStates[tabId];
            tabState.startDate = startDate;
            tabState.endDate = endDate;
            tabState.type = 'custom';
            
            showTabMessage(tabId, '篩選條件已套用', 'info');
            console.log(`${tabId} Tab 自選日期篩選:`, startDate, '~', endDate);
        }

        // Tab特定的週期篩選功能（簡化版）
        function setTabWeeklyPeriod(tabId, period) {
            // 重置所有週期按鈕樣式
            ['thisWeek', 'lastWeek', 'lastLastWeek'].forEach(p => {
                const btn = document.getElementById(`${tabId}-weekly-${p.replace('Week', '').replace('thisW', 'this').replace('lastLastW', 'lastlast').replace('lastW', 'last')}`);
                if (btn) {
                    btn.className = 'weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all';
                }
            });
            
            // 設定選中的按鈕樣式
            const selectedBtn = document.getElementById(`${tabId}-weekly-${period.replace('Week', '').replace('thisW', 'this').replace('lastLastW', 'lastlast').replace('lastW', 'last')}`);
            if (selectedBtn) {
                selectedBtn.className = 'weekly-period-btn px-6 py-3 text-sm font-medium rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition-all';
            }
            
            tabFilterStates[tabId].selectedWeek = period;
        }

        function applyTabWeeklyFilter(tabId) {
            const tabState = tabFilterStates[tabId];
            if (!tabState.selectedWeek) return;
            
            tabState.type = 'weekly';
            console.log(`${tabId} Tab 週期篩選:`, tabState.selectedWeek);
        }

        // Tab特定的月份篩選功能（簡化版）
        function initTabMonthlyFilter(tabId) {
            const yearInput = document.getElementById(`${tabId}-monthlyYearInput`);
            if (yearInput) {
                yearInput.value = '2025';
            }
        }

        function setTabMonthlyPeriod(tabId, month) {
            // 重置所有月份按鈕
            for (let i = 1; i <= 12; i++) {
                const btn = document.getElementById(`${tabId}-monthly-${i}`);
                if (btn) {
                    btn.className = 'monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all';
                }
            }
            
            // 設定選中的月份
            const selectedBtn = document.getElementById(`${tabId}-monthly-${month}`);
            if (selectedBtn) {
                selectedBtn.className = 'monthly-btn px-4 py-3 text-sm font-medium rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition-all';
            }
            
            tabFilterStates[tabId].selectedMonth = month;
        }

        function changeTabYear(tabId, direction) {
            const yearInput = document.getElementById(`${tabId}-monthlyYearInput`);
            if (yearInput) {
                let currentYear = parseInt(yearInput.value) || 2025;
                yearInput.value = currentYear + direction;
            }
        }

        function validateAndSetTabYear(tabId) {
            const yearInput = document.getElementById(`${tabId}-monthlyYearInput`);
            if (yearInput) {
                let year = parseInt(yearInput.value);
                if (isNaN(year) || year < 2020 || year > 2030) {
                    yearInput.value = '2025';
                }
            }
        }

        function applyTabMonthlyFilter(tabId) {
            const tabState = tabFilterStates[tabId];
            const yearInput = document.getElementById(`${tabId}-monthlyYearInput`);
            
            if (!tabState.selectedMonth || !yearInput) return;
            
            tabState.type = 'monthly';
            tabState.selectedYear = yearInput.value;
            console.log(`${tabId} Tab 月份篩選:`, tabState.selectedYear, '年', tabState.selectedMonth, '月');
        }

        // Tab特定的季度篩選功能（簡化版）
        function initTabQuarterlyFilter(tabId) {
            const yearSelector = document.getElementById(`${tabId}-quarterlyYearSelector`);
            if (yearSelector) {
                yearSelector.innerHTML = '';
                for (let year = 2025; year >= 2020; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === 2025) option.selected = true;
                    yearSelector.appendChild(option);
                }
            }
        }

        function setTabQuarterlyPeriod(tabId, quarter) {
            // 重置所有季度按鈕
            [1, 2, 3, 4].forEach(q => {
                const btn = document.getElementById(`${tabId}-quarterly-q${q}`);
                if (btn) {
                    btn.className = 'quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition-all';
                }
            });
            
            // 設定選中的季度
            const selectedBtn = document.getElementById(`${tabId}-quarterly-q${quarter}`);
            if (selectedBtn) {
                selectedBtn.className = 'quarterly-btn px-6 py-3 text-sm font-medium rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 transition-all';
            }
            
            tabFilterStates[tabId].selectedQuarter = quarter;
        }

        function changeTabQuarterlyYear(tabId) {
            // 年份變更邏輯
        }

        function applyTabQuarterlyFilter(tabId) {
            const tabState = tabFilterStates[tabId];
            const yearSelector = document.getElementById(`${tabId}-quarterlyYearSelector`);
            
            if (!tabState.selectedQuarter || !yearSelector) return;
            
            tabState.type = 'quarterly';
            tabState.selectedYear = yearSelector.value;
            console.log(`${tabId} Tab 季度篩選:`, tabState.selectedYear, '年 Q', tabState.selectedQuarter);
        }

        // Tab特定的年度篩選功能（簡化版）
        function initTabYearlyFilter(tabId) {
            const yearSelector = document.getElementById(`${tabId}-yearlyYearSelector`);
            if (yearSelector) {
                yearSelector.innerHTML = '';
                for (let year = 2025; year >= 2020; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === 2025) option.selected = true;
                    yearSelector.appendChild(option);
                }
            }
        }

        function setTabYearlySelection(tabId) {
            const yearSelector = document.getElementById(`${tabId}-yearlyYearSelector`);
            if (yearSelector) {
                tabFilterStates[tabId].selectedYear = yearSelector.value;
            }
        }

        function applyTabYearlyFilter(tabId) {
            const tabState = tabFilterStates[tabId];
            const yearSelector = document.getElementById(`${tabId}-yearlyYearSelector`);
            
            if (!yearSelector) return;
            
            tabState.type = 'yearly';
            tabState.selectedYear = yearSelector.value;
            console.log(`${tabId} Tab 年度篩選:`, tabState.selectedYear, '年');
        }

        // === 原有的時間篩選功能（保持向後兼容） ===

        // 設定篩選標籤
        function setFilterTab(tabType) {
            // 清除所有標籤的活躍狀態
            const tabs = ['custom', 'weekly', 'monthly', 'quarterly', 'yearly'];
            tabs.forEach(tab => {
                const tabElement = document.getElementById(`tab-${tab}`);
                const contentElement = document.getElementById(`${tab}-filter`);
                
                if (tab === tabType) {
                    tabElement.className = 'filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all bg-blue-600 text-white';
                    contentElement.classList.remove('hidden');
                } else {
                    tabElement.className = 'filter-tab px-4 py-2 text-sm font-medium rounded-md transition-all text-gray-600 hover:text-gray-900';
                    contentElement.classList.add('hidden');
                }
            });

            // 如果切換到自選標籤，初始化日期限制
            if (tabType === 'custom') {
                initializeDateLimits();
            }
            
            // 如果切換到月份標籤，初始化月份篩選器
            if (tabType === 'monthly') {
                initMonthlyFilter();
            }
            
            // 如果切換到季度標籤，初始化季度篩選器
            if (tabType === 'quarterly') {
                initQuarterlyFilter();
            }
            
            // 如果切換到年度標籤，初始化年度篩選器
            if (tabType === 'yearly') {
                initYearlyFilter();
            }
        }

        // 初始化日期限制（五年內）
        function initializeDateLimits() {
            const today = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(today.getFullYear() - 5);
            
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');
            
            // 設定最小和最大日期
            startInput.min = formatDateForInput(fiveYearsAgo);
            startInput.max = formatDateForInput(today);
            endInput.min = formatDateForInput(fiveYearsAgo);
            endInput.max = formatDateForInput(today);
            
            // 設定預設值（本月）
            if (!startInput.value) {
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                startInput.value = formatDateForInput(startOfMonth);
                endInput.value = formatDateForInput(endOfMonth);
            }
        }

        // 驗證日期範圍
        function validateDateRange() {
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;
            const messageElement = document.getElementById('dateValidationMessage');
            const queryBtn = document.getElementById('customQueryBtn');
            
            if (!startDate || !endDate) {
                showMessage('請選擇完整的日期範圍', 'warning');
                queryBtn.disabled = true;
                return false;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(today.getFullYear() - 5);
            
            // 檢查日期順序
            if (start > end) {
                showMessage('開始日期不能晚於結束日期', 'error');
                queryBtn.disabled = true;
                return false;
            }
            
            // 檢查日期範圍（五年內）
            if (start < fiveYearsAgo || end > today) {
                showMessage('查詢範圍僅限近五年內的資料', 'error');
                queryBtn.disabled = true;
                return false;
            }
            
            // 檢查時間跨度（不超過五年）
            const timeDiff = end.getTime() - start.getTime();
            const fiveYears = 5 * 365 * 24 * 60 * 60 * 1000; // 5年的毫秒數
            if (timeDiff > fiveYears) {
                showMessage('查詢時間跨度不得超過五年', 'error');
                queryBtn.disabled = true;
                return false;
            }
            
            // 通過驗證
            hideMessage();
            queryBtn.disabled = false;
            return true;
        }

        // 顯示驗證訊息
        function showMessage(message, type) {
            const messageElement = document.getElementById('dateValidationMessage');
            const colorClasses = {
                'error': 'text-red-600 bg-red-50 border border-red-200',
                'warning': 'text-yellow-600 bg-yellow-50 border border-yellow-200',
                'info': 'text-blue-600 bg-blue-50 border border-blue-200'
            };
            
            messageElement.textContent = message;
            messageElement.className = `mt-2 text-sm px-3 py-2 rounded ${colorClasses[type] || colorClasses.info}`;
            messageElement.classList.remove('hidden');
        }

        // 隱藏驗證訊息
        function hideMessage() {
            const messageElement = document.getElementById('dateValidationMessage');
            messageElement.classList.add('hidden');
        }

        // 套用自選日期篩選
        function applyCustomDateFilter() {
            if (!validateDateRange()) {
                return;
            }
            
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;
            
            // 套用篩選並更新顯示
            applyFilter(startDate, endDate, 'custom');
        }

        // === 週期篩選功能 ===
        let selectedWeeklyPeriod = null;

        // 設定週期選擇
        function setWeeklyPeriod(period) {
            selectedWeeklyPeriod = period;
            
            // 清除其他按鈕的選中狀態
            const weeklyBtns = document.querySelectorAll('.weekly-period-btn');
            weeklyBtns.forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50');
                btn.classList.add('border-gray-300', 'text-gray-600');
            });
            
            // 設定當前按鈕為選中狀態
            let btnId = '';
            switch(period) {
                case 'thisWeek':
                    btnId = 'weekly-this';
                    break;
                case 'lastWeek':
                    btnId = 'weekly-last';
                    break;
                case 'lastLastWeek':
                    btnId = 'weekly-lastlast';
                    break;
            }
            
            const currentBtn = document.getElementById(btnId);
            if (currentBtn) {
                currentBtn.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
                currentBtn.classList.remove('border-gray-300', 'text-gray-600');
            }
            
            // 計算並顯示日期範圍
            const dateRange = calculateWeekRange(period);
            updateWeeklyDateDisplay(dateRange);
        }

        // 計算週期日期範圍
        function calculateWeekRange(period) {
            const today = new Date();
            const currentDay = today.getDay(); // 0=週日, 1=週一, ..., 6=週六
            
            // 計算本週一的日期
            const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
            const thisMonday = new Date(today);
            thisMonday.setDate(today.getDate() + mondayOffset);
            
            let startDate, endDate;
            
            switch(period) {
                case 'thisWeek':
                    startDate = new Date(thisMonday);
                    endDate = new Date(thisMonday);
                    endDate.setDate(thisMonday.getDate() + 6); // 週日
                    break;
                    
                case 'lastWeek':
                    startDate = new Date(thisMonday);
                    startDate.setDate(thisMonday.getDate() - 7); // 上週一
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // 上週日
                    break;
                    
                case 'lastLastWeek':
                    startDate = new Date(thisMonday);
                    startDate.setDate(thisMonday.getDate() - 14); // 上上週一
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // 上上週日
                    break;
                    
                default:
                    return null;
            }
            
            return {
                start: startDate,
                end: endDate,
                startStr: formatDate(startDate),
                endStr: formatDate(endDate)
            };
        }

        // 格式化日期為 YYYY/MM/DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // 更新週期日期顯示
        function updateWeeklyDateDisplay(dateRange) {
            if (!dateRange) {
                document.getElementById('weeklyDateRange').textContent = '請選擇週期';
                return;
            }
            
            const displayText = `${dateRange.startStr} ~ ${dateRange.endStr}`;
            document.getElementById('weeklyDateRange').textContent = displayText;
        }

        // 套用週期篩選
        function applyWeeklyFilter() {
            if (!selectedWeeklyPeriod) {
                showMessage('請先選擇週期', 'warning');
                return;
            }
            
            const dateRange = calculateWeekRange(selectedWeeklyPeriod);
            if (!dateRange) {
                showMessage('日期範圍計算錯誤', 'error');
                return;
            }
            
            // 轉換為 YYYY-MM-DD 格式供系統使用
            const startDate = dateRange.start.toISOString().split('T')[0];
            const endDate = dateRange.end.toISOString().split('T')[0];
            
            // 套用篩選並更新顯示
            applyFilter(startDate, endDate, 'weekly');
            showMessage(`已套用 ${getPeriodName(selectedWeeklyPeriod)} 篩選條件`, 'info');
        }

        // 取得週期名稱
        function getPeriodName(period) {
            const names = {
                'thisWeek': '本週',
                'lastWeek': '上週',
                'lastLastWeek': '上上週'
            };
            return names[period] || period;
        }

        // === 月份篩選功能 ===
        let selectedMonth = null;
        let selectedYear = null;

        // 初始化月份篩選器
        function initMonthlyFilter() {
            const today = new Date();
            selectedYear = today.getFullYear();
            
            // 初始化年份輸入框
            document.getElementById('monthlyYearInput').value = selectedYear;
            
            // 更新月份按鈕狀態
            updateMonthlyButtonStates();
        }

        // 左右箭頭切換年份
        function changeYear(direction) {
            const yearInput = document.getElementById('monthlyYearInput');
            const currentYear = parseInt(yearInput.value) || new Date().getFullYear();
            const newYear = currentYear + direction;
            
            // 檢查年份限制（5年內）
            const today = new Date();
            const minYear = today.getFullYear() - 4;
            const maxYear = today.getFullYear();
            
            if (newYear < minYear || newYear > maxYear) {
                showMessage(`年份範圍限制在 ${minYear} - ${maxYear} 年內`, 'warning');
                return;
            }
            
            selectedYear = newYear;
            yearInput.value = newYear;
            selectedMonth = null; // 重置月份選擇
            
            // 更新月份按鈕狀態
            updateMonthlyButtonStates();
            
            // 重置日期顯示
            document.getElementById('monthlyDateRange').textContent = '請選擇月份';
        }

        // 驗證並設定年份
        function validateAndSetYear() {
            const yearInput = document.getElementById('monthlyYearInput');
            const inputYear = parseInt(yearInput.value);
            const today = new Date();
            const minYear = today.getFullYear() - 4;
            const maxYear = today.getFullYear();
            
            // 檢查是否為有效數字
            if (isNaN(inputYear)) {
                showMessage('請輸入有效的年份', 'error');
                yearInput.value = selectedYear; // 恢復原值
                return;
            }
            
            // 檢查年份範圍
            if (inputYear < minYear || inputYear > maxYear) {
                showMessage(`年份範圍限制在 ${minYear} - ${maxYear} 年內`, 'warning');
                yearInput.value = selectedYear; // 恢復原值
                return;
            }
            
            selectedYear = inputYear;
            selectedMonth = null; // 重置月份選擇
            
            // 更新月份按鈕狀態
            updateMonthlyButtonStates();
            
            // 重置日期顯示
            document.getElementById('monthlyDateRange').textContent = '請選擇月份';
        }

        // 更新月份按鈕狀態
        function updateMonthlyButtonStates() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1; // JavaScript月份是0-11，轉換為1-12
            
            for (let month = 1; month <= 12; month++) {
                const btn = document.getElementById(`monthly-${month}`);
                if (btn) {
                    // 重置按鈕樣式
                    btn.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50', 'opacity-50', 'cursor-not-allowed');
                    btn.classList.add('border-gray-300', 'text-gray-600', 'hover:bg-gray-50');
                    btn.disabled = false;
                    
                    // 只有當選擇的年份是當前年份時，才禁用未來月份
                    if (selectedYear === currentYear && month > currentMonth) {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        btn.classList.remove('hover:bg-gray-50');
                        btn.disabled = true;
                    }
                    
                    // 如果是選中的月份，高亮顯示
                    if (selectedMonth === month) {
                        btn.classList.remove('border-gray-300', 'text-gray-600');
                        btn.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
                        
                        // 如果選中的是禁用的月份，恢復禁用樣式
                        if (btn.disabled) {
                            btn.classList.add('opacity-50');
                        }
                    }
                }
            }
        }

        // 設定月份選擇
        function setMonthlyPeriod(month) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            
            // 檢查是否選擇未來月份
            if (selectedYear === currentYear && month > currentMonth) {
                showMessage('無法選擇尚未到達的月份', 'warning');
                return;
            }
            
            selectedMonth = month;
            
            // 更新按鈕狀態
            updateMonthlyButtonStates();
            
            // 計算並顯示日期範圍
            const dateRange = calculateMonthRange(selectedYear, month);
            updateMonthlyDateDisplay(dateRange, month);
        }

        // 計算月份日期範圍
        function calculateMonthRange(year, month) {
            const startDate = new Date(year, month - 1, 1); // 月份的第一天
            const endDate = new Date(year, month, 0); // 月份的最後一天
            
            return {
                start: startDate,
                end: endDate,
                startStr: formatDate(startDate),
                endStr: formatDate(endDate)
            };
        }

        // 更新月份日期顯示
        function updateMonthlyDateDisplay(dateRange, month) {
            if (!dateRange) {
                document.getElementById('monthlyDateRange').textContent = '請選擇月份';
                return;
            }
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const currentDate = today.getDate();
            
            let displayText = `${dateRange.startStr} ~ ${dateRange.endStr}`;
            
            // 如果是當前月份，顯示截至目前的資料說明
            if (selectedYear === currentYear && month === currentMonth) {
                const todayStr = formatDate(today);
                displayText = `${dateRange.startStr} ~ ${todayStr} (截至目前已產出資料)`;
            }
            
            document.getElementById('monthlyDateRange').textContent = displayText;
        }

        // 套用月份篩選
        function applyMonthlyFilter() {
            if (!selectedMonth) {
                showMessage('請先選擇月份', 'warning');
                return;
            }
            
            const dateRange = calculateMonthRange(selectedYear, selectedMonth);
            if (!dateRange) {
                showMessage('日期範圍計算錯誤', 'error');
                return;
            }
            
            // 轉換為 YYYY-MM-DD 格式供系統使用
            const startDate = dateRange.start.toISOString().split('T')[0];
            const endDate = dateRange.end.toISOString().split('T')[0];
            
            // 套用篩選並更新顯示
            applyFilter(startDate, endDate, 'monthly');
            showMessage(`已套用 ${selectedYear}年${selectedMonth}月 篩選條件`, 'info');
        }

        // === 季度篩選功能 ===
        let selectedQuarter = null;
        let selectedQuarterlyYear = null;

        // 初始化季度篩選器
        function initQuarterlyFilter() {
            const today = new Date();
            selectedQuarterlyYear = today.getFullYear();
            
            // 初始化年份選擇器
            initQuarterlyYearSelector();
            
            // 更新季度按鈕狀態
            updateQuarterlyButtonStates();
        }

        // 初始化季度年份選擇器
        function initQuarterlyYearSelector() {
            const yearSelector = document.getElementById('quarterlyYearSelector');
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // 清空現有選項
            yearSelector.innerHTML = '';
            
            // 生成近5年的年份選項
            for (let year = currentYear; year >= currentYear - 4; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}年`;
                option.selected = (year === selectedQuarterlyYear);
                yearSelector.appendChild(option);
            }
        }

        // 切換季度年份
        function changeQuarterlyYear() {
            const yearSelector = document.getElementById('quarterlyYearSelector');
            selectedQuarterlyYear = parseInt(yearSelector.value);
            selectedQuarter = null; // 重置季度選擇
            
            // 更新季度按鈕狀態
            updateQuarterlyButtonStates();
            
            // 重置日期顯示
            document.getElementById('quarterlyDateRange').textContent = '請選擇季度';
        }

        // 更新季度按鈕狀態
        function updateQuarterlyButtonStates() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentQuarter = Math.floor((today.getMonth() + 3) / 3); // 計算當前季度
            
            for (let quarter = 1; quarter <= 4; quarter++) {
                const btn = document.getElementById(`quarterly-q${quarter}`);
                if (btn) {
                    // 重置按鈕樣式
                    btn.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50', 'opacity-50', 'cursor-not-allowed');
                    btn.classList.add('border-gray-300', 'text-gray-600', 'hover:bg-gray-50');
                    btn.disabled = false;
                    
                    // 只有當選擇的年份是當前年份時，才禁用未來季度
                    if (selectedQuarterlyYear === currentYear && quarter > currentQuarter) {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        btn.classList.remove('hover:bg-gray-50');
                        btn.disabled = true;
                    }
                    
                    // 如果是選中的季度，高亮顯示
                    if (selectedQuarter === quarter) {
                        btn.classList.remove('border-gray-300', 'text-gray-600');
                        btn.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
                        
                        // 如果選中的是禁用的季度，恢復禁用樣式
                        if (btn.disabled) {
                            btn.classList.add('opacity-50');
                        }
                    }
                }
            }
        }

        // 設定季度選擇
        function setQuarterlyPeriod(quarter) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentQuarter = Math.floor((today.getMonth() + 3) / 3);
            
            // 檢查是否選擇未來季度
            if (selectedQuarterlyYear === currentYear && quarter > currentQuarter) {
                showMessage('無法選擇尚未到達的季度', 'warning');
                return;
            }
            
            selectedQuarter = quarter;
            
            // 更新按鈕狀態
            updateQuarterlyButtonStates();
            
            // 計算並顯示日期範圍
            const dateRange = calculateQuarterRange(selectedQuarterlyYear, quarter);
            updateQuarterlyDateDisplay(dateRange, quarter);
        }

        // 計算季度日期範圍
        function calculateQuarterRange(year, quarter) {
            const startMonth = (quarter - 1) * 3; // 季度起始月份 (0-based)
            const startDate = new Date(year, startMonth, 1); // 季度第一天
            const endDate = new Date(year, startMonth + 3, 0); // 季度最後一天
            
            return {
                start: startDate,
                end: endDate,
                startStr: formatDate(startDate),
                endStr: formatDate(endDate)
            };
        }

        // 更新季度日期顯示
        function updateQuarterlyDateDisplay(dateRange, quarter) {
            if (!dateRange) {
                document.getElementById('quarterlyDateRange').textContent = '請選擇季度';
                return;
            }
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentQuarter = Math.floor((today.getMonth() + 3) / 3);
            
            let displayText = `${dateRange.startStr} ~ ${dateRange.endStr}`;
            
            // 如果是當前季度，顯示截至目前的資料說明
            if (selectedQuarterlyYear === currentYear && quarter === currentQuarter) {
                const todayStr = formatDate(today);
                displayText = `${dateRange.startStr} ~ ${todayStr} (截至目前已產出資料)`;
            }
            
            document.getElementById('quarterlyDateRange').textContent = displayText;
        }

        // 套用季度篩選
        function applyQuarterlyFilter() {
            if (!selectedQuarter) {
                showMessage('請先選擇季度', 'warning');
                return;
            }
            
            const dateRange = calculateQuarterRange(selectedQuarterlyYear, selectedQuarter);
            if (!dateRange) {
                showMessage('日期範圍計算錯誤', 'error');
                return;
            }
            
            // 轉換為 YYYY-MM-DD 格式供系統使用
            const startDate = dateRange.start.toISOString().split('T')[0];
            const endDate = dateRange.end.toISOString().split('T')[0];
            
            // 套用篩選並更新顯示
            applyFilter(startDate, endDate, 'quarterly');
            showMessage(`已套用 ${selectedQuarterlyYear}年Q${selectedQuarter} 篩選條件`, 'info');
        }

        // === 年度篩選功能 ===
        let selectedYearlyYear = null;

        // 初始化年度篩選器
        function initYearlyFilter() {
            const today = new Date();
            selectedYearlyYear = today.getFullYear();
            
            // 初始化年份選擇器
            initYearlyYearSelector();
            
            // 更新日期顯示
            updateYearlyDateDisplay();
        }

        // 初始化年度年份選擇器
        function initYearlyYearSelector() {
            const yearSelector = document.getElementById('yearlyYearSelector');
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // 清空現有選項
            yearSelector.innerHTML = '';
            
            // 添加預設選項
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '請選擇年度';
            defaultOption.selected = true;
            yearSelector.appendChild(defaultOption);
            
            // 生成近5年的年份選項
            for (let year = currentYear; year >= currentYear - 4; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}年`;
                yearSelector.appendChild(option);
            }
        }

        // 設定年度選擇
        function setYearlySelection() {
            const yearSelector = document.getElementById('yearlyYearSelector');
            const selectedValue = yearSelector.value;
            
            if (selectedValue === '') {
                selectedYearlyYear = null;
                document.getElementById('yearlyDateRange').textContent = '請選擇年度';
                return;
            }
            
            selectedYearlyYear = parseInt(selectedValue);
            updateYearlyDateDisplay();
        }

        // 計算年度日期範圍
        function calculateYearRange(year) {
            const startDate = new Date(year, 0, 1); // 年度第一天 (1月1日)
            const endDate = new Date(year, 11, 31); // 年度最後一天 (12月31日)
            
            return {
                start: startDate,
                end: endDate,
                startStr: formatDate(startDate),
                endStr: formatDate(endDate)
            };
        }

        // 更新年度日期顯示
        function updateYearlyDateDisplay() {
            if (!selectedYearlyYear) {
                document.getElementById('yearlyDateRange').textContent = '請選擇年度';
                return;
            }
            
            const dateRange = calculateYearRange(selectedYearlyYear);
            const today = new Date();
            const currentYear = today.getFullYear();
            
            let displayText = `${dateRange.startStr} ~ ${dateRange.endStr}`;
            
            // 如果是當前年度，顯示截至目前的資料說明
            if (selectedYearlyYear === currentYear) {
                const todayStr = formatDate(today);
                displayText = `${dateRange.startStr} ~ ${todayStr} (截至目前已產出資料)`;
            }
            
            document.getElementById('yearlyDateRange').textContent = displayText;
        }

        // 套用年度篩選
        function applyYearlyFilter() {
            if (!selectedYearlyYear) {
                showMessage('請先選擇年度', 'warning');
                return;
            }
            
            const dateRange = calculateYearRange(selectedYearlyYear);
            if (!dateRange) {
                showMessage('日期範圍計算錯誤', 'error');
                return;
            }
            
            // 轉換為 YYYY-MM-DD 格式供系統使用
            const startDate = dateRange.start.toISOString().split('T')[0];
            const endDate = dateRange.end.toISOString().split('T')[0];
            
            // 套用篩選並更新顯示
            applyFilter(startDate, endDate, 'yearly');
            showMessage(`已套用 ${selectedYearlyYear}年度 篩選條件`, 'info');
        }

        // 套用自定義日期篩選
        function applyDateFilter() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('請選擇完整的日期範圍', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('開始日期不能晚於結束日期', 'error');
                return;
            }

            // 清除快速篩選按鈕的選中狀態
            clearQuickFilterActiveState();
            
            // 套用篩選並更新顯示
            applyFilter(startDate, endDate);
        }

        // 快速篩選設定
        function setQuickFilter(period) {
            const today = new Date();
            let startDate, endDate;
            
            // 清除之前的選中狀態
            clearQuickFilterActiveState();
            
            // 設定當前按鈕為選中狀態
            event.target.classList.add('bg-blue-500', 'text-white');
            event.target.classList.remove('bg-gray-100', 'text-gray-700');

            switch(period) {
                case 'thisWeek':
                    const dayOfWeek = today.getDay();
                    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() + mondayOffset);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                    
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case 'q1':
                case 'q2':
                case 'q3':
                case 'q4':
                    const currentYear = today.getFullYear();
                    const quarterNum = parseInt(period.substring(1));
                    const quarterStartMonth = (quarterNum - 1) * 3;
                    startDate = new Date(currentYear, quarterStartMonth, 1);
                    endDate = new Date(currentYear, quarterStartMonth + 3, 0);
                    break;
                    
                case 'thisYear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                    
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                    
                default:
                    return;
            }

            // 更新日期選擇器
            document.getElementById('startDate').value = formatDateForInput(startDate);
            document.getElementById('endDate').value = formatDateForInput(endDate);
            
            // 套用篩選
            applyFilter(formatDateForInput(startDate), formatDateForInput(endDate));
        }

        // 清除快速篩選按鈕的選中狀態
        function clearQuickFilterActiveState() {
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'quarter-btn-active');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // 重設季度按鈕文字
            const quarterBtnText = document.getElementById('quarterBtnText');
            if (quarterBtnText) {
                quarterBtnText.textContent = '季度';
            }
        }

        // 重設篩選條件
        function resetFilter() {
            // 重設為本月
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = formatDateForInput(startDate);
            document.getElementById('endDate').value = formatDateForInput(endDate);
            
            // 清除選中狀態
            clearQuickFilterActiveState();
            
            // 套用預設篩選
            applyFilter(formatDateForInput(startDate), formatDateForInput(endDate));
            
            showNotification('已重設為本月範圍', 'info');
        }

        // 套用篩選並更新數據
        function applyFilter(startDate, endDate) {
            // 顯示載入狀態
            const button = document.querySelector('button[onclick="applyDateFilter()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-1 animate-spin"></i>查詢中...';
            button.disabled = true;
            
            // 模擬 API 查詢
            setTimeout(() => {
                // 計算模擬數據
                const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                const simulatedDataCount = Math.floor(daysDiff * (20 + Math.random() * 15)); // 20-35筆/天
                
                // 更新篩選顯示
                updateFilterDisplay(startDate, endDate, simulatedDataCount);
                
                // 更新統計數據
                updateStatistics(simulatedDataCount);
                
                // 更新圖表數據
                refreshChartsWithDateRange(startDate, endDate);
                
                // 恢復按鈕狀態
                button.innerHTML = originalText;
                button.disabled = false;
                
                showNotification(`已更新 ${formatDateRange(startDate, endDate)} 的數據`, 'success');
            }, 1200);
        }

        // 更新篩選條件顯示
        function updateFilterDisplay(startDate, endDate, dataCount) {
            document.getElementById('currentRange').textContent = formatDateRange(startDate, endDate);
            document.getElementById('dataCount').textContent = `(共 ${dataCount} 筆資料)`;
        }

        // 更新統計數據
        function updateStatistics(baseCount) {
            const metrics = [
                { 
                    selector: '.metric-highlight', 
                    index: 0, 
                    value: baseCount 
                },
                { 
                    selector: '.metric-highlight', 
                    index: 1, 
                    value: (95 + Math.random() * 5).toFixed(0) + '%' 
                },
                { 
                    selector: '.metric-highlight', 
                    index: 2, 
                    value: (85 + Math.random() * 10).toFixed(0) 
                },
                { 
                    selector: '#complianceRate', 
                    index: 0, 
                    value: (88 + Math.random() * 8).toFixed(1) + '%' 
                }
            ];
            
            metrics.forEach(metric => {
                const elements = document.querySelectorAll(metric.selector);
                const element = metric.index !== undefined ? elements[metric.index] : elements[0];
                
                if (element) {
                    element.style.animation = 'shimmer 0.6s ease-in-out';
                    setTimeout(() => {
                        element.textContent = metric.value;
                        element.style.animation = '';
                    }, 300);
                }
            });
        }

        // 使用日期範圍刷新圖表
        function refreshChartsWithDateRange(startDate, endDate) {
            Object.values(charts).forEach(chart => {
                if (chart && chart.setOption) {
                    // 這裡可以根據日期範圍生成不同的圖表數據
                    const option = chart.getOption();
                    if (option && option.title) {
                        option.title[0].subtext = `數據期間：${formatDateRange(startDate, endDate)}`;
                        chart.setOption(option, true);
                    }
                }
            });
        }

        // 格式化日期範圍顯示
        function formatDateRange(startDate, endDate) {
            const start = startDate instanceof Date ? startDate : new Date(startDate);
            const end = endDate instanceof Date ? endDate : new Date(endDate);
            
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            };
            
            return `${formatDate(start)} ~ ${formatDate(end)}`;
        }

        // 格式化日期為 input[type="date"] 格式
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // === 季度下拉選單功能 ===

        // 切換季度下拉選單
        function toggleQuarterDropdown() {
            const menu = document.getElementById('quarterDropdownMenu');
            const isHidden = menu.classList.contains('hidden');
            
            if (isHidden) {
                generateQuarterOptions();
                menu.classList.remove('hidden');
                menu.classList.add('quarter-dropdown-menu');
                
                // 點擊外部關閉下拉選單
                setTimeout(() => {
                    document.addEventListener('click', closeQuarterDropdown);
                }, 0);
            } else {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeQuarterDropdown);
            }
        }

        // 生成季度選項
        function generateQuarterOptions() {
            const menu = document.getElementById('quarterDropdownMenu');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const currentQuarter = Math.floor(currentMonth / 3) + 1;
            
            const quarters = [
                { 
                    num: 1, 
                    label: `${currentYear}-Q1`, 
                    desc: '1-3月',
                    months: '01/01 ~ 03/31'
                },
                { 
                    num: 2, 
                    label: `${currentYear}-Q2`, 
                    desc: '4-6月',
                    months: '04/01 ~ 06/30'
                },
                { 
                    num: 3, 
                    label: `${currentYear}-Q3`, 
                    desc: '7-9月',
                    months: '07/01 ~ 09/30'
                },
                { 
                    num: 4, 
                    label: `${currentYear}-Q4`, 
                    desc: '10-12月',
                    months: '10/01 ~ 12/31'
                }
            ];

            let html = '<div class="p-2">';
            html += '<div class="text-xs text-gray-500 mb-2 px-2 font-medium">選擇季度</div>';
            
            quarters.forEach(quarter => {
                const isCurrent = quarter.num === currentQuarter;
                const isPast = quarter.num < currentQuarter;
                const isFuture = quarter.num > currentQuarter;
                
                let itemClass = 'quarter-dropdown-item';
                if (isCurrent) {
                    itemClass += ' current';
                } else if (isFuture) {
                    itemClass += ' disabled';
                }
                
                html += `
                    <div class="${itemClass}" 
                         onclick="${isFuture ? '' : `selectQuarter('q${quarter.num}', '${quarter.label}')`}">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium">${quarter.label}</div>
                                <div class="text-xs opacity-75">${quarter.months}</div>
                            </div>
                            ${isCurrent ? '<span class="text-xs">目前</span>' : ''}
                            ${isFuture ? '<span class="text-xs">未來</span>' : ''}
                        </div>
                    </div>
                `;
            });

            // 添加去年季度選項
            html += '<div class="border-t mt-2 pt-2">';
            html += '<div class="text-xs text-gray-500 mb-2 px-2 font-medium">去年</div>';
            
            const lastYear = currentYear - 1;
            for (let i = 4; i >= 1; i--) {
                const quarterMonths = [
                    '01/01 ~ 03/31',
                    '04/01 ~ 06/30', 
                    '07/01 ~ 09/30',
                    '10/01 ~ 12/31'
                ][i-1];
                
                html += `
                    <div class="quarter-dropdown-item" 
                         onclick="selectQuarter('q${i}', '${lastYear}-Q${i}', ${lastYear})">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium">${lastYear}-Q${i}</div>
                                <div class="text-xs opacity-75">${quarterMonths}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
            menu.innerHTML = html;
        }

        // 選擇季度
        function selectQuarter(quarter, displayText, year = null) {
            const targetYear = year || new Date().getFullYear();
            
            // 更新按鈕文字
            document.getElementById('quarterBtnText').textContent = displayText;
            
            // 關閉下拉選單
            document.getElementById('quarterDropdownMenu').classList.add('hidden');
            document.removeEventListener('click', closeQuarterDropdown);
            
            // 清除其他按鈕狀態
            clearQuickFilterActiveState();
            
            // 設定季度按鈕為選中狀態
            const quarterBtn = document.querySelector('button[onclick="toggleQuarterDropdown()"]');
            quarterBtn.classList.add('quarter-btn-active');
            quarterBtn.classList.remove('bg-gray-100', 'text-gray-700');
            
            // 計算季度日期範圍
            const quarterNum = parseInt(quarter.substring(1));
            const quarterStartMonth = (quarterNum - 1) * 3;
            const startDate = new Date(targetYear, quarterStartMonth, 1);
            const endDate = new Date(targetYear, quarterStartMonth + 3, 0);
            
            // 更新日期選擇器
            document.getElementById('startDate').value = formatDateForInput(startDate);
            document.getElementById('endDate').value = formatDateForInput(endDate);
            
            // 套用篩選
            applyFilter(formatDateForInput(startDate), formatDateForInput(endDate));
        }

        // 關閉季度下拉選單
        function closeQuarterDropdown(event) {
            const dropdown = document.getElementById('quarterDropdown');
            const menu = document.getElementById('quarterDropdownMenu');
            
            if (!dropdown.contains(event.target)) {
                menu.classList.add('hidden');
                document.removeEventListener('click', closeQuarterDropdown);
            }
        }

        // 初始化時間篩選器
        function initDateFilter() {
            // 設定預設為本月
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').value = formatDateForInput(startDate);
            document.getElementById('endDate').value = formatDateForInput(endDate);
            
            updateFilterDisplay(formatDateForInput(startDate), formatDateForInput(endDate), 700);
        }

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `最後更新: ${timeString}`;
        }

        // Calculate and update compliance rate
        function updateComplianceRate() {
            // 根據 complianceData 計算總合格率
            const totalPassed = complianceData.datasets[0].data.reduce((sum, value) => sum + value, 0);
            const totalFailed = complianceData.datasets[1].data.reduce((sum, value) => sum + value, 0);
            const totalCases = totalPassed + totalFailed;
            const complianceRate = ((totalPassed / totalCases) * 100).toFixed(1);
            
            // 更新顯示
            const complianceRateElement = document.getElementById('complianceRate');
            if (complianceRateElement) {
                complianceRateElement.textContent = complianceRate + '%';
            }
        }

        // Calculate and update failure ranking
        function updateFailureRanking() {
            // 計算各項目的不合格率並排序
            const failureData = complianceData.labels.map((label, index) => {
                const passed = complianceData.datasets[0].data[index];
                const failed = complianceData.datasets[1].data[index];
                const total = passed + failed;
                const failureRate = ((failed / total) * 100).toFixed(1);
                
                return {
                    label: label,
                    passed: passed,
                    failed: failed,
                    total: total,
                    failureRate: parseFloat(failureRate),
                    failureRateText: failureRate + '%'
                };
            });
            
            // 按不合格率排序（從高到低）
            failureData.sort((a, b) => b.failureRate - a.failureRate);
            
            // 生成排名列表HTML
            const rankingListElement = document.getElementById('failureRankingList');
            if (rankingListElement) {
                rankingListElement.innerHTML = failureData.map((item, index) => {
                    const rankNumber = index + 1;
                    const severityClass = getSeverityClass(item.failureRate);
                    const iconColor = getSeverityIconColor(item.failureRate);
                    
                    return `
                        <div class="flex items-center justify-between p-3 ${severityClass.bg} border ${severityClass.border} rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center justify-center w-6 h-6 bg-white rounded-full text-xs font-bold ${severityClass.text}">
                                    ${rankNumber}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">${item.label}</h4>
                                    <p class="text-xs text-gray-600">${item.failed}/${item.total} 案件不合格</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold ${severityClass.text}">${item.failureRateText}</div>
                                <i data-lucide="trending-${item.failureRate > 10 ? 'up' : 'down'}" class="w-4 h-4 ${iconColor} mt-1"></i>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // 生成改善建議
            updateImprovementSuggestions(failureData);
        }

        // Get severity styling based on failure rate
        function getSeverityClass(failureRate) {
            if (failureRate >= 12) {
                return {
                    bg: 'bg-red-50',
                    border: 'border-red-200',
                    text: 'text-red-600'
                };
            } else if (failureRate >= 8) {
                return {
                    bg: 'bg-orange-50',
                    border: 'border-orange-200',
                    text: 'text-orange-600'
                };
            } else {
                return {
                    bg: 'bg-yellow-50',
                    border: 'border-yellow-200',
                    text: 'text-yellow-600'
                };
            }
        }

        // Get severity icon color
        function getSeverityIconColor(failureRate) {
            if (failureRate >= 12) return 'text-red-500';
            if (failureRate >= 8) return 'text-orange-500';
            return 'text-yellow-500';
        }

        // Update improvement suggestions based on failure data
        function updateImprovementSuggestions(failureData) {
            const suggestions = [
                `重點改善「${failureData[0].label}」項目，目前不合格率最高 (${failureData[0].failureRateText})`,
                `加強「${failureData[1].label}」培訓，不合格率 ${failureData[1].failureRateText}`,
                failureData[0].failureRate > 12 ? '建議立即啟動專項改善計畫' : '建議定期監控並持續改善'
            ];
            
            const suggestionsElement = document.getElementById('improvementSuggestions');
            if (suggestionsElement) {
                suggestionsElement.innerHTML = suggestions.map(suggestion => 
                    `<div class="text-yellow-700">• ${suggestion}</div>`
                ).join('');
            }
        }

        // Initialize the dashboard
        function initDashboard() {
            populateTopIssues();
            populateAgentsTable();
            initChartsForTab('overview');
            updateLastUpdateTime();
            updateComplianceRate(); // 添加合格率計算
            updateFailureRanking(); // 添加不合格排名更新
            
            // Update time every minute
            setInterval(updateLastUpdateTime, 60000);
        }

        // Audio detail functions
        function showAudioDetail(issueType) {
            currentIssueType = issueType;
            
            // Hide all content
            document.querySelectorAll('[id$="-content"]').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show audio detail content
            document.getElementById('audio-detail-content').style.display = 'block';
            
            // Update page title and category
            document.getElementById('detailPageTitle').textContent = `${issueType} - 音檔明細`;
            document.getElementById('detailIssueCategory').textContent = issueType;
            
            // Load data for current issue type
            allCurrentAudioData = audioDataByIssue[issueType] || [];
            currentAudioData = [...allCurrentAudioData];
            
            // Reset to first page
            currentAudioPage = 1;
            
            // Update stats and render
            updateAudioStats();
            renderAudioTable();
            setupAudioPagination();
        }

        function backToOverview() {
            // Hide audio detail content
            document.getElementById('audio-detail-content').style.display = 'none';
            
            // Show overview content
            document.getElementById('overview-content').style.display = 'block';
            
            // Update active tab
            setActiveTab('overview');
        }

        function updateAudioStats() {
            const highSeverity = currentAudioData.filter(item => item.severity === 'high').length;
            const mediumSeverity = currentAudioData.filter(item => item.severity === 'medium').length;
            const lowSeverity = currentAudioData.filter(item => item.severity === 'low').length;
            
            const totalDuration = currentAudioData.reduce((sum, item) => {
                const [min, sec] = item.duration.split(':').map(Number);
                return sum + min * 60 + sec;
            }, 0);
            const avgDurationSeconds = totalDuration / currentAudioData.length || 0;
            const avgMin = Math.floor(avgDurationSeconds / 60);
            const avgSec = Math.floor(avgDurationSeconds % 60);
            
            document.getElementById('highSeverityCount').textContent = highSeverity;
            document.getElementById('mediumSeverityCount').textContent = mediumSeverity;
            document.getElementById('lowSeverityCount').textContent = lowSeverity;
            document.getElementById('avgDuration').textContent = `${avgMin}:${avgSec.toString().padStart(2, '0')}`;
            document.getElementById('detailTotalCount').textContent = `總計 ${currentAudioData.length} 筆`;
        }

        function renderAudioTable() {
            const tbody = document.getElementById('audioTableBody');
            tbody.innerHTML = '';
            
            const startIndex = (currentAudioPage - 1) * audioPageSize;
            const endIndex = Math.min(startIndex + audioPageSize, currentAudioData.length);
            const pageData = currentAudioData.slice(startIndex, endIndex);
            
            pageData.forEach((audio, index) => {
                const row = createAudioRow(audio, startIndex + index);
                tbody.appendChild(row);
            });
            
            safeCreateIcons();
        }

        function createAudioRow(audio, index) {
            const tr = document.createElement('tr');
            const severityClass = `severity-${audio.severity}`;
            tr.className = `audio-row ${severityClass}`;
            
            const severityText = {
                high: '高',
                medium: '中',
                low: '低'
            };
            
            const severityColor = {
                high: 'text-red-600',
                medium: 'text-orange-600',
                low: 'text-green-600'
            };
            
            tr.innerHTML = `
                <td class="px-4 py-4">
                    <button onclick="playAudio('${audio.fileName}')" class="play-button bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition">
                        <i data-lucide="play" class="w-4 h-4"></i>
                    </button>
                </td>
                <td class="px-4 py-4">
                    <div class="text-sm font-medium text-gray-900">${audio.fileName}</div>
                    <div class="text-sm text-gray-600">時長: ${audio.duration}</div>
                    <div class="text-sm text-gray-600">大小: ${Math.floor(Math.random() * 5 + 2)}.${Math.floor(Math.random() * 99)}MB</div>
                </td>
                <td class="px-4 py-4">
                    <div class="text-sm text-gray-900">${audio.callTime}</div>
                    <div class="text-sm text-gray-600">客戶: ${audio.customerName} (${audio.customerId})</div>
                    <div class="text-sm text-gray-600">通話類型: 保險諮詢</div>
                </td>
                <td class="px-4 py-4">
                    <div class="text-sm font-medium text-gray-900">${audio.agentName}</div>
                    <div class="text-sm text-gray-600">ID: ${audio.agentId}</div>
                    <div class="text-sm text-gray-600">建立: ${audio.createdByName}</div>
                </td>
                <td class="px-4 py-4">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-sm font-medium ${severityColor[audio.severity]}">${severityText[audio.severity]}嚴重度</span>
                        <span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800">-${audio.deduction}分</span>
                    </div>
                    <div class="text-sm text-gray-600">指標: ${currentIssueType}</div>
                    <div class="text-sm text-gray-600">時間點: ${Math.floor(Math.random() * 3 + 1)}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}</div>
                </td>
                <td class="px-4 py-4">
                    <div class="flex flex-col space-y-1">
                        <button onclick="showSttModal('${audio.fileName}')" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                            查看STT
                        </button>
                        <button onclick="downloadAudio('${audio.fileName}')" class="text-green-600 hover:text-green-700 text-sm font-medium">
                            下載音檔
                        </button>
                        <button onclick="addToTraining('${audio.fileName}')" class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                            加入訓練
                        </button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        function setupAudioPagination() {
            totalAudioPages = Math.ceil(currentAudioData.length / audioPageSize);
            
            const showingFrom = (currentAudioPage - 1) * audioPageSize + 1;
            const showingTo = Math.min(currentAudioPage * audioPageSize, currentAudioData.length);
            
            document.getElementById('showingFrom').textContent = showingFrom;
            document.getElementById('showingTo').textContent = showingTo;
            document.getElementById('totalItems').textContent = currentAudioData.length;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentAudioPage === 1;
            document.getElementById('nextBtn').disabled = currentAudioPage === totalAudioPages;
            
            // Generate page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            for (let i = 1; i <= totalAudioPages; i++) {
                if (i === 1 || i === totalAudioPages || (i >= currentAudioPage - 2 && i <= currentAudioPage + 2)) {
                    const button = document.createElement('button');
                    button.className = `px-3 py-2 border text-sm font-medium ${i === currentAudioPage ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`;
                    button.textContent = i;
                    button.onclick = () => goToAudioPage(i);
                    pageNumbers.appendChild(button);
                } else if (i === currentAudioPage - 3 || i === currentAudioPage + 3) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.className = 'px-2 py-2 text-gray-500';
                    pageNumbers.appendChild(span);
                }
            }
        }

        function goToAudioPage(page) {
            currentAudioPage = page;
            renderAudioTable();
            setupAudioPagination();
        }

        function previousPage() {
            if (currentAudioPage > 1) {
                goToAudioPage(currentAudioPage - 1);
            }
        }

        function nextPage() {
            if (currentAudioPage < totalAudioPages) {
                goToAudioPage(currentAudioPage + 1);
            }
        }

        function applyFilters() {
            const timeRange = document.getElementById('timeRange').value;
            const agentFilter = document.getElementById('agentFilter').value;
            const severityFilter = document.getElementById('severityFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            currentAudioData = allCurrentAudioData.filter(audio => {
                // Agent filter
                if (agentFilter && audio.agentId !== agentFilter) return false;
                
                // Severity filter
                if (severityFilter && audio.severity !== severityFilter) return false;
                
                // Search filter
                if (searchInput && 
                    !audio.fileName.toLowerCase().includes(searchInput) &&
                    !audio.customerId.toLowerCase().includes(searchInput) &&
                    !audio.customerName.toLowerCase().includes(searchInput)) {
                    return false;
                }
                
                return true;
            });
            
            currentAudioPage = 1;
            updateAudioStats();
            renderAudioTable();
            setupAudioPagination();
        }

        // Modal functions
        function showSttModal(fileName) {
            const audio = allCurrentAudioData.find(a => a.fileName === fileName);
            if (!audio) return;
            
            document.getElementById('modalFileName').textContent = audio.fileName;
            document.getElementById('modalDuration').textContent = audio.duration;
            document.getElementById('modalAgent').textContent = `${audio.agentName} (${audio.agentId})`;
            document.getElementById('modalSttContent').textContent = audio.sttText;
            
            document.getElementById('sttModal').classList.remove('hidden');
        }

        function closeSttModal() {
            document.getElementById('sttModal').classList.add('hidden');
        }

        // Action functions
        function playAudio(fileName) {
            alert(`播放音檔: ${fileName}`);
        }

        function downloadAudio(fileName) {
            alert(`下載音檔: ${fileName}`);
        }

        function addToTraining(fileName) {
            alert(`已將 ${fileName} 加入訓練素材庫`);
        }

        function exportAudioList() {
            alert('匯出音檔清單功能開發中...');
        }

        function exportSttText() {
            const sttContent = document.getElementById('modalSttContent').textContent;
            const blob = new Blob([sttContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stt_transcript.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // === 語音標籤頁面功能（新設計五區塊） ===
        
        // 全域變數
        let voiceCurrentCategorySlot = null;
        let voiceSelectedCategories = { 1: null, 2: null };
        let voiceLabelCharts = {};
        let voiceIntentChart = null;
        let voiceHeatmapChart = null;

        // 模擬語音標籤數據
        const voiceMockData = {
            totalLabels: 200,
            totalIntents: 50,
            hitLabels: 110,
            hitIntents: 25,
            
            categories: [
                { id: 'product', name: '商品', labels: ['壽險商品', '醫療商品', '投資商品', '保障商品', '儲蓄', '其他'] },
                { id: 'activity', name: '活動', labels: ['壽險商品', '醫療商品', '投資商品', '保障商品', '儲蓄', '其他'] },
                { id: 'sensitive', name: '敏感詞', labels: ['壽險商品', '醫療商品', '投資商品', '保障商品', '儲蓄', '其他'] },
                { id: 'finance', name: '理賠商品', labels: ['壽險商品', '醫療商品', '投資商品', '保障商品', '儲蓄', '其他'] }
            ],

            labelStats: {
                'product': { '壽險商品': 45, '醫療商品': 32, '投資商品': 28, '保障商品': 25, '儲蓄': 18, '其他': 12 },
                'activity': { '壽險商品': 38, '醫療商品': 35, '投資商品': 22, '保障商品': 19, '儲蓄': 15, '其他': 8 },
                'sensitive': { '壽險商品': 42, '醫療商品': 30, '投資商品': 25, '保障商品': 20, '儲蓄': 16, '其他': 10 },
                'finance': { '壽險商品': 50, '醫療商品': 40, '投資商品': 35, '保障商品': 28, '儲蓄': 22, '其他': 15 }
            },

            intents: ['詢問商品', '申請理賠', '保單查詢', '投保意願', '客戶文件'],
            intentStats: [340, 320, 250, 190, 150],

            heatmapData: {
                labels: ['住宅險', '意外險', '車險'],
                intents: ['詢問商品', '申請理賠', '保單查詢', '投保意願'],
                data: [
                    [0, 0, 10], [0, 1, 5], [0, 2, 15], [0, 3, 8],
                    [1, 0, 12], [1, 1, 20], [1, 2, 8], [1, 3, 6],
                    [2, 0, 8], [2, 1, 3], [2, 2, 25], [2, 3, 12]
                ]
            }
        };

        // 初始化語音標籤頁面
        function initTagsPage() {
            initVoiceLabelCharts();
            initVoiceIntentChart();
            initVoiceHeatmapChart();
            console.log('語音標籤頁面初始化完成');
        }

        function populateProductTagsList() {
            const container = document.getElementById('productTagsList');
            container.innerHTML = '';
            
            productTags.forEach((tag, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition';
                
                const trendIcon = tag.trend === 'up' ? 'trending-up' : 
                                 tag.trend === 'down' ? 'trending-down' : 'minus';
                const trendColor = tag.trend === 'up' ? 'text-green-600' : 
                                  tag.trend === 'down' ? 'text-red-600' : 'text-gray-600';
                
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-700 font-bold text-xs">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">${tag.name}</div>
                            <div class="text-sm text-gray-600">覆蓋 ${tag.coverage} 通電話</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-gray-900">${tag.count} 次</div>
                        <div class="flex items-center text-sm ${trendColor}">
                            <i data-lucide="${trendIcon}" class="w-3 h-3 mr-1"></i>
                            <span>${tag.changePercent > 0 ? '+' : ''}${tag.changePercent}%</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            safeCreateIcons();
        }

        function populateActivityTagsList() {
            const container = document.getElementById('activityTagsList');
            container.innerHTML = '';
            
            activityTags.forEach((tag, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition';
                
                const statusClass = tag.status === 'active' ? 'bg-green-100 text-green-800' :
                                   tag.status === 'ended' ? 'bg-gray-100 text-gray-800' :
                                   'bg-blue-100 text-blue-800';
                
                const performanceClass = tag.performance === 'excellent' ? 'text-green-600' :
                                        tag.performance === 'good' ? 'text-blue-600' :
                                        tag.performance === 'average' ? 'text-orange-600' :
                                        'text-gray-600';
                
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-900">${tag.name}</div>
                        <div class="text-sm text-gray-600">${tag.period}</div>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="px-2 py-0.5 text-xs rounded-full ${statusClass}">
                                ${tag.status === 'active' ? '進行中' : tag.status === 'ended' ? '已結束' : '計劃中'}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-gray-900">${tag.count} 次</div>
                        <div class="text-sm ${performanceClass}">
                            ${tag.performance === 'excellent' ? '優秀' : 
                              tag.performance === 'good' ? '良好' : 
                              tag.performance === 'average' ? '一般' : '待評估'}
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function populateTagDetailTable() {
            const tbody = document.getElementById('tagDetailTable');
            tbody.innerHTML = '';
            
            allTagsData.forEach((tag) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                const typeClass = tag.type === 'product' ? 'bg-green-100 text-green-800' :
                                 tag.type === 'intent' ? 'bg-blue-100 text-blue-800' :
                                 'bg-orange-100 text-orange-800';
                
                const typeName = tag.type === 'product' ? '商品' :
                                tag.type === 'intent' ? '意圖' : '活動';
                
                const trendIcon = tag.trend === 'up' ? 'trending-up' : 
                                 tag.trend === 'down' ? 'trending-down' : 'minus';
                const trendColor = tag.trend === 'up' ? 'text-green-600' : 
                                  tag.trend === 'down' ? 'text-red-600' : 'text-gray-600';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${tag.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${typeClass}">
                            ${typeName}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${tag.count}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${tag.coverage}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${tag.successRate}%</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center ${trendColor}">
                            <i data-lucide="${trendIcon}" class="w-4 h-4 mr-1"></i>
                            <span class="text-sm">${tag.trend === 'up' ? '上升' : tag.trend === 'down' ? '下降' : '穩定'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-700 mr-3">查看</button>
                        <button class="text-green-600 hover:text-green-700">分析</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            safeCreateIcons();
        }

        function initIntentChart() {
            if (charts.intent) {
                charts.intent.dispose();
            }
            const chartDom = document.getElementById('intentChart');
            charts.intent = echarts.init(chartDom);
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 'bottom',
                    data: intentData.labels
                },
                series: [
                    {
                        name: '意圖分析',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 20,
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: intentData.labels.map((label, index) => ({
                            value: intentData.datasets[0].data[index],
                            name: label,
                            itemStyle: {
                                color: intentData.datasets[0].backgroundColor[index]
                            }
                        }))
                    }
                ]
            };
            
            charts.intent.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.intent.resize();
            }, 100);
        }

        function initTagTrendChart() {
            if (charts.tagTrend) {
                charts.tagTrend.dispose();
            }
            const chartDom = document.getElementById('tagTrendChart');
            charts.tagTrend = echarts.init(chartDom);
            
            const option = {
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: tagTrendData.datasets.map(dataset => dataset.label),
                    top: 'top'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: tagTrendData.labels,
                    name: '日期',
                    nameLocation: 'middle',
                    nameGap: 25
                },
                yAxis: {
                    type: 'value',
                    name: '標籤數量',
                    nameLocation: 'middle',
                    nameGap: 40
                },
                series: tagTrendData.datasets.map(dataset => ({
                    name: dataset.label,
                    type: 'line',
                    smooth: true,
                    data: dataset.data,
                    lineStyle: {
                        color: dataset.borderColor,
                        width: 3
                    },
                    itemStyle: {
                        color: dataset.borderColor
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: dataset.backgroundColor.replace('0.1', '0.3')
                            }, {
                                offset: 1, color: dataset.backgroundColor
                            }]
                        }
                    }
                }))
            };
            
            charts.tagTrend.setOption(option);
            
            // 確保圖表正確響應容器大小變化
            setTimeout(() => {
                charts.tagTrend.resize();
            }, 100);
        }

        function exportTagReport() {
            alert('標籤報表匯出功能開發中...');
        }

        // 友善時間查詢功能
        const timeRanges = {
            today: { name: '今日', days: 0 },
            yesterday: { name: '昨日', days: 1 },
            last7days: { name: '近7天', days: 7 },
            thisweek: { name: '本週', days: 'thisweek' },
            lastweek: { name: '上週', days: 'lastweek' },
            last30days: { name: '近30天', days: 30 },
            thismonth: { name: '本月', days: 'thismonth' },
            lastmonth: { name: '上月', days: 'lastmonth' },
            last3months: { name: '近3個月', days: 90 },
            custom: { name: '自定義範圍', days: 'custom' }
        };

        // 計算日期範圍
        function calculateDateRange(rangeType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(rangeType) {
                case 'today':
                    return {
                        start: new Date(today),
                        end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                    };
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    return {
                        start: yesterday,
                        end: new Date(yesterday.getTime() + 24 * 60 * 60 * 1000 - 1)
                    };
                case 'last7days':
                    return {
                        start: new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000),
                        end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                    };
                case 'thisweek':
                    const dayOfWeek = today.getDay();
                    const startOfWeek = new Date(today.getTime() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1) * 24 * 60 * 60 * 1000);
                    return {
                        start: startOfWeek,
                        end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                    };
                case 'lastweek':
                    const lastWeekEnd = new Date(today.getTime() - (today.getDay() === 0 ? 0 : today.getDay()) * 24 * 60 * 60 * 1000 - 1);
                    const lastWeekStart = new Date(lastWeekEnd.getTime() - 6 * 24 * 60 * 60 * 1000);
                    return {
                        start: lastWeekStart,
                        end: lastWeekEnd
                    };
                case 'last30days':
                    return {
                        start: new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000),
                        end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                    };
                case 'thismonth':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    return {
                        start: startOfMonth,
                        end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                    };
                case 'lastmonth':
                    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    return {
                        start: lastMonthStart,
                        end: lastMonthEnd
                    };
                case 'last3months':
                    return {
                        start: new Date(today.getTime() - 89 * 24 * 60 * 60 * 1000),
                        end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                    };
                default:
                    return { start: today, end: today };
            }
        }

        // 格式化日期範圍顯示
        function formatDateRange(range) {
            const options = { month: '2-digit', day: '2-digit' };
            const startStr = range.start.toLocaleDateString('zh-TW', options);
            const endStr = range.end.toLocaleDateString('zh-TW', options);
            
            if (startStr === endStr) {
                return startStr;
            }
            return `${startStr} ~ ${endStr}`;
        }

        // 更新總覽數據
        function updateOverviewData() {
            const selectedRange = document.getElementById('overviewTimeRange').value;
            const isComparison = document.getElementById('enableComparison').checked;
            
            if (selectedRange === 'custom') {
                showCustomDateModal();
                return;
            }
            
            const range = calculateDateRange(selectedRange);
            console.log(`更新總覽數據: ${timeRanges[selectedRange].name}`, range);
            
            // 這裡可以添加實際的數據更新邏輯
            // 例如：重新載入圖表、更新統計數字等
            if (isComparison) {
                console.log('啟用對比功能');
                // 計算上一週期的數據進行對比
            }
            
            // 更新頁面標題顯示當前時間範圍
            updatePageTitle(timeRanges[selectedRange].name);
        }

        // 快速時間選擇
        function setQuickTimeRange(rangeType) {
            document.getElementById('overviewTimeRange').value = rangeType;
            updateOverviewData();
        }

        // 開啟/關閉時間比較功能
        function toggleComparison() {
            const isEnabled = document.getElementById('enableComparison').checked;
            console.log(`時間比較功能: ${isEnabled ? '開啟' : '關閉'}`);
            
            if (isEnabled) {
                updateOverviewData(); // 重新加載帶對比的數據
            }
        }

        // 自定義日期範圍相關函數
        function showCustomDateModal() {
            // 設定預設日期
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            document.getElementById('customDateModal').classList.remove('hidden');
        }

        function closeCustomDateModal() {
            document.getElementById('customDateModal').classList.add('hidden');
            // 重置下拉選單            // ...existing code...
                    // Call the main ECharts compliance chart function
                    initComplianceChart();
            
                    // Drill-down handler：嘗試以標籤對應到音檔明細並切換到音檔明細頁
                    function showComplianceDetail(label) {
                        // 直接對應 audioDataByIssue 的 key
                        if (audioDataByIssue[label]) {
                            showAudioDetail(label);
                            return;
                        }
            
                        // 嘗試以包含關鍵字方式匹配
                        const foundKey = Object.keys(audioDataByIssue).find(k => k.includes(label) || label.includes(k));
                        if (foundKey) {
                            showAudioDetail(foundKey);
                            return;
                        }
            
                        // 嘗試以 topIssues 的 category 去找到相關 issue
                        const byCategory = allTopIssues.find(item => item.category === label);
                        if (byCategory && audioDataByIssue[byCategory.issue]) {
                            showAudioDetail(byCategory.issue);
                            return;
                        }
            
                        // 若找不到，顯示提示並切換到高頻指標列表
                        alert(`找不到與「${label}」直接對應的明細，將顯示高頻指標列表。`);
                        setActiveTab('overview');
                        // 若需要可改為打開 analysis tab 或顯示一個 modal
                    }
            // ...existing code...            // ...existing code...
                    // Call the main ECharts compliance chart function
                    initComplianceChart();
            
                    // Drill-down handler：嘗試以標籤對應到音檔明細並切換到音檔明細頁
                    function showComplianceDetail(label) {
                        // 直接對應 audioDataByIssue 的 key
                        if (audioDataByIssue[label]) {
                            showAudioDetail(label);
                            return;
                        }
            
                        // 嘗試以包含關鍵字方式匹配
                        const foundKey = Object.keys(audioDataByIssue).find(k => k.includes(label) || label.includes(k));
                        if (foundKey) {
                            showAudioDetail(foundKey);
                            return;
                        }
            
                        // 嘗試以 topIssues 的 category 去找到相關 issue
                        const byCategory = allTopIssues.find(item => item.category === label);
                        if (byCategory && audioDataByIssue[byCategory.issue]) {
                            showAudioDetail(byCategory.issue);
                            return;
                        }
            
                        // 若找不到，顯示提示並切換到高頻指標列表
                        alert(`找不到與「${label}」直接對應的明細，將顯示高頻指標列表。`);
                        setActiveTab('overview');
                        // 若需要可改為打開 analysis tab 或顯示一個 modal
                    }
            // ...existing code...到之前的值
            document.getElementById('overviewTimeRange').value = 'thisweek';
        }

        function setDateRange(rangeType) {
            const range = calculateDateRange(rangeType);
            document.getElementById('startDate').value = range.start.toISOString().split('T')[0];
            document.getElementById('endDate').value = range.end.toISOString().split('T')[0];
        }

        function applyCustomDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('請選擇開始和結束日期');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('開始日期不能晚於結束日期');
                return;
            }
            
            console.log(`自定義日期範圍: ${startDate} ~ ${endDate}`);
            closeCustomDateModal();
            
            // 更新頁面顯示
            updatePageTitle(`${startDate} ~ ${endDate}`);
        }

        // 音檔頁面時間選擇
        function onAudioTimeRangeChange() {
            const selectedRange = document.getElementById('timeRange').value;
            
            if (selectedRange === 'custom') {
                showCustomDateModal();
                return;
            }
            
            const range = calculateDateRange(selectedRange);
            const rangeText = formatDateRange(range);
            
            // 更新顯示的日期範圍
            document.getElementById('selectedDateRange').textContent = rangeText;
            
            console.log(`音檔頁面時間範圍: ${timeRanges[selectedRange].name}`, range);
            
            // 重新應用篩選
            applyFilters();
        }

        function setAudioTimeRange(rangeType) {
            document.getElementById('timeRange').value = rangeType;
            onAudioTimeRangeChange();
        }

        // 更新頁面標題
        function updatePageTitle(timeRangeText) {
            const titleElement = document.querySelector('h1');
            if (titleElement) {
                const baseTitle = 'SysTalk.Audit儀表板';
                titleElement.textContent = `${baseTitle} - ${timeRangeText}`;
            }
        }

        // 初始化時間選擇器
        function initTimeSelectors() {
            // 設定預設時間範圍顯示
            const defaultRange = calculateDateRange('thisweek');
            const defaultRangeText = formatDateRange(defaultRange);
            
            // 初始化音檔頁面的日期範圍顯示
            const selectedDateRange = document.getElementById('selectedDateRange');
            if (selectedDateRange) {
                selectedDateRange.textContent = defaultRangeText;
            }
            
            console.log('時間選擇器已初始化');
        }

        // 增強版的 initDashboard 函數
        function initDashboard() {
            populateTopIssues();
            populateAgentsTable();
            initChartsForTab('overview');
            updateLastUpdateTime();
            updateComplianceRate(); // 添加合格率計算
            updateFailureRanking(); // 添加不合格排名更新
            initTimeSelectors(); // 新增：初始化時間選擇器
            
            // Update time every minute
            setInterval(updateLastUpdateTime, 60000);
        }

        // Severity Settings Functions
        let severitySettings = {
            high: { min: 8, max: 20 },
            medium: { min: 4, max: 7 },
            low: { min: 1, max: 3 }
        };

        // Load severity settings from localStorage
        function loadSeveritySettings() {
            const saved = localStorage.getItem('severitySettings');
            if (saved) {
                severitySettings = JSON.parse(saved);
            }
            updateSeverityInputs();
            updateSeverityTooltips();
        }

        // Save severity settings to localStorage
        function saveSeveritySettings() {
            localStorage.setItem('severitySettings', JSON.stringify(severitySettings));
        }

        // Show severity settings modal
        function showSeveritySettings() {
            updateSeverityInputs();
            document.getElementById('severitySettingsModal').classList.remove('hidden');
        }

        // Close severity settings modal
        function closeSeveritySettings() {
            document.getElementById('severitySettingsModal').classList.add('hidden');
        }

        // Update input fields with current settings
        function updateSeverityInputs() {
            document.getElementById('highSeverityMin').value = severitySettings.high.min;
            document.getElementById('highSeverityMax').value = severitySettings.high.max;
            document.getElementById('mediumSeverityMin').value = severitySettings.medium.min;
            document.getElementById('mediumSeverityMax').value = severitySettings.medium.max;
            document.getElementById('lowSeverityMin').value = severitySettings.low.min;
            document.getElementById('lowSeverityMax').value = severitySettings.low.max;
        }

        // Apply severity settings
        function applySeveritySettings() {
            const highMin = parseInt(document.getElementById('highSeverityMin').value);
            const highMax = parseInt(document.getElementById('highSeverityMax').value);
            const mediumMin = parseInt(document.getElementById('mediumSeverityMin').value);
            const mediumMax = parseInt(document.getElementById('mediumSeverityMax').value);
            const lowMin = parseInt(document.getElementById('lowSeverityMin').value);
            const lowMax = parseInt(document.getElementById('lowSeverityMax').value);

            // Validation
            if (highMin >= highMax || mediumMin >= mediumMax || lowMin >= lowMax) {
                alert('最低分數必須小於最高分數');
                return;
            }

            if (lowMax >= mediumMin || mediumMax >= highMin) {
                alert('分數範圍不能重疊，請確保：低嚴重度 < 中嚴重度 < 高嚴重度');
                return;
            }

            // Update settings
            severitySettings = {
                high: { min: highMin, max: highMax },
                medium: { min: mediumMin, max: mediumMax },
                low: { min: lowMin, max: lowMax }
            };

            saveSeveritySettings();
            updateSeverityTooltips();
            updateAudioDetailSeverityDisplay();
            closeSeveritySettings();
            
            showSuccessMessage('嚴重度設定已更新');
        }

        // Reset to default settings
        function resetSeveritySettings() {
            severitySettings = {
                high: { min: 8, max: 20 },
                medium: { min: 4, max: 7 },
                low: { min: 1, max: 3 }
            };
            updateSeverityInputs();
        }

        // Apply preset severity settings
        function applyPresetSeverity(presetType) {
            if (presetType === 'default') {
                severitySettings = {
                    high: { min: 8, max: 20 },
                    medium: { min: 4, max: 7 },
                    low: { min: 1, max: 3 }
                };
            } else if (presetType === 'strict') {
                severitySettings = {
                    high: { min: 6, max: 20 },
                    medium: { min: 3, max: 5 },
                    low: { min: 1, max: 2 }
                };
            }
            updateSeverityInputs();
        }

        // Classify severity based on score
        function classifySeverity(score) {
            if (score >= severitySettings.high.min && score <= severitySettings.high.max) {
                return 'high';
            } else if (score >= severitySettings.medium.min && score <= severitySettings.medium.max) {
                return 'medium';
            } else if (score >= severitySettings.low.min && score <= severitySettings.low.max) {
                return 'low';
            }
            return 'low'; // Default fallback
        }

        // Update severity tooltips with dynamic ranges
        function updateSeverityTooltips() {
            const tooltips = {
                high: `高嚴重度 (${severitySettings.high.min}-${severitySettings.high.max}分)：保密規定違反、未執行身份驗證等嚴重違規`,
                medium: `中嚴重度 (${severitySettings.medium.min}-${severitySettings.medium.max}分)：問題未完全解決、專業知識不足等一般違規`,
                low: `低嚴重度 (${severitySettings.low.min}-${severitySettings.low.max}分)：缺少結束語、回應時間稍長等輕微違規`
            };

            // Update tooltip content in audio detail page if it exists
            const severityElements = document.querySelectorAll('[data-severity-tooltip]');
            severityElements.forEach(element => {
                if (element && typeof element.getAttribute === 'function') {
                    const severityType = element.getAttribute('data-severity-tooltip');
                    if (tooltips[severityType]) {
                        element.setAttribute('title', tooltips[severityType]);
                    }
                }
            });
        }

        // Update audio detail page severity display
        function updateAudioDetailSeverityDisplay() {
            // Re-classify all audio items based on new severity settings
            if (typeof currentData !== 'undefined' && currentData.length > 0) {
                currentData.forEach(audio => {
                    audio.severity = classifySeverity(audio.deduction);
                });
                
                // Re-render the table if we're on audio detail page
                if (typeof renderTable === 'function') {
                    renderTable();
                }
                
                // Update stats if function exists
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            }
        }

        // Show success message
        function showSuccessMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageEl.textContent = message;
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                messageEl.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 3000);
        }

        // Enhanced initDashboard to load severity settings
        function initDashboard() {
            populateTopIssues();
            populateAgentsTable();
            initChartsForTab('overview');
            updateLastUpdateTime();
            updateComplianceRate(); // 添加合格率計算
            updateFailureRanking(); // 添加不合格排名更新
            initTimeSelectors();
            loadSeveritySettings(); // Load custom severity settings
            initDateFilter(); // 初始化時間篩選器
            
            // Update time every minute
            setInterval(updateLastUpdateTime, 60000);
        }

        // AI Improvement Plan Functions
        function generateImprovementPlan() {
            // 顯示改善方案區域
            document.getElementById('improvementPlanSection').style.display = 'block';
            document.getElementById('improvementLoading').style.display = 'block';
            document.getElementById('improvementContent').style.display = 'none';
            
            // 滾動到改善方案區域
            document.getElementById('improvementPlanSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            // 模擬AI分析過程
            setTimeout(() => {
                generateImprovementContent();
                document.getElementById('improvementLoading').style.display = 'none';
                document.getElementById('improvementContent').style.display = 'block';
                safeCreateIcons(); // 重新初始化圖標
            }, 3000);
        }

        function generateImprovementContent() {
            // 根據complianceData分析問題
            const problems = analyzeQualityProblems();
            const suggestions = generateSuggestions(problems);
            const plan = generateImplementationPlan(problems);
            const results = generateExpectedResults(problems);
            
            // 填入問題分析
            document.getElementById('problemAnalysis').innerHTML = problems.map(problem => 
                `<div class="flex items-start space-x-2">
                    <div class="w-2 h-2 bg-red-500 rounded-full mt-2 flex-shrink-0"></div>
                    <div>
                        <div class="font-medium text-gray-900">${problem.title}</div>
                        <div class="text-gray-600">${problem.description}</div>
                        <div class="text-red-600 text-xs mt-1">影響度: ${problem.impact}</div>
                    </div>
                </div>`
            ).join('');
            
            // 填入改善建議
            document.getElementById('improvementSuggestions').innerHTML = suggestions.map(suggestion => 
                `<div class="flex items-start space-x-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full mt-2 flex-shrink-0"></div>
                    <div>
                        <div class="font-medium text-gray-900">${suggestion.title}</div>
                        <div class="text-gray-600">${suggestion.description}</div>
                        <div class="text-green-600 text-xs mt-1">優先級: ${suggestion.priority}</div>
                    </div>
                </div>`
            ).join('');
            
            // 填入實施計畫
            document.getElementById('implementationPlan').innerHTML = plan.map((phase, index) => 
                `<div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${phase.title}</div>
                        <div class="text-sm text-gray-600">${phase.description}</div>
                        <div class="text-xs text-blue-600 mt-1">時程: ${phase.timeline}</div>
                    </div>
                </div>`
            ).join('');
            
            // 填入預期效果
            document.getElementById('expectedResults').innerHTML = results.map(result => 
                `<div class="text-center p-4 bg-white rounded-lg border">
                    <div class="text-2xl font-bold ${result.color} mb-1">${result.value}</div>
                    <div class="text-sm text-gray-600">${result.title}</div>
                    <div class="text-xs text-gray-500 mt-1">${result.timeframe}</div>
                </div>`
            ).join('');
        }

        function analyzeQualityProblems() {
            const data = complianceData;
            const problems = [];
            
            // 分析各項目的失敗率
            data.labels.forEach((label, index) => {
                const passed = data.datasets[0].data[index];
                const failed = data.datasets[1].data[index];
                const total = passed + failed;
                const failureRate = (failed / total * 100).toFixed(1);
                
                if (failed > 80) { // 不合格數量較高
                    problems.push({
                        title: `${label}環節失敗率偏高`,
                        description: `不合格率達${failureRate}%，有${failed}個案例需要改善`,
                        impact: failureRate > 12 ? '高' : '中'
                    });
                }
            });
            
            return problems;
        }

        function generateSuggestions(problems) {
            const suggestionMap = {
                '開場白': {
                    title: '標準化開場白流程',
                    description: '建立標準開場白話術庫，包含問候語、自我介紹、服務說明',
                    priority: '高'
                },
                '身份驗證': {
                    title: '簡化身份驗證流程',
                    description: '優化驗證步驟，提供快速驗證工具，減少遺漏風險',
                    priority: '高'
                },
                '問題確認': {
                    title: '建立問題確認檢核表',
                    description: '設計標準化問題確認流程，確保客戶需求準確理解',
                    priority: '中'
                },
                '解決方案': {
                    title: '加強解決方案培訓',
                    description: '建立解決方案資料庫，提供常見問題處理指南',
                    priority: '高'
                },
                '結束語': {
                    title: '推廣結束語最佳實務',
                    description: '將現有良好做法標準化，推廣到其他環節',
                    priority: '低'
                }
            };
            
            return problems.map(problem => {
                const category = problem.title.split('環節')[0];
                return suggestionMap[category] || {
                    title: '通用品質改善',
                    description: '強化培訓並建立標準作業程序',
                    priority: '中'
                };
            });
        }

        function generateImplementationPlan(problems) {
            return [
                {
                    title: '第一週：問題分析與標準制定',
                    description: '深入分析品質問題根因，制定標準作業流程',
                    timeline: '1-7天'
                },
                {
                    title: '第二週：培訓計畫設計',
                    description: '針對問題環節設計專項培訓課程和教材',
                    timeline: '8-14天'
                },
                {
                    title: '第三週：試點實施',
                    description: '選擇部分團隊進行試點，收集改善數據',
                    timeline: '15-21天'
                },
                {
                    title: '第四週：全面推廣',
                    description: '將成功做法推廣到全部團隊，建立監控機制',
                    timeline: '22-30天'
                }
            ];
        }

        function generateExpectedResults(problems) {
            const avgImprovement = problems.length > 0 ? 8 + Math.floor(Math.random() * 7) : 10;
            return [
                {
                    title: '整體品質提升',
                    value: `+${avgImprovement}%`,
                    color: 'text-green-600',
                    timeframe: '30天內'
                },
                {
                    title: '客戶滿意度',
                    value: `+${Math.floor(avgImprovement * 0.8)}%`,
                    color: 'text-blue-600',
                    timeframe: '實施後'
                },
                {
                    title: '訓練成本節省',
                    value: `$${Math.floor(avgImprovement * 1.2)}K`,
                    color: 'text-purple-600',
                    timeframe: '每月'
                }
            ];
        }

        function closeImprovementPlan() {
            document.getElementById('improvementPlanSection').style.display = 'none';
        }

        function exportImprovementPlan() {
            const content = generateExportContent();
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `品質改善方案_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateExportContent() {
            const date = new Date().toLocaleDateString('zh-TW');
            return `
SysTalk.Audit - 品質改善方案
生成日期: ${date}

=== 問題識別 ===
${document.getElementById('problemAnalysis').innerText}

=== 改善建議 ===
${document.getElementById('improvementSuggestions').innerText}

=== 30天實施計畫 ===
${document.getElementById('implementationPlan').innerText}

=== 預期改善效果 ===
${document.getElementById('expectedResults').innerText}

本方案由SysTalk.Audit系統自動生成，建議結合實際情況進行調整。
            `.trim();
        }

        // Ensure ECharts is loaded before initializing dashboard
        function waitForECharts(callback) {
            if (typeof echarts !== 'undefined') {
                console.log('ECharts is ready, version:', echarts.version);
                callback();
            } else {
                console.log('Waiting for ECharts to load...');
                setTimeout(() => waitForECharts(callback), 100);
            }
        }
        
        // === 語音標籤分析功能續 ===
        
        // === 分類選擇功能 ===
        function showVoiceCategorySelector(slot) {
            voiceCurrentCategorySlot = slot;
            const modal = document.getElementById('voiceCategoryModal');
            const optionsContainer = document.getElementById('voiceCategoryOptions');
            
            // 生成分類選項
            optionsContainer.innerHTML = '';
            voiceMockData.categories.forEach(category => {
                const option = document.createElement('label');
                option.className = 'flex items-center p-3 rounded-lg border hover:bg-gray-50 cursor-pointer';
                option.innerHTML = `
                    <input type="radio" name="voiceCategory" value="${category.id}" class="mr-3">
                    <span class="font-medium">${category.name}</span>
                `;
                optionsContainer.appendChild(option);
            });
            
            modal.classList.remove('hidden');
        }

        function closeVoiceCategoryModal() {
            document.getElementById('voiceCategoryModal').classList.add('hidden');
            voiceCurrentCategorySlot = null;
        }

        function confirmVoiceCategorySelection() {
            const selectedRadio = document.querySelector('input[name="voiceCategory"]:checked');
            if (!selectedRadio) return;
            
            const categoryId = selectedRadio.value;
            const categoryName = voiceMockData.categories.find(c => c.id === categoryId).name;
            
            // 更新選中的分類
            voiceSelectedCategories[voiceCurrentCategorySlot] = { id: categoryId, name: categoryName };
            
            // 更新UI
            updateVoiceCategoryDisplay(voiceCurrentCategorySlot, categoryName, categoryId);
            
            closeVoiceCategoryModal();
        }

        function updateVoiceCategoryDisplay(slot, categoryName, categoryId) {
            const contentDiv = document.getElementById(`voiceCategory${slot}Content`);
            const stats = voiceMockData.labelStats[categoryId];
            const total = Object.values(stats).reduce((sum, val) => sum + val, 0);
            const hitCount = Object.keys(stats).length;
            
            contentDiv.innerHTML = `
                <p class="text-2xl font-bold text-gray-900">${total}</p>
                <p class="text-xs text-gray-500 mt-1">${categoryName} (${hitCount}個標籤)</p>
            `;
            
            // 添加 hover 效果顯示詳細資訊
            const cardElement = contentDiv.closest('.stat-card');
            cardElement.setAttribute('title', Object.entries(stats).map(([label, count]) => `${label}: ${count}`).join('\n'));
        }

        // === 圖表初始化 ===
        function initVoiceLabelCharts() {
            const container = document.getElementById('voiceLabelChartsContainer');
            container.innerHTML = '';
            
            voiceMockData.categories.forEach(category => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'bg-white rounded-lg shadow p-6';
                chartDiv.innerHTML = `
                    <h3 class="text-md font-medium text-gray-800 mb-4">${category.name}</h3>
                    <div id="voiceChart-${category.id}" style="height: 300px;"></div>
                `;
                container.appendChild(chartDiv);
                
                // 創建圓餅圖
                setTimeout(() => {
                    const chart = echarts.init(document.getElementById(`voiceChart-${category.id}`));
                    const data = Object.entries(voiceMockData.labelStats[category.id])
                        .filter(([label, value]) => value > 0)
                        .map(([label, value]) => ({ name: label, value }));
                    
                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'horizontal',
                            bottom: 10,
                            itemWidth: 12,
                            itemHeight: 12,
                            textStyle: { fontSize: 10 }
                        },
                        series: [{
                            name: category.name,
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['50%', '45%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 2,
                                borderColor: '#fff',
                                borderWidth: 1
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 16,
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: data
                        }]
                    };
                    
                    chart.setOption(option);
                    voiceLabelCharts[category.id] = chart;
                }, 100);
            });
        }

        function initVoiceIntentChart() {
            setTimeout(() => {
                const chart = echarts.init(document.getElementById('voiceIntentChart'));
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: voiceMockData.intents,
                        axisTick: {
                            alignWithLabel: true
                        },
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '命中次數'
                    },
                    series: [{
                        name: '命中次數',
                        type: 'bar',
                        barWidth: '60%',
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#3b82f6' },
                                { offset: 1, color: '#1d4ed8' }
                            ])
                        },
                        data: voiceMockData.intentStats
                    }]
                };
                
                chart.setOption(option);
                voiceIntentChart = chart;
            }, 200);
        }

        function initVoiceHeatmapChart() {
            setTimeout(() => {
                const chart = echarts.init(document.getElementById('voiceHeatmapChart'));
                
                const option = {
                    tooltip: {
                        position: 'top',
                        formatter: function(params) {
                            const labelName = voiceMockData.heatmapData.labels[params.data[1]];
                            const intentName = voiceMockData.heatmapData.intents[params.data[0]];
                            return `${labelName} × ${intentName}<br/>交集數量: ${params.data[2]}`;
                        }
                    },
                    grid: {
                        height: '50%',
                        top: '10%'
                    },
                    xAxis: {
                        type: 'category',
                        data: voiceMockData.heatmapData.labels,
                        splitArea: {
                            show: true
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: voiceMockData.heatmapData.intents,
                        splitArea: {
                            show: true
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: 30,
                        calculable: true,
                        orient: 'horizontal',
                        left: 'center',
                        bottom: '15%',
                        inRange: {
                            color: ['#f3f4f6', '#dbeafe', '#93c5fd', '#3b82f6', '#1e40af']
                        }
                    },
                    series: [{
                        name: '交集數量',
                        type: 'heatmap',
                        data: voiceMockData.heatmapData.data,
                        label: {
                            show: true
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                
                chart.setOption(option);
                voiceHeatmapChart = chart;
            }, 300);
        }

        // === Heatmap 功能 ===
        function updateVoiceHeatmapMode() {
            const mode = document.getElementById('voiceHeatmapMode').value;
            console.log('切換語音標籤 Heatmap 顯示模式:', mode);
            // 這裡可以實作切換顯示模式的邏輯
        }

        function exportVoiceHeatmapData() {
            console.log('導出語音標籤 Heatmap 數據');
            alert('導出功能開發中...');
        }

        // === 重新載入語音圖表 ===
        function loadVoiceCharts() {
            // 重新載入所有語音標籤圖表數據
            Object.values(voiceLabelCharts).forEach(chart => {
                if (chart) chart.resize();
            });
            
            if (voiceIntentChart) voiceIntentChart.resize();
            if (voiceHeatmapChart) voiceHeatmapChart.resize();
        }

        // === 資料夾篩選功能 ===
        function toggleFolderSelection(element) {
            const checkbox = element.querySelector('.folder-checkbox-input');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                element.classList.add('selected');
                element.style.borderColor = '#3b82f6';
                element.style.backgroundColor = '#eff6ff';
            } else {
                element.classList.remove('selected');
                element.style.borderColor = '#d1d5db';
                element.style.backgroundColor = 'white';
            }
            
            updateFolderInfo();
        }

        function selectAllFolders() {
            const folderItems = document.querySelectorAll('.folder-item');
            folderItems.forEach(item => {
                const checkbox = item.querySelector('.folder-checkbox-input');
                checkbox.checked = true;
                item.classList.add('selected');
                item.style.borderColor = '#3b82f6';
                item.style.backgroundColor = '#eff6ff';
            });
            updateFolderInfo();
        }

        function invertFolderSelection() {
            const folderItems = document.querySelectorAll('.folder-item');
            folderItems.forEach(item => {
                const checkbox = item.querySelector('.folder-checkbox-input');
                checkbox.checked = !checkbox.checked;
                
                if (checkbox.checked) {
                    item.classList.add('selected');
                    item.style.borderColor = '#3b82f6';
                    item.style.backgroundColor = '#eff6ff';
                } else {
                    item.classList.remove('selected');
                    item.style.borderColor = '#d1d5db';
                    item.style.backgroundColor = 'white';
                }
            });
            updateFolderInfo();
        }

        function clearFolderSelection() {
            const folderItems = document.querySelectorAll('.folder-item');
            folderItems.forEach(item => {
                const checkbox = item.querySelector('.folder-checkbox-input');
                checkbox.checked = false;
                item.classList.remove('selected');
                item.style.borderColor = '#d1d5db';
                item.style.backgroundColor = 'white';
            });
            updateFolderInfo();
        }

        function filterFoldersByScoring() {
            const filterValue = document.getElementById('scoringMethodFilter').value;
            const folderItems = document.querySelectorAll('.folder-item');
            
            folderItems.forEach(item => {
                const scoringMethod = item.dataset.scoring;
                if (filterValue === 'all' || scoringMethod === filterValue) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            updateFolderInfo();
        }

        function setDisplayMode(mode) {
            const modeOptions = document.querySelectorAll('.mode-option');
            modeOptions.forEach(option => {
                option.classList.remove('active');
                option.style.borderColor = '#d1d5db';
                option.style.backgroundColor = 'white';
                option.style.color = 'inherit';
            });
            
            const selectedOption = document.querySelector(`input[value="${mode}"]`).closest('.mode-option');
            selectedOption.classList.add('active');
            selectedOption.style.borderColor = '#3b82f6';
            selectedOption.style.backgroundColor = '#3b82f6';
            selectedOption.style.color = 'white';
            
            updateFolderInfo();
        }

        function updateFolderInfo() {
            const selectedFolders = document.querySelectorAll('.folder-checkbox-input:checked');
            const visibleSelectedFolders = Array.from(selectedFolders).filter(checkbox => 
                checkbox.closest('.folder-item').style.display !== 'none'
            );
            
            let totalFiles = 0;
            const scoringMethods = new Set();
            
            visibleSelectedFolders.forEach(checkbox => {
                const folderItem = checkbox.closest('.folder-item');
                const metaText = folderItem.querySelector('.folder-meta span').textContent;
                const count = parseInt(metaText.match(/(\d+,?\d*)/)?.[1]?.replace(',', '') || 0);
                totalFiles += count;
                
                const scoringMethod = folderItem.querySelector('.scoring-method').textContent;
                scoringMethods.add(scoringMethod);
            });
            
            // 更新選擇資訊
            document.getElementById('selectedFolderInfo').textContent = 
                `已選擇 ${visibleSelectedFolders.length} 個資料夾，共 ${totalFiles.toLocaleString()} 筆音檔`;
            
            // 更新提示信息
            const displayMode = document.querySelector('input[name="display-mode"]:checked').value;
            const infoAlert = document.getElementById('folderInfoAlert');
            const infoText = document.getElementById('folderInfoText');
            
            if (visibleSelectedFolders.length === 0) {
                infoAlert.style.display = 'none';
            } else {
                infoAlert.style.display = 'flex';
                
                if (displayMode === 'integrated') {
                    if (scoringMethods.size > 1) {
                        infoAlert.className = 'info-alert mt-4 p-3 bg-orange-50 border border-orange-200 rounded text-sm text-orange-800 flex items-center gap-2';
                        infoAlert.querySelector('span').textContent = '⚠️';
                        infoText.textContent = `整合顯示包含 ${visibleSelectedFolders.length} 個資料夾，使用不同算分方式，結果僅供參考`;
                    } else {
                        infoAlert.className = 'info-alert mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 flex items-center gap-2';
                        infoAlert.querySelector('span').textContent = 'ℹ️';
                        infoText.textContent = `整合顯示包含 ${visibleSelectedFolders.length} 個資料夾的數據`;
                    }
                } else {
                    infoAlert.className = 'info-alert mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800 flex items-center gap-2';
                    infoAlert.querySelector('span').textContent = 'ℹ️';
                    infoText.textContent = `分別顯示 ${visibleSelectedFolders.length} 個資料夾的獨立報表`;
                }
            }
        }

        function resetFolderFilters() {
            // 重置篩選下拉選單
            document.getElementById('scoringMethodFilter').value = 'all';
            
            // 顯示所有資料夾
            const folderItems = document.querySelectorAll('.folder-item');
            folderItems.forEach(item => {
                item.style.display = 'block';
            });
            
            // 重置顯示模式為整合顯示
            document.querySelector('input[value="integrated"]').checked = true;
            setDisplayMode('integrated');
            
            // 重置選擇狀態為預設（前三個選中）
            clearFolderSelection();
            const defaultSelected = [0, 1, 3]; // 意外險、汽機車強制險、醫療險
            folderItems.forEach((item, index) => {
                if (defaultSelected.includes(index)) {
                    const checkbox = item.querySelector('.folder-checkbox-input');
                    checkbox.checked = true;
                    item.classList.add('selected');
                    item.style.borderColor = '#3b82f6';
                    item.style.backgroundColor = '#eff6ff';
                }
            });
            
            updateFolderInfo();
        }

        function applyFolderFilters() {
            const selectedFolders = document.querySelectorAll('.folder-checkbox-input:checked');
            const visibleSelectedFolders = Array.from(selectedFolders).filter(checkbox => 
                checkbox.closest('.folder-item').style.display !== 'none'
            );
            
            if (visibleSelectedFolders.length === 0) {
                alert('請至少選擇一個資料夾');
                return;
            }
            
            const displayMode = document.querySelector('input[name="display-mode"]:checked').value;
            
            // 收集選中的資料夾資訊
            const selectedFoldersInfo = visibleSelectedFolders.map(checkbox => {
                const folderItem = checkbox.closest('.folder-item');
                return {
                    name: folderItem.querySelector('.folder-name').textContent,
                    count: parseInt(folderItem.querySelector('.folder-meta span').textContent.match(/(\d+,?\d*)/)?.[1]?.replace(',', '') || 0),
                    scoring: folderItem.querySelector('.scoring-method').textContent
                };
            });
            
            console.log('應用資料夾篩選:', {
                folders: selectedFoldersInfo,
                displayMode: displayMode
            });
            
            // 這裡可以觸發重新載入圖表數據的邏輯
            alert(`已應用篩選設定：\n- 選擇 ${selectedFoldersInfo.length} 個資料夾\n- 顯示模式：${displayMode === 'integrated' ? '整合顯示' : '分別顯示'}\n\n將重新載入圖表數據...`);
            
            // 觸發數據更新
            setTimeout(() => {
                updateDashboardWithFolderFilter(selectedFoldersInfo, displayMode);
            }, 500);
        }

        function updateDashboardWithFolderFilter(folders, displayMode) {
            // 這個函數用來根據選擇的資料夾更新儀表板數據
            console.log('更新儀表板數據:', folders, displayMode);
            
            // 重新載入所有圖表
            if (typeof initOverviewCharts === 'function') {
                initOverviewCharts();
            }
            
            // 顯示更新成功訊息
            showNotification(`✅ 已根據 ${folders.length} 個資料夾更新數據（${displayMode === 'integrated' ? '整合' : '分別'}顯示）`);
        }

        function showNotification(message) {
            // 創建通知元素
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50 transition-all duration-300';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3秒後自動消失
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            waitForECharts(initDashboard);
            
            // 初始化資料夾篩選狀態
            setTimeout(() => {
                updateFolderInfo();
            }, 100);
        });
    </script>
</body>
</html>